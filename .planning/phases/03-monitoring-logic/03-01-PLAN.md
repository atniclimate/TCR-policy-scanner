---
phase: 03-monitoring-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/monitors/__init__.py
  - src/monitors/iija_sunset.py
  - src/monitors/reconciliation.py
  - src/monitors/dhs_funding.py
  - config/scanner_config.json
  - src/graph/schema.py
autonomous: true

must_haves:
  truths:
    - "IIJA-funded programs approaching FY26 expiration are flagged with sunset warnings and days remaining"
    - "Reconciliation monitor detects active bills threatening IRA Section 6417, distinguishing from the already-enacted OBBBA"
    - "DHS funding cliff monitor surfaces FEMA-related programs when DHS CR approaches expiration"
    - "Monitors produce consistent MonitorAlert objects with severity, program_ids, and metadata"
    - "THREATENS edges are added to the graph by threat monitors for decision engine consumption"
  artifacts:
    - path: "src/monitors/__init__.py"
      provides: "MonitorAlert dataclass, BaseMonitor ABC, MonitorRunner orchestrator"
      exports: ["MonitorAlert", "BaseMonitor", "MonitorRunner"]
    - path: "src/monitors/iija_sunset.py"
      provides: "IIJA sunset tracker (MON-01)"
      contains: "class IIJASunsetMonitor"
    - path: "src/monitors/reconciliation.py"
      provides: "Reconciliation bill monitor (MON-02)"
      contains: "class ReconciliationMonitor"
    - path: "src/monitors/dhs_funding.py"
      provides: "DHS funding cliff tracker (MON-05)"
      contains: "class DHSFundingCliffMonitor"
    - path: "config/scanner_config.json"
      provides: "Monitor configuration thresholds"
      contains: "monitors"
    - path: "src/graph/schema.py"
      provides: "THREATENS edge type documentation"
      contains: "THREATENS"
  key_links:
    - from: "src/monitors/iija_sunset.py"
      to: "src/monitors/__init__.py"
      via: "inherits BaseMonitor, returns MonitorAlert list"
      pattern: "class IIJASunsetMonitor.*BaseMonitor"
    - from: "src/monitors/iija_sunset.py"
      to: "graph_data edges"
      via: "adds THREATENS edges to graph_data dict"
      pattern: "THREATENS"
    - from: "config/scanner_config.json"
      to: "src/monitors/*.py"
      via: "config dict passed to monitor constructors"
      pattern: "monitors.*iija_sunset|reconciliation|dhs_funding"
---

<objective>
Create the monitor framework (BaseMonitor, MonitorAlert, MonitorRunner) and implement three threat-detection monitors: IIJA sunset tracker, reconciliation bill monitor, and DHS funding cliff tracker. These monitors analyze the knowledge graph and scored items to detect time-sensitive legislative threats, producing alerts and THREATENS edges.

Purpose: Provides the reusable monitor infrastructure and the three monitors that create THREATENS edges -- which the decision engine (Plan 03-02) consumes for LOGIC-05 Urgent Stabilization classification.
Output: New `src/monitors/` package with base classes and 3 threat monitors, updated scanner config with monitor thresholds, THREATENS edge type documented in schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-monitoring-logic/03-RESEARCH.md

@src/graph/schema.py
@src/graph/builder.py
@src/scrapers/base.py
@src/analysis/change_detector.py
@config/scanner_config.json
@data/graph_schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monitor infrastructure and config</name>
  <files>
    src/monitors/__init__.py
    config/scanner_config.json
    src/graph/schema.py
  </files>
  <action>
    1. Create `src/monitors/__init__.py` with:
       - `MonitorAlert` dataclass (fields: monitor str, severity str ["CRITICAL"/"WARNING"/"INFO"], program_ids list[str], title str, detail str, metadata dict with default_factory, timestamp str auto-set to utcnow ISO format in __post_init__)
       - `BaseMonitor` abstract base class with `__init__(self, config: dict, programs: dict)` storing both, and abstract `check(self, graph_data: dict, scored_items: list[dict]) -> list[MonitorAlert]` method
       - `MonitorRunner` class with `__init__(self, config: dict, programs: dict)` that instantiates all monitors (import lazily or list them), and `run_all(self, graph_data: dict, scored_items: list[dict]) -> list[MonitorAlert]` that calls each monitor's check(), collects all alerts, and returns them sorted by severity (CRITICAL first, then WARNING, then INFO). MonitorRunner should also add THREATENS edges to graph_data by collecting them from monitor alerts that have `threat_type` in metadata.
       - Follow the same pattern as BaseScraper in `src/scrapers/base.py` (simple class hierarchy, logging, no external deps)

    2. Update `config/scanner_config.json`: Add a `"monitors"` section at the top level containing:
       ```json
       "monitors": {
         "iija_sunset": {
           "warning_days": 180,
           "critical_days": 90,
           "fy26_end": "2026-09-30"
         },
         "reconciliation": {
           "keywords": ["reconciliation", "repeal", "section 6417", "elective pay", "IRA repeal", "direct pay termination"],
           "active_bill_statuses": ["introduced", "committee", "floor", "conference"],
           "enacted_laws_exclude": ["Public Law 119-21"]
         },
         "tribal_consultation": {
           "keywords": ["dear tribal leader", "DTLL", "tribal consultation", "EO 13175", "Executive Order 13175", "consultation notice", "government-to-government", "nation-to-nation"],
           "agency_slugs": ["indian-affairs-bureau", "environmental-protection-agency", "interior-department", "energy-department"]
         },
         "hot_sheets": {
           "staleness_days": 90
         },
         "dhs_funding": {
           "cr_expiration": "2026-02-13",
           "fema_program_ids": ["fema_bric", "fema_tribal_mitigation"],
           "warning_days": 14
         },
         "decision_engine": {
           "urgency_threshold_days": 30
         }
       }
       ```
       Preserve ALL existing config fields. Add monitors as a new top-level key.

    3. Update `src/graph/schema.py`: Add THREATENS to the Edge class docstring:
       ```
       THREATENS        (ThreatNode -> Program) -- time-sensitive legislative threat
       ```
       No new dataclass needed -- THREATENS edges use the existing Edge dataclass with metadata carrying threat_type, deadline, days_remaining, description.
  </action>
  <verify>
    Run `python -c "from src.monitors import MonitorAlert, BaseMonitor, MonitorRunner; print('imports OK')"` to confirm the package loads.
    Run `python -c "import json; c=json.load(open('config/scanner_config.json')); assert 'monitors' in c; assert 'iija_sunset' in c['monitors']; print('config OK')"` to confirm config.
    Run `python -c "from src.graph.schema import Edge; print(Edge.__doc__)"` to confirm THREATENS appears in docstring.
  </verify>
  <done>
    MonitorAlert, BaseMonitor, and MonitorRunner are importable from src.monitors. scanner_config.json contains the monitors section with all 6 sub-keys. Edge docstring lists THREATENS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement three threat monitors</name>
  <files>
    src/monitors/iija_sunset.py
    src/monitors/reconciliation.py
    src/monitors/dhs_funding.py
  </files>
  <action>
    1. Create `src/monitors/iija_sunset.py` -- IIJASunsetMonitor (MON-01):
       - Inherits BaseMonitor
       - Reads config `monitors.iija_sunset` for warning_days (default 180), critical_days (default 90), fy26_end (default "2026-09-30")
       - IIJA FY26 programs: epa_stag (auth_iija), dot_protect (auth_protect_formula), usbr_watersmart (auth_iija_watersmart) -- these have "Expires FY26" durability
       - IIJA fund-exhaustion programs: usda_wildfire (auth_iija_wildfire) -- has "Expires when funds exhausted" durability, different alert type
       - check() calculates days_remaining from today to FY26 end (September 30, 2026)
       - For each IIJA FY26 program: scan scored_items from congress_gov source for reauthorization signals ("reauthorization", "reauthorize", "extension of" in title/abstract). If reauth bill found for that program, skip the sunset warning.
       - If no reauth found and days_remaining <= warning_days: create MonitorAlert with severity CRITICAL (<=critical_days) or WARNING (<=warning_days) or INFO (>warning_days)
       - CRITICAL: Also return THREATENS edge data in metadata: {"threat_type": "iija_sunset", "deadline": "2026-09-30", "days_remaining": N, "creates_threatens_edge": true, "authority_id": auth_id}
       - For fund-exhaustion programs: create separate INFO-level alert noting fund-exhaustion expiration type (no calendar deadline)
       - Use `from datetime import date` for date arithmetic (not dateutil -- simple subtraction is sufficient)

    2. Create `src/monitors/reconciliation.py` -- ReconciliationMonitor (MON-02):
       - Inherits BaseMonitor
       - Reads config `monitors.reconciliation` for keywords and active_bill_statuses and enacted_laws_exclude
       - check() scans scored_items for items from congress_gov source
       - For each congress_gov item: check if title/abstract matches any reconciliation keyword
       - CRITICAL PITFALL AVOIDANCE: Filter OUT items whose title or abstract contains any entry from enacted_laws_exclude (e.g., "Public Law 119-21"). The OBBBA is enacted law, not an active threat. Only flag bills in active legislative stages.
       - Check `latest_action` field on the item to determine bill status. If latest_action text contains words like "signed", "became public law", "enacted" -> skip (historical, not threat)
       - For active bills matching keywords: create MonitorAlert with severity WARNING, program_ids set to IRS Elective Pay related programs ["irs_elective_pay"], include metadata with bill details
       - Also create THREATENS edge metadata: {"threat_type": "reconciliation", "creates_threatens_edge": true, "bill_id": source_id, "description": title}
       - The monitor should NOT set a specific days_remaining (reconciliation timelines are unpredictable); instead set days_remaining to the urgency_threshold_days from config to ensure LOGIC-05 triggers

    3. Create `src/monitors/dhs_funding.py` -- DHSFundingCliffMonitor (MON-05):
       - Inherits BaseMonitor
       - Reads config `monitors.dhs_funding` for cr_expiration (date string), fema_program_ids (list), warning_days (default 14)
       - check() parses cr_expiration to a date, calculates days_remaining from today
       - If days_remaining <= 0: alert that DHS CR has expired (CRITICAL)
       - If days_remaining <= warning_days: alert WARNING for each FEMA program in fema_program_ids
       - Also scan scored_items from congress_gov for new DHS appropriations/CR bills (keywords: "DHS appropriations", "homeland security funding", "continuing resolution" with "homeland" or "DHS")
       - If new DHS funding bill detected, note it in alert metadata but still warn (bill passage is not guaranteed)
       - Create THREATENS edge metadata for FEMA programs: {"threat_type": "dhs_funding_cliff", "deadline": cr_expiration, "days_remaining": N, "creates_threatens_edge": true}

    4. Update MonitorRunner in `src/monitors/__init__.py` to import and instantiate all three monitors. The runner should:
       - Import IIJASunsetMonitor, ReconciliationMonitor, DHSFundingCliffMonitor
       - In run_all(), after collecting all alerts, scan alerts for metadata with `creates_threatens_edge: true` and add THREATENS edges to graph_data["edges"] with source_id as a threat node ID (e.g., "threat_iija_sunset_{program_id}") and target_id as the program_id
  </action>
  <verify>
    Run `python -c "from src.monitors.iija_sunset import IIJASunsetMonitor; print('IIJA OK')"` -- imports successfully.
    Run `python -c "from src.monitors.reconciliation import ReconciliationMonitor; print('Recon OK')"` -- imports successfully.
    Run `python -c "from src.monitors.dhs_funding import DHSFundingCliffMonitor; print('DHS OK')"` -- imports successfully.
    Run `python -c "
import json
from src.monitors import MonitorRunner
config = json.load(open('config/scanner_config.json'))
programs_data = json.load(open('data/program_inventory.json'))
programs = {p['id']: p for p in programs_data['programs']}
runner = MonitorRunner(config, programs)
graph_data = {'nodes': {}, 'edges': []}
alerts = runner.run_all(graph_data, [])
print(f'Alerts from empty scan: {len(alerts)}')
for a in alerts:
    print(f'  [{a.severity}] {a.title}')
print(f'THREATENS edges added: {len([e for e in graph_data[\"edges\"] if e.get(\"type\") == \"THREATENS\"])}')
"` -- produces IIJA sunset warnings (since today is within 180 days of Sep 30 2026) and DHS CR alerts (since Feb 13 is imminent). No reconciliation alerts from empty scan.
  </verify>
  <done>
    Three threat monitors instantiate and run correctly. IIJA sunset monitor flags approaching FY26 programs. Reconciliation monitor skips enacted OBBBA. DHS funding cliff monitor detects CR expiration proximity. THREATENS edges appear in graph_data after MonitorRunner.run_all().
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.monitors import MonitorAlert, BaseMonitor, MonitorRunner"` -- package imports cleanly
2. `python -c "from src.monitors.iija_sunset import IIJASunsetMonitor"` -- IIJA monitor imports
3. `python -c "from src.monitors.reconciliation import ReconciliationMonitor"` -- reconciliation monitor imports
4. `python -c "from src.monitors.dhs_funding import DHSFundingCliffMonitor"` -- DHS monitor imports
5. MonitorRunner.run_all() with empty scored_items produces IIJA sunset alerts for epa_stag, dot_protect, usbr_watersmart (they are within 180-day window)
6. MonitorRunner.run_all() adds THREATENS edges to graph_data for programs with active threats
7. scanner_config.json parses as valid JSON and contains monitors section
8. No existing tests broken: `python -m pytest tests/ -v` (if tests exist)
</verification>

<success_criteria>
- src/monitors/ package exists with __init__.py, iija_sunset.py, reconciliation.py, dhs_funding.py
- MonitorAlert, BaseMonitor, MonitorRunner importable from src.monitors
- Three monitors implement check() returning list[MonitorAlert]
- IIJA sunset monitor flags FY26 programs with days_remaining and severity tiers
- Reconciliation monitor filters out enacted OBBBA, only flags active bills
- DHS funding cliff monitor uses configurable CR expiration date
- Monitors add THREATENS edges to graph_data via MonitorRunner
- scanner_config.json contains complete monitors configuration section
- THREATENS documented in Edge class docstring
</success_criteria>

<output>
After completion, create `.planning/phases/03-monitoring-logic/03-01-SUMMARY.md`
</output>
