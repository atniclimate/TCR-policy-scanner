---
phase: 12-award-population
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - data/housing_authority_aliases.json
  - scripts/build_tribal_aliases.py
  - data/tribal_aliases.json
  - tests/test_housing_authority_aliases.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "450+ Tribes have at least one non-zero award record"
    - "Housing authority recipient names resolve to their parent Tribe via alias table"
    - "Re-running populate_awards.py with enhanced aliases increases coverage from 418 to 450+"
  artifacts:
    - path: "data/housing_authority_aliases.json"
      provides: "Curated housing authority name to tribe_id mapping"
      contains: "navajo housing authority"
    - path: "data/tribal_aliases.json"
      provides: "Combined alias table including housing authority names"
      min_entries: 3800
    - path: "tests/test_housing_authority_aliases.py"
      provides: "Tests for housing authority alias loading and matching"
      min_lines: 40
  key_links:
    - from: "data/housing_authority_aliases.json"
      to: "data/tribal_aliases.json"
      via: "scripts/build_tribal_aliases.py merges HA aliases into main table"
      pattern: "housing_authority_aliases"
    - from: "data/tribal_aliases.json"
      to: "src/packets/awards.py"
      via: "TribalAwardMatcher.__init__ loads alias table"
      pattern: "alias_table"
---

<objective>
Close the Phase 12 coverage gap: 418/592 Tribes have awards, but the target is 450+. The root cause is that HUD IHBG awards (CFDA 14.867) go to Tribal Housing Authorities whose names (e.g., "NAVAJO HOUSING AUTHORITY") do not appear in the alias table. 15 of the top 20 unmatched recipients by obligation are housing authorities, representing $3.9B in unmatched awards.

Purpose: Reach the AWRD-04 requirement (450+ Tribes with at least one non-zero award record) by adding housing authority name aliases that map these entity names to their parent Tribe IDs.

Output: Enhanced alias table with housing authority mappings, re-populated award cache files, coverage report showing 450+ Tribes matched.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-award-population/12-03-SUMMARY.md
@src/packets/awards.py
@scripts/build_tribal_aliases.py
@scripts/populate_awards.py
@data/tribal_registry.json
@outputs/award_population_report.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create housing authority alias mapping and merge into alias table</name>
  <files>
    data/housing_authority_aliases.json
    scripts/build_tribal_aliases.py
    data/tribal_aliases.json
    tests/test_housing_authority_aliases.py
  </files>
  <action>
**Step 1: Create `data/housing_authority_aliases.json`**

Create a curated JSON file mapping housing authority recipient names (lowercased) to their parent Tribe's tribe_id. The file structure mirrors the existing alias table format:

```json
{
  "_metadata": {
    "description": "Housing authority recipient names mapped to parent Tribe IDs for USASpending award matching",
    "version": "1.0",
    "last_updated": "YYYY-MM-DD",
    "source": "Manual curation from outputs/award_population_report.json top_unmatched list + HUD IHBG recipient data"
  },
  "aliases": {
    "navajo housing authority": "epa_100000171",
    ...
  }
}
```

Build the mapping by cross-referencing the top 20 unmatched recipients from `outputs/award_population_report.json` against `data/tribal_registry.json`. For each housing-authority-like entity in the unmatched list:

1. Parse the Tribe name from the housing authority name (e.g., "NAVAJO HOUSING AUTHORITY" -> "Navajo" -> find "Navajo Nation" in registry)
2. Find the matching tribe_id in `data/tribal_registry.json`
3. Add the lowercased housing authority name as a key, tribe_id as value

**Known mappings from the unmatched list** (verify tribe_ids against registry):
- "navajo housing authority" -> Navajo Nation (epa_100000171)
- "cook inlet housing authority" -> Look for Cook Inlet Region in registry. NOTE: "Cook Inlet Housing Authority" serves the Cook Inlet Region Inc. If no single Tribe match, check for "Cook Inlet Region, Inc." or similar. If not in registry, skip.
- "housing authority of choctaw nations" -> Choctaw Nation of Oklahoma (look up tribe_id)
- "oglala lakota housing authority" -> Oglala Sioux Tribe (look up tribe_id)
- "tohono o'odham ki ki association" -> Tohono O'odham Nation (look up tribe_id)
- "interior regional housing authority" -> This is a REGIONAL authority serving multiple Alaska Tribes. Skip if it serves multiple Tribes (cannot attribute to one).
- "white mountain apache housing authority" -> White Mountain Apache Tribe (look up tribe_id)
- "hopi tribal housing authority" -> Hopi Tribe (look up tribe_id)
- "turtle mountain housing authority" -> Turtle Mountain Band of Chippewa Indians (look up tribe_id)
- "tlingit haida regional housing authority" -> Central Council of Tlingit & Haida (look up tribe_id). NOTE: This is a regional authority; check if attributable to one Tribe.
- "sicangu wicoti awayankape corporation" -> Rosebud Sioux Tribe (Sicangu = Rosebud band)
- "blackfeet housing program" -> Blackfeet Tribe (look up tribe_id)
- "san carlos housing authority" -> San Carlos Apache Tribe (look up tribe_id)
- "yakama nation housing authority" -> Yakama Nation (look up tribe_id)
- "bering straits regional housing authority" -> REGIONAL authority; skip if multi-Tribe
- "cheyenne river housing authority" -> Cheyenne River Sioux Tribe (look up tribe_id)
- "umatilla indian reservation" -> Confederated Tribes of the Umatilla Indian Reservation (look up tribe_id)
- "standing rock housing local development" -> Standing Rock Sioux Tribe (look up tribe_id)
- "lumbee land development, inc" -> Lumbee Tribe (look up tribe_id)
- "navajo nation tribal government" -> Navajo Nation (epa_100000171) -- this is a government entity name variant, not a housing authority

**Critical:** For REGIONAL housing authorities that serve multiple Tribes (Interior Regional Housing Authority, Bering Straits Regional Housing Authority), SKIP them -- they cannot be reliably attributed to a single Tribe. Log which ones were skipped in the metadata.

**Also search for additional housing authority patterns** beyond the top 20 by running the populate_awards script in dry-run mode or checking the full unmatched list. Common patterns:
- "{Tribe} Housing Authority"
- "{Tribe} Housing Program"
- "Housing Authority of {Tribe}"
- "{Tribe} Housing Local Development"
- "{Tribe} Tribal Housing Authority"

Use `data/tribal_registry.json` to programmatically generate additional housing authority aliases for ALL 592 Tribes, not just the top 20 unmatched. For each Tribe:
- Generate "{short_tribe_name} housing authority" -> tribe_id
- Generate "housing authority of {short_tribe_name}" -> tribe_id

Where short_tribe_name is derived by stripping state suffixes and "of the {Reservation}" suffixes, similar to how build_tribal_aliases.py already strips states.

**Step 2: Extend `scripts/build_tribal_aliases.py`**

Add a function `_merge_housing_authority_aliases(aliases)` that:
1. Reads `data/housing_authority_aliases.json`
2. Adds each entry to the aliases dict (using add_alias so first-registration wins)
3. Logs how many housing authority aliases were added

Call this function at the end of `build_aliases()` before returning.

Also add a constant at module level:
```python
HOUSING_AUTHORITY_ALIASES_PATH = DATA_DIR / "housing_authority_aliases.json"
```

Wait -- `build_tribal_aliases.py` imports from `src.paths`. Add `HOUSING_AUTHORITY_ALIASES_PATH` to `src/paths.py` instead:
```python
HOUSING_AUTHORITY_ALIASES_PATH: Path = DATA_DIR / "housing_authority_aliases.json"
```

Then import it in `build_tribal_aliases.py`.

Actually, do NOT modify src/paths.py since it is not in this plan's files_modified list and could conflict with other work. Instead, construct the path locally in build_tribal_aliases.py:
```python
HOUSING_AUTHORITY_ALIASES_PATH = REGISTRY_PATH.parent / "housing_authority_aliases.json"
```

**Step 3: Rebuild the alias table**

Run `python scripts/build_tribal_aliases.py` to regenerate `data/tribal_aliases.json` with housing authority aliases merged in.

Verify the new alias count is higher than 3,751 (the pre-merge count).

**Step 4: Write tests**

Create `tests/test_housing_authority_aliases.py` with tests:

1. `test_housing_authority_aliases_file_valid_json` -- File exists, is valid JSON, has aliases dict
2. `test_housing_authority_aliases_have_valid_tribe_ids` -- Every tribe_id in the HA aliases exists in tribal_registry.json
3. `test_known_housing_authorities_mapped` -- Verify at least 10 specific known mappings (Navajo HA, Hopi Tribal HA, etc.)
4. `test_regional_authorities_excluded` -- Verify "interior regional housing authority" and "bering straits regional housing authority" are NOT in the aliases (regional = multi-Tribe)
5. `test_alias_table_includes_housing_authorities` -- After rebuild, the main tribal_aliases.json contains housing authority entries
6. `test_matcher_resolves_housing_authority` -- Create a TribalAwardMatcher with temp files including HA aliases, verify match_recipient_to_tribe("NAVAJO HOUSING AUTHORITY") returns Navajo Nation

Use the existing test patterns from tests/test_awards.py (the _make_matcher helper, etc.).
  </action>
  <verify>
    Run `python -m pytest tests/test_housing_authority_aliases.py -v` -- all tests pass.
    Run `python -m pytest tests/ -v` -- all existing tests still pass (zero regressions).
    Verify `data/housing_authority_aliases.json` exists and contains at least 15 curated mappings.
    Verify `data/tribal_aliases.json` has more than 3,751 aliases after rebuild.
  </verify>
  <done>
    Housing authority alias file exists with 15+ curated mappings.
    build_tribal_aliases.py merges HA aliases into the main alias table on rebuild.
    Main alias table has been rebuilt with increased alias count.
    6+ new tests all pass. Zero regressions on existing 500+ tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Re-run award population and validate 450+ coverage</name>
  <files>
    outputs/award_population_report.json
  </files>
  <action>
**Step 1: Re-run the award population pipeline**

Run the full population script against the live USASpending API:
```bash
python scripts/populate_awards.py
```

This will:
1. Fetch all awards (14 CFDAs x 5 FYs = 70 queries)
2. Deduplicate by Award ID
3. Match using the enhanced alias table (now including housing authority names)
4. Overwrite all 592 cache files
5. Generate updated coverage report

**Step 2: Validate coverage**

After the script completes, check `outputs/award_population_report.json`:
- `coverage.tribes_with_awards` must be >= 450
- `coverage.target_met` must be `true`

If coverage is still below 450:
- Check the new `top_unmatched` list for remaining patterns
- Add additional aliases to `data/housing_authority_aliases.json` for any remaining identifiable entities
- Re-run `scripts/build_tribal_aliases.py` and then `scripts/populate_awards.py`
- Iterate until 450+ is reached or until remaining unmatched are genuinely non-Tribal entities

**Step 3: Run full test suite**

```bash
python -m pytest tests/ -v
```

All tests must pass. The re-populated cache files should not break any existing tests since tests use tmp_path fixtures with local test data.

**IMPORTANT:** Do NOT hardcode fiscal years. The script uses FISCAL_YEAR_INT from config. Do NOT commit data files to git (per DEC-1203-03).
  </action>
  <verify>
    `outputs/award_population_report.json` shows `coverage.tribes_with_awards >= 450` and `coverage.target_met = true`.
    `python -m pytest tests/ -v` passes with zero failures.
    592 cache files exist in `data/award_cache/`.
  </verify>
  <done>
    Award population report shows 450+ Tribes with awards (target met).
    592 cache files overwritten with enhanced matching results.
    Full test suite passes.
    AWRD-04 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `data/housing_authority_aliases.json` exists with 15+ curated housing authority -> tribe_id mappings
2. `data/tribal_aliases.json` has been rebuilt with increased alias count (> 3,751)
3. `outputs/award_population_report.json` shows `coverage.tribes_with_awards >= 450` and `target_met: true`
4. `python -m pytest tests/ -v` -- all tests pass (including new HA alias tests)
5. No hardcoded fiscal years in any modified files
6. All file I/O uses `encoding="utf-8"`
</verification>

<success_criteria>
- AWRD-04 satisfied: 450+ Tribes have at least one non-zero award record
- Housing authority names (like "NAVAJO HOUSING AUTHORITY") resolve to parent Tribes via alias table
- Coverage report target_met = true
- All tests pass (existing + new)
- Regional multi-Tribe housing authorities correctly excluded (not falsely attributed)
</success_criteria>

<output>
After completion, create `.planning/phases/12-award-population/12-04-SUMMARY.md`
</output>
