---
phase: 04-report-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reports/generator.py
  - src/main.py
autonomous: true

must_haves:
  truths:
    - "LATEST-BRIEFING.md contains a Five Structural Asks section mapping each ask to barriers and connected programs"
    - "Each program row in the CI Dashboard shows a Hot Sheets sync indicator (ALIGNED, OVERRIDE, or DIVERGED)"
    - "IIJA-affected programs display a sunset countdown table with days remaining and severity"
    - "A Reconciliation Watch section always renders, showing threats or an all-clear message"
    - "Classified programs show their advocacy goal, rule reference, and confidence in a dedicated section"
    - "monitor_data and classifications are passed from main.py pipeline to ReportGenerator.generate()"
  artifacts:
    - path: "src/reports/generator.py"
      provides: "Extended report generator with 5 new format methods and updated generate() signature"
      contains: "_format_structural_asks"
    - path: "src/main.py"
      provides: "Pipeline wiring passing monitor_data and classifications to reporter"
      contains: "monitor_data=monitor_data"
  key_links:
    - from: "src/main.py"
      to: "src/reports/generator.py"
      via: "reporter.generate() call with monitor_data and classifications kwargs"
      pattern: "reporter\\.generate.*monitor_data"
    - from: "src/reports/generator.py"
      to: "outputs/LATEST-MONITOR-DATA.json structure"
      via: "_format_iija_countdown reads monitor_data alerts"
      pattern: "monitor.*iija_sunset"
    - from: "src/reports/generator.py"
      to: "graph_data dict"
      via: "_format_structural_asks queries AdvocacyLeverNode with ask_ prefix"
      pattern: "ask_"
---

<objective>
Add five new briefing sections to LATEST-BRIEFING.md and wire monitor/classification data through the pipeline.

Purpose: The report generator currently produces 7 sections but does not surface any of the Phase 3 monitoring or decision engine output. This plan extends the generator with 5 new format methods (RPT-01, RPT-02, RPT-03, RPT-05, RPT-06) and updates main.py to pass the required data.

Output: A LATEST-BRIEFING.md with 12 sections (6 existing + 5 new + the CI trend section from Plan 02), and a properly wired pipeline that passes monitor_data and classifications through to the report generator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-report-enhancements/04-RESEARCH.md

@src/reports/generator.py
@src/main.py
@outputs/LATEST-MONITOR-DATA.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend generate() signature and add 5 format methods to ReportGenerator</name>
  <files>src/reports/generator.py</files>
  <action>
Modify the existing ReportGenerator class in src/reports/generator.py:

1. **Extend generate() signature** (backward compatible):
   - Add `monitor_data: dict | None = None` and `classifications: dict | None = None` as keyword parameters to `generate()`.
   - Pass these through to `_build_markdown()` and `_build_json()`.
   - Add `monitor_data` and `classifications` params to `_build_markdown()` and `_build_json()` signatures.

2. **Add _format_structural_asks(self, graph_data: dict) -> list[str]** (RPT-01):
   - Query `graph_data["nodes"]` for nodes where `_type == "AdvocacyLeverNode"` AND `id.startswith("ask_")`. This filters structural asks from per-program levers (which use `lever_` prefix).
   - For each ask: find ADVANCES edges (ask -> program) and MITIGATED_BY edges (barrier -> ask) from `graph_data["edges"]`.
   - Render as H2 "Five Structural Asks" section with H3 per ask showing name, urgency badge, target, connected programs (resolved to names via self.programs), and mitigated barriers.
   - Return empty list if `graph_data` is None or no `ask_` nodes found.
   - Follow the code example in 04-RESEARCH.md Example 1.

3. **Modify existing CI Dashboard to add Hot Sheets column** (RPT-02):
   - In the existing CI Dashboard rendering (currently lines 101-128 of generator.py), add a "Hot Sheets" column.
   - For each program: read `prog.get("hot_sheets_status")`. Check for `prog.get("original_ci_status")` -- if present, the HotSheetsValidator overrode the status, show `OVERRIDE (original->current)`. If hot_sheets_status matches ci_status, show `ALIGNED`. Otherwise show `DIVERGED (hs_status)`. If no hot_sheets_status, show `--`.
   - Truncate Determination column from 80 to 70 chars to keep table width manageable.
   - Update table header: `| Program | CI | Status | Hot Sheets | Determination |`
   - Follow the code example in 04-RESEARCH.md Example 2.

4. **Add _format_iija_countdown(self, monitor_data: dict | None) -> list[str]** (RPT-03):
   - Always render the section header "## IIJA Sunset Countdown" (section should always appear per Pitfall 7).
   - If monitor_data is None: show "*No monitor data available.*"
   - Filter `monitor_data["alerts"]` for `alert["monitor"] == "iija_sunset"`.
   - Sort by `metadata.days_remaining` (None/null sorts last).
   - Render as a table: `| Program | Deadline | Days Remaining | Severity | Type |`
   - Resolve program_ids to names via self.programs.
   - If no IIJA alerts: show "No IIJA-funded programs currently tracked."
   - Follow the code example in 04-RESEARCH.md Example 3.

5. **Add _format_reconciliation_watch(self, monitor_data: dict | None) -> list[str]** (RPT-05):
   - Always render the section header "## Reconciliation Watch" (always present per Pitfall 7).
   - If monitor_data is None: show "*No monitor data available.*"
   - Filter alerts for `monitor == "reconciliation"`.
   - If no alerts: show "No active reconciliation threats detected in current scan."
   - If alerts: render severity badge, title, detail as blockquote, matched_keywords.
   - Follow the code example in 04-RESEARCH.md Example 4.

6. **Add _format_advocacy_goals(self, classifications: dict | None) -> list[str]** (RPT-06):
   - If classifications is None or empty: return empty list.
   - Separate classified (advocacy_goal is not None) from unclassified. This avoids Pitfall 6 (table dominated by "No match" rows).
   - Render classified programs as table: `| Program | Advocacy Goal | Rule | Confidence | Reason |` sorted by rule.
   - Truncate reason to 80 chars.
   - Below the table, show unclassified count and program names in italic.
   - Follow the code example in 04-RESEARCH.md Example 5.

7. **Update _build_markdown() section ordering**:
   Insert new sections in this order within _build_markdown() (per RESEARCH.md Pattern 3):
   - After Executive Summary: call `_format_reconciliation_watch(monitor_data)` then `_format_iija_countdown(monitor_data)` (urgent/time-sensitive sections above the fold)
   - After FLAGGED programs detail: call `_format_advocacy_goals(classifications)` then `_format_structural_asks(graph_data)` (analytical sections)
   - Existing Barriers, Authorities, Advocacy Levers sections remain unchanged in their current positions.
   - The "All Relevant Items" section remains last before footer.

8. **Update _build_json()** to include monitor_data and classifications in the JSON output:
   - Add `if monitor_data: result["monitor_data"] = monitor_data`
   - Add `if classifications: result["classifications"] = classifications`
  </action>
  <verify>
Run `python -c "from src.reports.generator import ReportGenerator; r = ReportGenerator([]); print('OK')"` to verify import succeeds.

Run `python -c "
import inspect
from src.reports.generator import ReportGenerator
sig = inspect.signature(ReportGenerator.generate)
params = list(sig.parameters.keys())
assert 'monitor_data' in params, f'Missing monitor_data param: {params}'
assert 'classifications' in params, f'Missing classifications param: {params}'
methods = [m for m in dir(ReportGenerator) if m.startswith('_format_')]
required = ['_format_structural_asks', '_format_iija_countdown', '_format_reconciliation_watch', '_format_advocacy_goals']
for r_method in required:
    assert r_method in methods, f'Missing method: {r_method}'
print('All methods and params verified')
"` to verify all new methods and parameters exist.
  </verify>
  <done>
ReportGenerator has: (a) extended generate() accepting monitor_data and classifications, (b) _format_structural_asks querying ask_ nodes, (c) CI Dashboard with Hot Sheets column, (d) _format_iija_countdown with always-render pattern, (e) _format_reconciliation_watch with always-render pattern, (f) _format_advocacy_goals with classified/unclassified split, (g) correct section ordering in _build_markdown, (h) _build_json includes monitor_data and classifications.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pipeline and validate end-to-end briefing output</name>
  <files>src/main.py</files>
  <action>
1. **Update run_pipeline() in src/main.py** (line 258-259 currently):
   Change from:
   ```python
   reporter = ReportGenerator(programs)
   paths = reporter.generate(scored, changes, graph_data)
   ```
   To:
   ```python
   reporter = ReportGenerator(programs)
   paths = reporter.generate(
       scored, changes, graph_data,
       monitor_data=monitor_data,
       classifications=classifications,
   )
   ```

   The `monitor_data` and `classifications` variables already exist in scope from the `run_monitors_and_classify()` call on line 243. This is pure wiring -- no new data loading needed.

2. **Run the pipeline with --report-only** to regenerate the briefing from cached data:
   ```
   python -m src.main --report-only
   ```
   This exercises the full reporting path including the new sections.

3. **Verify the generated LATEST-BRIEFING.md** contains:
   - "## Five Structural Asks" section with 5 asks
   - "Hot Sheets" column in CI Dashboard table
   - "## IIJA Sunset Countdown" section (may show countdown or "no programs tracked")
   - "## Reconciliation Watch" section (will likely show "No active reconciliation threats")
   - "## Advocacy Goal Classifications" section showing fema_bric and fema_tribal_mitigation as URGENT_STABILIZATION
   - All existing sections preserved (Executive Summary, CI Dashboard, Barriers, Authorities, Advocacy Levers, All Items)

4. **Verify LATEST-RESULTS.json** contains `monitor_data` and `classifications` keys.
  </action>
  <verify>
Run `python -m src.main --report-only` and confirm exit code 0.

Then verify briefing content:
```python
python -c "
content = open('outputs/LATEST-BRIEFING.md').read()
sections = ['Five Structural Asks', 'IIJA Sunset Countdown', 'Reconciliation Watch', 'Advocacy Goal Classifications', 'Hot Sheets']
missing = [s for s in sections if s not in content]
if missing:
    print(f'MISSING sections: {missing}')
else:
    print(f'All {len(sections)} new sections present in LATEST-BRIEFING.md')

import json
results = json.load(open('outputs/LATEST-RESULTS.json'))
assert 'monitor_data' in results, 'Missing monitor_data in JSON'
assert 'classifications' in results, 'Missing classifications in JSON'
print('JSON output contains monitor_data and classifications')
"
```
  </verify>
  <done>
Pipeline passes monitor_data and classifications to ReportGenerator. Running `--report-only` produces a LATEST-BRIEFING.md with all 5 new sections present and all existing sections preserved. LATEST-RESULTS.json includes monitor_data and classifications keys.
  </done>
</task>

</tasks>

<verification>
1. `python -m src.main --report-only` completes without errors
2. LATEST-BRIEFING.md contains all 5 new sections: Five Structural Asks, IIJA Sunset Countdown, Reconciliation Watch, Advocacy Goal Classifications, Hot Sheets indicator in CI Dashboard
3. All 7 existing sections are preserved (Executive Summary, New Developments, Critical Program Updates, All Relevant Items, CI Dashboard, Barriers, Authorities, Advocacy Levers)
4. LATEST-RESULTS.json includes monitor_data and classifications keys
5. ReportGenerator.generate() signature is backward compatible (monitor_data and classifications default to None)
6. RPT-02: Hot Sheets column shows ALIGNED/OVERRIDE/DIVERGED badges per program
7. RPT-06: Advocacy Goals table shows fema_bric and fema_tribal_mitigation as URGENT_STABILIZATION (LOGIC-05) from current monitor data
8. RPT-05: Reconciliation Watch shows "No active reconciliation threats" (no reconciliation alerts in current scan)
</verification>

<success_criteria>
- LATEST-BRIEFING.md has 12 distinct sections (6 existing + 5 new from this plan + CI trends from Plan 02)
- Pipeline wiring: monitor_data and classifications flow from run_monitors_and_classify() through to report generation
- Five Structural Asks shows all 5 asks with programs and mitigated barriers from graph
- Hot Sheets sync indicator appears as a column in the CI Dashboard for all 16 programs
- IIJA Countdown and Reconciliation Watch always render (even when no alerts)
- Advocacy Goals shows classified programs separately from unclassified
</success_criteria>

<output>
After completion, create `.planning/phases/04-report-enhancements/04-01-SUMMARY.md`
</output>
