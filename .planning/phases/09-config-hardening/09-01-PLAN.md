---
phase: 09-config-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/paths.py
  - src/config.py
  - src/main.py
  - src/graph/builder.py
  - src/reports/generator.py
  - src/analysis/change_detector.py
  - src/scrapers/base.py
  - src/monitors/hot_sheets.py
autonomous: true

must_haves:
  truths:
    - "A centralized src/paths.py module exists with PROJECT_ROOT and all directory/file path constants"
    - "src/config.py imports PROJECT_ROOT from src/paths.py instead of defining it locally"
    - "All non-packets source files (main.py, builder.py, generator.py, change_detector.py, base.py, hot_sheets.py) import paths from src.paths instead of constructing ad-hoc"
    - "All 383+ existing tests still pass"
  artifacts:
    - path: "src/paths.py"
      provides: "Centralized path constants and helper functions"
      contains: "PROJECT_ROOT"
      min_lines: 80
    - path: "src/config.py"
      provides: "Fiscal year config, imports PROJECT_ROOT from paths"
      contains: "from src.paths import PROJECT_ROOT"
  key_links:
    - from: "src/paths.py"
      to: "PROJECT_ROOT definition"
      via: "Path(__file__).resolve().parent.parent"
      pattern: "PROJECT_ROOT.*Path\\(__file__\\)"
    - from: "src/config.py"
      to: "src/paths.py"
      via: "import"
      pattern: "from src\\.paths import PROJECT_ROOT"
    - from: "src/main.py"
      to: "src/paths.py"
      via: "import"
      pattern: "from src\\.paths import"
---

<objective>
Create the centralized `src/paths.py` module with all path constants and helper functions, then migrate the core pipeline files (config, main, graph builder, reports, analysis, scrapers, monitors) to import from it. This establishes the foundation that Plan 09-02 builds on for packets and tests.

Purpose: Eliminate hardcoded path strings from the core pipeline so changing a data directory location in one place propagates to all consumers.
Output: `src/paths.py` module + 7 migrated core source files.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-config-hardening/09-RESEARCH.md
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/paths.py with all path constants and helper functions</name>
  <files>src/paths.py</files>
  <action>
Create `src/paths.py` as a flat constants module. This file imports NOTHING from the project (only `pathlib`). Structure:

1. Module docstring explaining the centralization purpose and no-import-time-validation policy.

2. **Project Root:**
   ```python
   PROJECT_ROOT: Path = Path(__file__).resolve().parent.parent
   ```

3. **Config Paths:**
   - `CONFIG_DIR = PROJECT_ROOT / "config"`
   - `SCANNER_CONFIG_PATH = CONFIG_DIR / "scanner_config.json"`

4. **Data Paths (flat files):**
   - `DATA_DIR = PROJECT_ROOT / "data"`
   - `PROGRAM_INVENTORY_PATH = DATA_DIR / "program_inventory.json"`
   - `POLICY_TRACKING_PATH = DATA_DIR / "policy_tracking.json"`
   - `GRAPH_SCHEMA_PATH = DATA_DIR / "graph_schema.json"`
   - `TRIBAL_REGISTRY_PATH = DATA_DIR / "tribal_registry.json"`
   - `TRIBAL_ALIASES_PATH = DATA_DIR / "tribal_aliases.json"`
   - `CONGRESSIONAL_CACHE_PATH = DATA_DIR / "congressional_cache.json"`
   - `ECOREGION_CONFIG_PATH = DATA_DIR / "ecoregion_config.json"`
   - `AIANNH_CROSSWALK_PATH = DATA_DIR / "aiannh_tribe_crosswalk.json"`

5. **Data Paths (subdirectories):**
   - `NRI_DIR = DATA_DIR / "nri"`
   - `USFS_DIR = DATA_DIR / "usfs"`
   - `AWARD_CACHE_DIR = DATA_DIR / "award_cache"`
   - `HAZARD_PROFILES_DIR = DATA_DIR / "hazard_profiles"`
   - `PACKET_STATE_DIR = DATA_DIR / "packet_state"`
   - `CENSUS_DATA_PATH = DATA_DIR / "census" / "tab20_cd11920_aiannh20_natl.txt"`

6. **Output Paths:**
   - `OUTPUTS_DIR = PROJECT_ROOT / "outputs"`
   - `LATEST_RESULTS_PATH = OUTPUTS_DIR / "LATEST-RESULTS.json"`
   - `LATEST_GRAPH_PATH = OUTPUTS_DIR / "LATEST-GRAPH.json"`
   - `LATEST_MONITOR_DATA_PATH = OUTPUTS_DIR / "LATEST-MONITOR-DATA.json"`
   - `CI_HISTORY_PATH = OUTPUTS_DIR / ".ci_history.json"`
   - `CFDA_TRACKER_PATH = OUTPUTS_DIR / ".cfda_tracker.json"`
   - `MONITOR_STATE_PATH = OUTPUTS_DIR / ".monitor_state.json"`
   - `ARCHIVE_DIR = OUTPUTS_DIR / "archive"`
   - `PACKETS_OUTPUT_DIR = OUTPUTS_DIR / "packets"`

7. **Docs Paths:**
   - `DOCS_DIR = PROJECT_ROOT / "docs"`
   - `WEB_DIR = DOCS_DIR / "web"`
   - `WEB_DATA_DIR = WEB_DIR / "data"`
   - `TRIBES_INDEX_PATH = WEB_DATA_DIR / "tribes.json"`

8. **Scripts Paths:**
   - `SCRIPTS_DIR = PROJECT_ROOT / "scripts"`

9. **Helper Functions:**
   ```python
   def award_cache_path(tribe_id: str) -> Path:
       """Return the award cache JSON path for a specific Tribe."""
       return AWARD_CACHE_DIR / f"{tribe_id}.json"

   def hazard_profile_path(tribe_id: str) -> Path:
       """Return the hazard profile JSON path for a specific Tribe."""
       return HAZARD_PROFILES_DIR / f"{tribe_id}.json"

   def packet_state_path(tribe_id: str) -> Path:
       """Return the packet state JSON path for a specific Tribe."""
       return PACKET_STATE_DIR / f"{tribe_id}.json"
   ```

Every constant gets a one-line docstring. Group sections with `# -- Section Name --` comments. Use type annotations (`Path`) on all constants.

IMPORTANT: This file has ZERO imports from `src.*` -- only `from pathlib import Path`. This prevents circular imports.
  </action>
  <verify>
Run: `python -c "from src.paths import PROJECT_ROOT, SCANNER_CONFIG_PATH, DATA_DIR, OUTPUTS_DIR, award_cache_path; print(PROJECT_ROOT); print(award_cache_path('test'))"` -- should print valid paths without error.
  </verify>
  <done>src/paths.py exists with all path constants and helper functions. Importing any constant works without circular import errors.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate core pipeline files to import from src/paths.py</name>
  <files>src/config.py, src/main.py, src/graph/builder.py, src/reports/generator.py, src/analysis/change_detector.py, src/scrapers/base.py, src/monitors/hot_sheets.py</files>
  <action>
Migrate these 7 files to import path constants from `src.paths` instead of defining them locally. For each file:

**src/config.py** (line 38):
- Remove `PROJECT_ROOT: Path = Path(__file__).resolve().parent.parent` definition
- Add `from src.paths import PROJECT_ROOT` at the top
- Keep re-exporting PROJECT_ROOT so downstream `from src.config import PROJECT_ROOT` still works during transition. Add: `__all__ = [..., "PROJECT_ROOT"]`
- Keep all fiscal year logic unchanged
- Remove `from pathlib import Path` import if no longer needed (check if Path is used elsewhere in the file -- it is NOT used elsewhere, so remove it)

**src/main.py** (lines 31, 35-38, 105):
- Replace `from src.config import PROJECT_ROOT` with imports from `src.paths`
- Import: `SCANNER_CONFIG_PATH, PROGRAM_INVENTORY_PATH, LATEST_GRAPH_PATH, LATEST_MONITOR_DATA_PATH, GRAPH_SCHEMA_PATH, PROJECT_ROOT` from `src.paths`
- Remove local `CONFIG_PATH`, `INVENTORY_PATH`, `GRAPH_OUTPUT_PATH`, `MONITOR_OUTPUT_PATH` definitions (lines 35-38)
- Replace `schema_path = PROJECT_ROOT / "data" / "graph_schema.json"` (line 105) with `GRAPH_SCHEMA_PATH`
- Update all usages of the old variable names to the new names throughout the file

**src/graph/builder.py** (lines 17, 26):
- Replace `from src.config import FISCAL_YEAR_SHORT, PROJECT_ROOT` with:
  `from src.config import FISCAL_YEAR_SHORT` and `from src.paths import GRAPH_SCHEMA_PATH`
- Remove local `GRAPH_SCHEMA_PATH = PROJECT_ROOT / "data" / "graph_schema.json"` (line 26)
- (The constant name is already `GRAPH_SCHEMA_PATH`, so no usage changes needed)

**src/reports/generator.py** (lines 16-18):
- Add `from src.paths import OUTPUTS_DIR, ARCHIVE_DIR, CI_HISTORY_PATH`
- Remove local definitions of `OUTPUTS_DIR`, `ARCHIVE_DIR`, `CI_HISTORY_PATH`
- Remove `from pathlib import Path` if no longer needed (check -- Path IS used in the class body for Path operations, so KEEP the pathlib import)

**src/analysis/change_detector.py** (line 13):
- Add `from src.paths import LATEST_RESULTS_PATH`
- Remove `CACHE_FILE = Path("outputs/LATEST-RESULTS.json")`
- Replace all references to `CACHE_FILE` with `LATEST_RESULTS_PATH` throughout the file

**src/scrapers/base.py** (line 107):
- Add `from src.paths import CFDA_TRACKER_PATH`
- Remove `CFDA_TRACKER_PATH = Path("outputs/.cfda_tracker.json")`
- (The constant name is already `CFDA_TRACKER_PATH`, so no usage changes needed)

**src/monitors/hot_sheets.py** (line 29):
- Add `from src.paths import MONITOR_STATE_PATH`
- Remove `MONITOR_STATE_PATH = Path("outputs/.monitor_state.json")`
- (The constant name is already `MONITOR_STATE_PATH`, so no usage changes needed)

CRITICAL: When replacing variable names (e.g., `CACHE_FILE` -> `LATEST_RESULTS_PATH`, `CONFIG_PATH` -> `SCANNER_CONFIG_PATH`), search the ENTIRE file for all usages and update them. Do not leave stale references.
  </action>
  <verify>
Run: `python -m pytest tests/ -x -q` -- all 383+ tests must pass. Then run:
```bash
rg 'Path\("outputs/' src/ --glob '!paths.py'
rg 'Path\("data/' src/ --glob '!paths.py'
```
These greps should return ZERO results from the 7 migrated files (results from packets/ files are expected -- those are migrated in Plan 09-02).
  </verify>
  <done>All 7 core pipeline files import paths from src.paths instead of defining them locally. No bare `Path("outputs/...")` or `Path("data/...")` patterns remain in the migrated files. All 383+ tests pass.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.paths import PROJECT_ROOT; print(PROJECT_ROOT)"` prints a valid path
2. `python -m pytest tests/ -x -q` -- all 383+ tests pass
3. `rg 'Path\("outputs/' src/ --glob '!paths.py' --glob '!packets/*'` returns zero results
4. `rg 'CACHE_FILE' src/analysis/` returns zero results (old name removed)
5. `rg 'Path\(__file__\).*parent.*parent' src/ --glob '!paths.py'` shows ONLY packets/ files (migrated in Plan 09-02)
</verification>

<success_criteria>
- src/paths.py exists with PROJECT_ROOT, all directory constants, all file path constants, and helper functions
- src/config.py imports PROJECT_ROOT from src.paths (no local definition)
- 7 core pipeline files use src.paths imports instead of local path construction
- All 383+ existing tests pass without modification (backward-compatible via config.py re-export)
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-hardening/09-01-SUMMARY.md`
</output>
