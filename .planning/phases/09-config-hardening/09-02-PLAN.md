---
phase: 09-config-hardening
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/packets/ecoregion.py
  - src/packets/registry.py
  - src/packets/congress.py
  - src/packets/awards.py
  - src/packets/hazards.py
  - src/packets/docx_engine.py
  - src/packets/change_tracker.py
  - src/packets/orchestrator.py
  - src/packets/strategic_overview.py
  - tests/test_schemas.py
  - tests/test_docx_integration.py
  - tests/test_doc_assembly.py
  - tests/test_strategic_overview.py
  - scripts/build_registry.py
  - scripts/build_congress_cache.py
  - scripts/build_tribal_aliases.py
  - scripts/build_web_index.py
autonomous: true

must_haves:
  truths:
    - "Every source file under src/ imports paths from src.paths -- no ad-hoc path construction survives"
    - "All test files import PROJECT_ROOT and path constants from src.paths instead of defining their own"
    - "All script files import path constants from src.paths instead of using bare relative Path() strings"
    - "Changing a data directory location in src/paths.py propagates to all consumers without code changes"
    - "Running rg for hardcoded path strings in src/ returns zero results (excluding paths.py itself)"
    - "All 383+ existing tests still pass after full migration"
  artifacts:
    - path: "src/packets/hazards.py"
      provides: "Hazard profiling with paths from src.paths"
      contains: "from src.paths import"
    - path: "src/packets/orchestrator.py"
      provides: "Packet orchestration with paths from src.paths"
      contains: "from src.paths import"
    - path: "tests/test_schemas.py"
      provides: "Schema tests importing from src.paths"
      contains: "from src.paths import"
  key_links:
    - from: "src/packets/orchestrator.py"
      to: "src/paths.py"
      via: "import for award_cache_dir, hazard_cache_dir, graph_schema, output_dir"
      pattern: "from src\\.paths import"
    - from: "src/packets/hazards.py"
      to: "src/paths.py"
      via: "import for crosswalk, nri, usfs, cache paths"
      pattern: "from src\\.paths import"
    - from: "src/packets/awards.py"
      to: "src/paths.py"
      via: "import for alias path and cache dir"
      pattern: "from src\\.paths import"
    - from: "tests/test_schemas.py"
      to: "src/paths.py"
      via: "import PROJECT_ROOT"
      pattern: "from src\\.paths import PROJECT_ROOT"
---

<objective>
Migrate all remaining files -- the packets subsystem (9 files), test files (4 files), and scripts (4 files) -- to import path constants from `src/paths.py`. After this plan, zero hardcoded path strings remain in any source file. Includes grep-based regression verification.

Purpose: Complete the centralization so changing a data directory in one place propagates everywhere. This is the verification-heavy companion to Plan 09-01.
Output: 17 migrated files + grep verification confirming zero hardcoded paths remain.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-config-hardening/09-RESEARCH.md
@.planning/phases/09-config-hardening/09-01-SUMMARY.md
@src/paths.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate packets subsystem to import from src/paths.py</name>
  <files>src/packets/ecoregion.py, src/packets/registry.py, src/packets/congress.py, src/packets/awards.py, src/packets/hazards.py, src/packets/docx_engine.py, src/packets/change_tracker.py, src/packets/orchestrator.py, src/packets/strategic_overview.py</files>
  <action>
Migrate 9 packets source files. For each file, remove `_DEFAULT_*` string constants and local path construction, replacing with `src.paths` imports. Use the `Path(cfg.get("key")) if cfg.get("key") else CONSTANT` pattern for config-overridable paths.

**src/packets/ecoregion.py** (lines 14, 34, 43, 46):
- Add `from src.paths import ECOREGION_CONFIG_PATH, PROJECT_ROOT`
- Remove `_DEFAULT_CONFIG_PATH = "data/ecoregion_config.json"` (line 14)
- In `__init__`: replace `eco_cfg.get("data_path", _DEFAULT_CONFIG_PATH)` with `eco_cfg.get("data_path", str(ECOREGION_CONFIG_PATH))`
- In the path resolution block (lines 43-46): replace `Path(__file__).resolve().parent.parent.parent / path` with `PROJECT_ROOT / path`
- Keep the `if not path.is_absolute()` conditional logic intact

**src/packets/registry.py** (lines 26, 49-50):
- Add `from src.paths import TRIBAL_REGISTRY_PATH, PROJECT_ROOT`
- Remove `_DEFAULT_DATA_PATH = "data/tribal_registry.json"` (line 26)
- Replace: `raw_path = registry_cfg.get("data_path", _DEFAULT_DATA_PATH)` with:
  ```python
  raw_path = registry_cfg.get("data_path")
  self.data_path = Path(raw_path) if raw_path else TRIBAL_REGISTRY_PATH
  ```
- If `self.data_path` is relative, resolve against `PROJECT_ROOT` (check existing resolution logic -- if there's a resolve step later, keep it; if the path is used directly, ensure it's absolute)

**src/packets/congress.py** (lines 18, 49-50):
- Add `from src.paths import CONGRESSIONAL_CACHE_PATH, PROJECT_ROOT`
- Remove `_DEFAULT_CACHE_PATH = "data/congressional_cache.json"` (line 18)
- Replace: `self.data_path = Path(cache_cfg.get("data_path", _DEFAULT_CACHE_PATH))` with:
  ```python
  raw_path = cache_cfg.get("data_path")
  self.data_path = Path(raw_path) if raw_path else CONGRESSIONAL_CACHE_PATH
  ```
- If `self.data_path` could be relative, resolve against `PROJECT_ROOT`

**src/packets/awards.py** (lines 30-31, 62-63):
- Add `from src.paths import TRIBAL_ALIASES_PATH, AWARD_CACHE_DIR, PROJECT_ROOT`
- Remove `_DEFAULT_ALIAS_PATH = "data/tribal_aliases.json"` and `_DEFAULT_CACHE_DIR = "data/award_cache"`
- Replace alias_path resolution:
  ```python
  raw_alias = awards_cfg.get("alias_path")
  alias_path = Path(raw_alias) if raw_alias else TRIBAL_ALIASES_PATH
  ```
- Replace cache_dir resolution:
  ```python
  raw_cache = awards_cfg.get("cache_dir")
  self.cache_dir = Path(raw_cache) if raw_cache else AWARD_CACHE_DIR
  ```
- If paths could be relative, resolve against `PROJECT_ROOT`

**src/packets/hazards.py** (lines 52-55, 96-109, 139-148):
- Add `from src.paths import AIANNH_CROSSWALK_PATH, NRI_DIR, USFS_DIR, HAZARD_PROFILES_DIR, PROJECT_ROOT`
- Remove all 4 `_DEFAULT_*` constants (lines 52-55)
- Simplify `_resolve_path` (lines 96-109): replace `Path(__file__).resolve().parent.parent.parent` with `PROJECT_ROOT`
- Update `__init__` config lookups (lines 139-148):
  ```python
  raw = hazards_cfg.get("crosswalk_path")
  self.crosswalk_path = _resolve_path(raw) if raw else AIANNH_CROSSWALK_PATH
  ```
  Apply same pattern for `nri_dir`, `usfs_dir`, `cache_dir` using `NRI_DIR`, `USFS_DIR`, `HAZARD_PROFILES_DIR`

**src/packets/docx_engine.py** (lines 59-60):
- Add `from src.paths import PACKETS_OUTPUT_DIR, PROJECT_ROOT`
- Replace: `config.get("packets", {}).get("output_dir", "outputs/packets")` with:
  ```python
  raw_dir = config.get("packets", {}).get("output_dir")
  self.output_dir = Path(raw_dir) if raw_dir else PACKETS_OUTPUT_DIR
  ```
- If `raw_dir` is relative, resolve against `PROJECT_ROOT`

**src/packets/change_tracker.py** (line 60):
- Add `from src.paths import PACKET_STATE_DIR`
- Replace: `self.state_dir = state_dir or Path("data/packet_state")` with:
  `self.state_dir = state_dir or PACKET_STATE_DIR`

**src/packets/orchestrator.py** (lines 23, 58-62, 499-501, 538, 575-576):
- Replace `from src.config import PROJECT_ROOT` with `from src.paths import PROJECT_ROOT, AWARD_CACHE_DIR, HAZARD_PROFILES_DIR, PACKET_STATE_DIR, GRAPH_SCHEMA_PATH, PACKETS_OUTPUT_DIR`
- Replace award_cache_dir construction (lines 58-59):
  ```python
  raw = packets_cfg.get("awards", {}).get("cache_dir")
  self.award_cache_dir = Path(raw) if raw else AWARD_CACHE_DIR
  ```
- Replace hazard_cache_dir construction (lines 61-62): same pattern with `HAZARD_PROFILES_DIR`
- Replace state_dir construction (lines 499-501): same pattern with `PACKET_STATE_DIR`
- Replace `graph_path = PROJECT_ROOT / "data" / "graph_schema.json"` (line 538) with `graph_path = GRAPH_SCHEMA_PATH`
- Replace output_dir construction (lines 575-576): same pattern with `PACKETS_OUTPUT_DIR`
- If any raw config paths are relative, resolve against `PROJECT_ROOT`

**src/packets/strategic_overview.py** (lines 22, 85, 88, 91, 103-105):
- Replace `from src.config import FISCAL_YEAR_SHORT, PROJECT_ROOT` with:
  `from src.config import FISCAL_YEAR_SHORT` and
  `from src.paths import PROJECT_ROOT, POLICY_TRACKING_PATH, GRAPH_SCHEMA_PATH, LATEST_MONITOR_DATA_PATH`
- Replace ad-hoc path constructions (lines 85, 88, 91):
  - `str(PROJECT_ROOT / "data" / "policy_tracking.json")` -> `str(POLICY_TRACKING_PATH)`
  - `str(PROJECT_ROOT / "data" / "graph_schema.json")` -> `str(GRAPH_SCHEMA_PATH)`
  - `str(PROJECT_ROOT / "outputs" / "LATEST-MONITOR-DATA.json")` -> `str(LATEST_MONITOR_DATA_PATH)`
- Keep the `_safe_load_json` method's `if not path.is_absolute(): path = PROJECT_ROOT / path` logic for config-overridden paths (lines 103-105)

CRITICAL: For every config-overridable path, preserve backward compatibility. If `scanner_config.json` provides a relative path string, it must still work via resolution against PROJECT_ROOT. The pattern `Path(raw) if raw else CONSTANT` handles this -- when config provides a relative string, it gets resolved via the module's existing resolution logic.
  </action>
  <verify>
Run: `python -m pytest tests/ -x -q` -- all 383+ tests must pass.

Then verify no `_DEFAULT_*` path constants remain in packets/:
```bash
rg '_DEFAULT_.*PATH\b|_DEFAULT_.*DIR\b' src/packets/
```
Should return zero results.
  </verify>
  <done>All 9 packets source files import paths from src.paths. No `_DEFAULT_*` path string constants remain. No `Path(__file__).resolve().parent.parent.parent` patterns remain in packets/. All config-overridable paths still work via PROJECT_ROOT resolution.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test files and scripts, then run regression verification</name>
  <files>tests/test_schemas.py, tests/test_docx_integration.py, tests/test_doc_assembly.py, tests/test_strategic_overview.py, scripts/build_registry.py, scripts/build_congress_cache.py, scripts/build_tribal_aliases.py, scripts/build_web_index.py</files>
  <action>
Migrate 4 test files and 4 script files to use `src.paths` imports.

**Test Files:**

**tests/test_schemas.py** (line 49, lines 55-93, 304-365):
- Remove local `PROJECT_ROOT = Path(__file__).resolve().parent.parent` (line 49)
- Add `from src.paths import PROJECT_ROOT` (and any specific path constants used like `DATA_DIR`, `AWARD_CACHE_DIR`, `HAZARD_PROFILES_DIR`, etc.)
- Review lines 55-93 and 304-365 for any ad-hoc path construction using the local PROJECT_ROOT, and replace with appropriate `src.paths` constants where possible
- Where test code constructs `PROJECT_ROOT / "data" / "some_file.json"`, replace with the matching constant from `src.paths`

**tests/test_docx_integration.py** (lines 606, 706):
- Replace `Path("config/scanner_config.json")` (line 606) with import of `SCANNER_CONFIG_PATH` from `src.paths`
- Replace `Path(__file__).parent.parent` (line 706) with import of `PROJECT_ROOT` from `src.paths`
- Add appropriate imports at top of file

**tests/test_doc_assembly.py** (line 691):
- Replace `Path(__file__).parent.parent` (line 691) with import of `PROJECT_ROOT` from `src.paths`
- Add appropriate import at top of file

**tests/test_strategic_overview.py**:
- Search for any hardcoded path strings or ad-hoc `Path()` constructions
- Replace with `src.paths` imports where found
- If this file uses mocks that patch path constants, update the mock targets to point to `src.paths` constants (e.g., `@patch("src.packets.strategic_overview.PROJECT_ROOT")` may need adjustment depending on how the import changed)

**Script Files:**

Scripts live in `scripts/` and may need `sys.path` adjustment to import from `src.paths`. Check if each script already has a sys.path insertion. If not, add at top:
```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
```

**scripts/build_registry.py**:
- Replace `Path("data/tribal_registry.json")` default with `from src.paths import TRIBAL_REGISTRY_PATH`
- Update argparse default to use `str(TRIBAL_REGISTRY_PATH)`

**scripts/build_congress_cache.py**:
- Replace `Path("data/...")` defaults (3 occurrences) with imports from `src.paths`:
  - `CONGRESSIONAL_CACHE_PATH`, `TRIBAL_REGISTRY_PATH`, `CENSUS_DATA_PATH`
- Update argparse defaults

**scripts/build_tribal_aliases.py**:
- Replace `Path("data/...")` constants (2 occurrences) with `src.paths` imports:
  - `TRIBAL_REGISTRY_PATH`, `TRIBAL_ALIASES_PATH`

**scripts/build_web_index.py**:
- Replace `Path(...)` defaults (3 occurrences) with `src.paths` imports:
  - `TRIBAL_REGISTRY_PATH`, `PACKETS_OUTPUT_DIR`, `TRIBES_INDEX_PATH`
- Update argparse defaults

After all migrations, run the **full regression verification**:

```bash
# 1. Hardcoded directory path strings in source (should be ZERO)
rg '"data/' src/ --glob '!__pycache__' --glob '!paths.py'
rg "'data/" src/ --glob '!__pycache__' --glob '!paths.py'
rg '"outputs/' src/ --glob '!__pycache__' --glob '!paths.py'
rg "'outputs/" src/ --glob '!__pycache__' --glob '!paths.py'
rg '"config/' src/ --glob '!__pycache__' --glob '!paths.py'

# 2. Independent PROJECT_ROOT definitions (should only be in paths.py)
rg 'Path\(__file__\).*parent.*parent' src/ --glob '!paths.py'

# 3. Bare relative Path() without anchoring
rg 'Path\("(data|outputs|config|docs)/' src/ --glob '!paths.py'

# 4. Stale _DEFAULT_ path constants
rg '_DEFAULT_.*PATH|_DEFAULT_.*DIR' src/

# 5. Tests defining own PROJECT_ROOT
rg 'PROJECT_ROOT\s*=' tests/ --glob '!__pycache__'
```

Each of these greps should return ZERO results. If any results appear, they are regressions that must be fixed before this task is done.

IMPORTANT exceptions to allow in grep results:
- String literals in docstrings/comments (these are documentation, not code paths)
- The string `"outputs/LATEST-MONITOR-DATA.json"` in strategic_overview.py line 408 if it's inside a user-facing message string (not a path construction) -- verify and leave if it's display text, fix if it's path construction
  </action>
  <verify>
Run the full test suite:
```bash
python -m pytest tests/ -v
```
All 383+ tests must pass.

Run all 5 grep regression checks listed above. Each should return zero results (excluding docstrings/comments).

Verify scripts can still import:
```bash
python -c "import sys; sys.path.insert(0, '.'); from scripts.build_registry import *; print('OK')"
```
  </verify>
  <done>All 4 test files and 4 script files migrated to src.paths imports. Full grep regression verification shows zero hardcoded path strings in source code. All 383+ tests pass. Phase 9 success criteria fully met.</done>
</task>

</tasks>

<verification>
Phase 9 success criteria verification (run ALL of these):

1. **Structural asks path resolution (CONF-01):**
   `rg "structural_asks" src/` -- should return zero hardcoded path strings for structural asks

2. **Centralized paths module exists (CONF-02):**
   `python -c "from src.paths import PROJECT_ROOT, DATA_DIR, OUTPUTS_DIR, SCANNER_CONFIG_PATH; print('All imports OK')"` -- should succeed

3. **Single-point-of-change:**
   All source files under `src/` import paths from `src.paths` (not constructing ad-hoc):
   ```bash
   rg 'Path\(__file__\).*parent.*parent' src/ --glob '!paths.py'
   ```
   Returns zero results.

4. **No hardcoded path strings survive:**
   ```bash
   rg 'Path\("(data|outputs|config|docs)/' src/ --glob '!paths.py'
   ```
   Returns zero results.

5. **All tests pass:**
   `python -m pytest tests/ -v` -- 383+ tests pass, zero failures.
</verification>

<success_criteria>
- All 9 packets source files import paths from src.paths
- All 4 test files import from src.paths (no local PROJECT_ROOT definitions)
- All 4 scripts import from src.paths
- Grep regression verification confirms zero hardcoded path strings remain in src/
- All 383+ existing tests pass
- Phase 9 CONF-01 and CONF-02 requirements fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-hardening/09-02-SUMMARY.md`
</output>
