---
phase: 16-document-quality-assurance
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - src/packets/docx_styles.py
  - src/packets/docx_template.py
  - src/packets/docx_hotsheet.py
  - src/packets/docx_sections.py
  - src/packets/docx_regional_sections.py
  - src/packets/orchestrator.py
  - src/packets/economic.py
  - src/packets/relevance.py
  - src/packets/agent_review.py
  - src/packets/quality_review.py
  - src/packets/doc_types.py
  - tests/test_docx_hotsheet.py
  - tests/test_docx_integration.py
  - tests/test_docx_styles.py
  - tests/test_docx_template.py
  - tests/test_packets.py
  - outputs/docx_review/SYNTHESIS.md
autonomous: true

must_haves:
  truths:
    - "Zero P0 (critical) defects remain in any agent findings after fixes are applied -- every P0 finding from Wave 1 has a verified fix in generation code"
    - "Zero P1 (major) defects remain in any agent findings after fixes -- every P1 finding from Wave 1 has a verified fix in generation code"
    - "All fixes are in generation code (src/packets/), not in generated DOCX files -- future runs produce correct output without post-hoc patching"
    - "SYNTHESIS.md exists as a human-readable quality certificate with pass/fail status, defect counts by severity, per-agent summaries, and known issues list for remaining P2/P3 items"
    - "All existing tests still pass after fixes, and new tests cover the critical gaps identified by the Gap Finder agent"
    - "Re-validation confirms fixes resolved the defects they targeted without introducing regressions"
  artifacts:
    - path: "outputs/docx_review/SYNTHESIS.md"
      provides: "Quality certificate and Phase 16 gate document"
      contains: "PASS"
    - path: "src/packets/docx_styles.py"
      provides: "Fixed style system (Design Aficionado findings)"
    - path: "src/packets/docx_sections.py"
      provides: "Fixed section renderers (Accuracy Agent findings)"
    - path: "src/packets/orchestrator.py"
      provides: "Fixed pipeline (Pipeline Surgeon findings)"
  key_links:
    - from: "outputs/docx_review/*_findings.json"
      to: "src/packets/*.py fixes"
      via: "fix_recommendation field in each finding"
      pattern: "severity.*P[01]"
    - from: "outputs/docx_review/SYNTHESIS.md"
      to: "Phase 17 gate"
      via: "Zero P0/P1 requirement"
      pattern: "p0.*0.*p1.*0"
---

<objective>
Fix all P0 and P1 defects found in Wave 1, add tests for critical coverage gaps, re-validate, and produce the SYNTHESIS.md quality certificate that gates Phase 17.

Purpose: Wave 2 of the two-wave Phase 16 structure. This fix wave transforms audit findings into code corrections, ensuring all generated documents are structurally valid and content-accurate. The SYNTHESIS.md serves as the quality gate -- Phase 17 cannot proceed until it shows zero P0/P1 defects.

Output:
- Fixed generation code in `src/packets/` (all fixes in generation code, never in output files)
- New tests covering critical gaps identified by Gap Finder
- `outputs/docx_review/SYNTHESIS.md` -- quality certificate with pass/fail, defect counts, known issues
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-document-quality-assurance/16-CONTEXT.md
@.planning/phases/16-document-quality-assurance/16-RESEARCH.md
@.planning/phases/16-document-quality-assurance/16-01-SUMMARY.md

# Wave 1 findings (the input to this plan)
@outputs/docx_review/design-aficionado_findings.json
@outputs/docx_review/accuracy-agent_findings.json
@outputs/docx_review/pipeline-surgeon_findings.json
@outputs/docx_review/gatekeeper_findings.json
@outputs/docx_review/gap-finder_findings.json

# Agent definitions (for territory boundaries during fix wave)
@.planning/design-aficionado.md
@.planning/accuracy-agent.md
@.planning/pipeline-surgeon.md
@.planning/gatekeeper.md
@.planning/gap-finder.md

# Source files to fix
@src/packets/docx_styles.py
@src/packets/docx_template.py
@src/packets/docx_hotsheet.py
@src/packets/docx_sections.py
@src/packets/docx_regional_sections.py
@src/packets/orchestrator.py
@src/packets/context.py
@src/packets/economic.py
@src/packets/relevance.py
@src/packets/agent_review.py
@src/packets/quality_review.py
@src/packets/doc_types.py

# Test files to extend
@tests/test_docx_hotsheet.py
@tests/test_docx_integration.py
@tests/test_docx_styles.py
@tests/test_docx_template.py
@tests/test_packets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all P0 and P1 defects in generation code and add critical tests</name>
  <files>
src/packets/docx_styles.py
src/packets/docx_template.py
src/packets/docx_hotsheet.py
src/packets/docx_sections.py
src/packets/docx_regional_sections.py
src/packets/orchestrator.py
src/packets/economic.py
src/packets/relevance.py
src/packets/agent_review.py
src/packets/quality_review.py
src/packets/doc_types.py
tests/test_docx_hotsheet.py
tests/test_docx_integration.py
tests/test_docx_styles.py
tests/test_docx_template.py
tests/test_packets.py
  </files>
  <action>
Read all 5 findings JSON files from `outputs/docx_review/`. Parse findings arrays and filter to P0 and P1 severity items. These are the mandatory fixes.

**Fix strategy by agent territory (respect boundaries -- each territory's agent fixes its own files):**

### Design Aficionado territory fixes
Files: `src/packets/docx_styles.py`, `src/packets/docx_template.py`
Fix types: Color contrast violations, font size hierarchy issues, orphan/phantom styles, template sync problems
Key patterns to watch:
- OxmlElement must be fresh per call
- Style names must match between definition and reference
- All styles must use Arial font family

### Accuracy Agent territory fixes
Files: `src/packets/docx_hotsheet.py`, `src/packets/docx_sections.py`, `src/packets/docx_regional_sections.py`
Fix types: Dollar amounts not using format_dollars(), hardcoded FY strings, audience leakage between doc types, air gap violations, OxmlElement reuse, section break misuse
Key patterns to watch:
- Every dollar amount MUST go through `format_dollars()` from `src/utils.py`
- FY references from config, never string literals
- `paragraph.clear()` not `cell.text = ""`
- Page breaks not section breaks between Hot Sheets
- Content flags from doc_types.py respected in every conditional

### Pipeline Surgeon territory fixes
Files: `src/packets/orchestrator.py`, `src/packets/economic.py`, `src/packets/relevance.py`
Fix types: Missing 10MB size guards on cache loads, unguarded division by zero, path traversal gaps, missing UTF-8 encoding, error handling gaps
Key patterns to watch:
- `stat().st_size` check before `json.load()` for any cache file
- `encoding="utf-8"` on all `open()` calls
- Division guards for economic calculations
- `Path(tribe_id).name` for path sanitization
- Graceful degradation when data missing for a Tribe

### Gatekeeper territory fixes
Files: `src/packets/agent_review.py`, `src/packets/quality_review.py`, `src/packets/doc_types.py`
Fix types: Air gap regex gaps (case variations, abbreviations), quality gate bypass paths, priority hierarchy enforcement, incomplete doc type flags
Key patterns to watch:
- Air gap patterns must catch: ATNI, A.T.N.I., atni, Atni, NCAI, etc.
- Quality gate must FAIL (not pass) when fewer than 3 agents complete
- Priority constants, not magic numbers

### Gap Finder territory: Add critical tests
Files: All test files
Add tests for the "critical" priority items from `gap-finder_findings.json`:
- Missing audience leakage tests for Doc B and Doc D
- Missing edge case tests (empty awards, empty hazards, zero economic impact)
- Missing Doc C/D regional renderer tests
- Upgrade no-crash-only tests to assert on actual content where flagged as critical

**Important rules:**
- ONLY fix P0 and P1 items. P2 and P3 are documented in SYNTHESIS.md as known issues.
- ALL fixes go in generation code (`src/packets/`), NEVER modify generated DOCX files.
- Respect agent territory boundaries. If a cross-territory fix is needed, apply it in the file that belongs to the finding agent's territory.
- Run `python -m pytest tests/ -v --tb=short` after each batch of fixes to catch regressions early.
- Use `encoding="utf-8"` for all file operations.
- Atomic write pattern (tmp + os.replace) where the codebase already uses it.
  </action>
  <verify>
- `python -m pytest tests/ -v --tb=short` passes with zero failures
- Every P0 finding from all 5 agents has been addressed (grep findings JSONs for P0, verify each has a code fix)
- Every P1 finding from all 5 agents has been addressed
- No generated DOCX files were modified (only src/packets/ and tests/)
- New tests cover the critical gaps identified by Gap Finder
  </verify>
  <done>All P0 and P1 defects from Wave 1 findings are fixed in generation code, critical test coverage gaps are filled, and all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Re-validate fixes and produce SYNTHESIS.md quality certificate</name>
  <files>outputs/docx_review/SYNTHESIS.md</files>
  <action>
After all P0/P1 fixes are applied, perform re-validation and produce the quality certificate.

**Re-validation strategy (from 16-RESEARCH.md):**
- If total P0+P1 findings from Wave 1 < 20: Targeted spot-check -- re-read the specific code sections that were fixed and verify the fix addresses the finding.
- If total P0+P1 findings >= 20: Full re-audit of affected files.

**Re-validation steps:**
1. For each P0/P1 finding that was fixed, verify:
   - The specific code line/pattern identified in the finding has been changed
   - The fix matches the fix_recommendation (or a valid alternative)
   - The fix doesn't introduce new issues in surrounding code
   - Related tests pass

2. Run structural validation script if documents are available:
   `python scripts/validate_docx_structure.py`
   (If no documents exist, note this in SYNTHESIS.md)

3. Run full test suite:
   `python -m pytest tests/ -v --tb=short`
   Record total test count and any failures.

**Produce SYNTHESIS.md** at `outputs/docx_review/SYNTHESIS.md` with this structure:

```markdown
# Document Quality Assurance - Phase 16 Synthesis

## Overall Status: PASS / FAIL

**Date:** {ISO-8601}
**Documents in corpus:** 992 (384 Doc A + 592 Doc B + 8 Doc C + 8 Doc D)
**Audited by:** 5 specialist agents
**Gate requirement:** Zero P0, Zero P1

## Severity Summary

| Severity | Wave 1 Found | Fixed | Remaining |
|----------|-------------|-------|-----------|
| P0 Critical | {n} | {n} | 0 |
| P1 Major | {n} | {n} | 0 |
| P2 Moderate | {n} | 0 | {n} |
| P3 Minor | {n} | 0 | {n} |
| **Total** | {n} | {n} | {n} |

## Per-Agent Summary

| Agent | Territory | P0 | P1 | P2 | P3 | Total |
|-------|-----------|----|----|----|----|-------|
| Design Aficionado | styles, template | ... | ... | ... | ... | ... |
| Accuracy Agent | hotsheet, sections | ... | ... | ... | ... | ... |
| Pipeline Surgeon | orchestrator, economic | ... | ... | ... | ... | ... |
| Gatekeeper | quality gates | ... | ... | ... | ... | ... |
| Gap Finder | test coverage | ... | ... | ... | ... | ... |

## Fixes Applied

[List each P0/P1 fix with: finding ID, file, description, verification status]

## Test Coverage

- Tests before Phase 16: {n}
- Tests after Phase 16: {n}
- Critical gaps filled: [list]

## Structural Validation

[Results from validate_docx_structure.py or note that documents need regeneration]

## Known Issues (P2/P3)

[List remaining P2/P3 items with: finding ID, severity, file:line, description]
These are documented for future cleanup and do not block Phase 17.

## Gate Decision

Phase 17 (Website Deployment) is: CLEARED / BLOCKED
Reason: [Zero P0/P1 remaining OR list blockers]
```

**Important:** The SYNTHESIS.md is the gate document for Phase 17. It must be accurate and complete. Do not claim PASS if any P0 or P1 remains unresolved.
  </action>
  <verify>
- `outputs/docx_review/SYNTHESIS.md` exists and contains all required sections
- Overall Status is PASS only if P0=0 and P1=0 remaining
- Severity counts in SYNTHESIS.md match actual findings across all 5 agent JSONs
- Per-agent summary matches individual agent findings files
- Known Issues section lists all remaining P2/P3 items
- Gate Decision section explicitly clears or blocks Phase 17
- `python -m pytest tests/ -v --tb=short` passes
  </verify>
  <done>SYNTHESIS.md quality certificate exists with accurate severity counts, all P0/P1 verified as fixed, known issues documented, and Phase 17 gate decision rendered</done>
</task>

</tasks>

<verification>
1. Zero P0 defects remaining across all 5 agent findings
2. Zero P1 defects remaining across all 5 agent findings
3. All fixes are in `src/packets/` generation code (not in output DOCX files)
4. `outputs/docx_review/SYNTHESIS.md` exists with PASS status and complete defect accounting
5. All tests pass: `python -m pytest tests/ -v --tb=short`
6. New tests cover critical gaps from Gap Finder (audience leakage, edge cases, Doc C/D)
7. SYNTHESIS.md gate decision clears Phase 17 for execution
</verification>

<success_criteria>
- Phase 16 quality gate passes: zero P0, zero P1 defects remaining
- Generation code is improved so all FUTURE document runs produce correct output
- Quality certificate (SYNTHESIS.md) provides complete traceability from finding to fix
- Test suite is stronger with critical coverage gaps filled
- Phase 17 (Website Deployment) is unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/16-document-quality-assurance/16-02-SUMMARY.md`
</output>
