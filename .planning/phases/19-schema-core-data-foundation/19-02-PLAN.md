---
phase: 19-schema-core-data-foundation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/schemas/vulnerability.py
  - src/schemas/__init__.py
  - tests/test_vulnerability_schemas.py
autonomous: true

must_haves:
  truths:
    - "All vulnerability Pydantic models importable from src.schemas.vulnerability"
    - "Models validate sample data with correct field types, constraints, and defaults"
    - "Invalid data (negative percentiles, out-of-range scores, missing required fields) raises ValidationError"
    - "Composite score model handles weight redistribution for missing components"
    - "Data gap enum covers all 6 defined gap scenarios"
    - "Investment priority tier model maps score thresholds correctly"
  artifacts:
    - path: "src/schemas/vulnerability.py"
      provides: "All vulnerability Pydantic v2 models"
      contains: "class VulnerabilityProfile"
    - path: "src/schemas/__init__.py"
      provides: "Re-exports vulnerability models"
      contains: "VulnerabilityProfile"
    - path: "tests/test_vulnerability_schemas.py"
      provides: "Validation tests for all vulnerability models"
      contains: "test_vulnerability_profile_valid"
  key_links:
    - from: "src/schemas/vulnerability.py"
      to: "pydantic"
      via: "BaseModel, Field, field_validator, model_validator"
      pattern: "from pydantic import"
    - from: "src/schemas/__init__.py"
      to: "src/schemas/vulnerability.py"
      via: "re-export"
      pattern: "from src.schemas.vulnerability import"
---

<objective>
Define all vulnerability Pydantic v2 schema models using TDD: write failing tests for each model's validation behavior, then implement the models to pass.

Purpose: REG-03 (schema-first approach). These models define the data contracts that all downstream builders, renderers, and pipeline components code against. No population script or builder can be written without these schemas being stable.

Output: `src/schemas/vulnerability.py` with ~15 Pydantic models, comprehensive test suite, and re-exports in `__init__.py`.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-schema-core-data-foundation/19-RESEARCH.md

@src/schemas/models.py -- Existing Pydantic v2 conventions (19 models, field_validator/model_validator patterns)
@src/schemas/__init__.py -- Existing re-export pattern
@.planning/phases/18.5-architectural-review/river-runner-report.md -- 37 model drafts (starting point, NOT copy-paste)
</context>

<feature>
  <name>Vulnerability Pydantic v2 Schema Models (REG-03)</name>
  <files>src/schemas/vulnerability.py, src/schemas/__init__.py, tests/test_vulnerability_schemas.py</files>
  <behavior>
    The models must validate:

    **DataGapType** (str enum):
    - 6 values: MISSING_SVI, PARTIAL_NRI, ZERO_AREA_WEIGHT, ALASKA_PARTIAL, NO_COASTAL_DATA, SOURCE_UNAVAILABLE
    - Each maps to a reader-facing message string via GAP_MESSAGES dict

    **InvestmentPriorityTier** (str enum):
    - 5 values: CRITICAL, HIGH, ELEVATED, MODERATE, LOW
    - Threshold mapping: Critical >= 0.80, High >= 0.60, Elevated >= 0.40, Moderate >= 0.20, Low < 0.20
    - Classmethod `from_score(score: float) -> InvestmentPriorityTier` using >= boundary rule

    **NRIExpanded** (BaseModel):
    - tribe_id: str (required, must start with "epa_")
    - risk_score: float (>= 0.0)
    - risk_percentile: float (0.0-100.0, computed national percentile)
    - eal_total: float (>= 0.0, total expected annual loss)
    - eal_buildings: float (>= 0.0, EAL_VALB)
    - eal_population: float (>= 0.0, EAL_VALP)
    - eal_agriculture: float (>= 0.0, EAL_VALA)
    - eal_population_equivalence: float (>= 0.0, EAL_VALPE)
    - community_resilience: float (0.0-100.0, RESL_SCORE)
    - social_vulnerability_nri: float (0.0-100.0, SOVI_SCORE from NRI, distinct from CDC SVI)
    - hazard_count: int (>= 0, number of non-zero hazard types)
    - top_hazards: list[dict] (sorted by EAL descending, max 5)
    - coverage_pct: float (0.0-1.0, area-weighted coverage fraction)
    - field_validator on risk_percentile: clamp to [0, 100]
    - field_validator on tribe_id: must start with "epa_"

    **SVITheme** (BaseModel):
    - theme_id: str (one of "theme1", "theme2", "theme4")
    - name: str
    - percentile: float (0.0-1.0, RPL_THEME* value)
    - flag_count: int (>= 0)
    - field_validator on percentile: clamp to [0, 1], reject -999

    **SVIProfile** (BaseModel):
    - tribe_id: str (required)
    - themes: list[SVITheme] (max 3 items, validated by model_validator)
    - composite: float (0.0-1.0, average of theme percentiles)
    - coverage_pct: float (0.0-1.0)
    - source_year: int (default 2022)
    - data_gaps: list[DataGapType] (default empty)
    - model_validator: if len(themes) > 3, raise ValueError
    - model_validator: composite must equal mean of theme percentiles (within tolerance 0.01)

    **CompositeComponent** (BaseModel):
    - component: str (one of "hazard_exposure", "social_vulnerability", "adaptive_capacity_deficit")
    - raw_score: float (0.0-1.0)
    - base_weight: float (> 0.0)
    - weight: float (> 0.0, redistributed weight)
    - weighted_score: float (>= 0.0)
    - available: bool (default True)

    **CompositeScore** (BaseModel):
    - score: float (0.0-1.0)
    - tier: InvestmentPriorityTier
    - data_completeness: float (0.0-1.0, fraction of total weight covered)
    - components: list[CompositeComponent]
    - model_validator: tier must match InvestmentPriorityTier.from_score(score)

    **VulnerabilityProfile** (BaseModel):
    - tribe_id: str (required)
    - tribe_name: str (required)
    - nri: Optional[NRIExpanded]
    - svi: Optional[SVIProfile]
    - composite: Optional[CompositeScore]
    - is_coastal: bool (default False)
    - data_gaps: list[DataGapType] (default empty, aggregated from sub-profiles)
    - previous_tier: Optional[str] (default None, for future change tracking)
    - generated_at: str (ISO timestamp)
    - nri_version: Optional[str]
    - svi_version: Optional[str]

    Test cases (input -> expected):
    - Valid complete profile -> validates without error
    - Negative risk_percentile -> clamped to 0.0
    - risk_percentile > 100 -> clamped to 100.0
    - SVITheme with percentile = -999 -> rejected (sentinel)
    - SVIProfile with 4 themes -> ValidationError
    - CompositeScore with score=0.85 -> tier=CRITICAL
    - CompositeScore with score=0.60 -> tier=HIGH
    - CompositeScore with score=0.40 -> tier=ELEVATED
    - CompositeScore with score=0.20 -> tier=MODERATE
    - CompositeScore with score=0.19 -> tier=LOW
    - InvestmentPriorityTier.from_score(0.80) -> CRITICAL (boundary: >=)
    - Missing tribe_id -> ValidationError
    - tribe_id not starting with "epa_" -> ValidationError
  </behavior>
  <implementation>
    Follow existing conventions from src/schemas/models.py:
    - Import pattern: `from __future__ import annotations`, `from pydantic import BaseModel, Field, field_validator, model_validator`
    - Use `mode="before"` for sanitization validators (handling None, NaN, -999)
    - Use `mode="after"` for cross-field validators (must return self)
    - Use frozenset for enum-like validation sets
    - Use Field with ge, le, description, default, examples
    - DataGapType and InvestmentPriorityTier as string enums (Python `enum.Enum` subclass)
    - GAP_MESSAGES dict mapping DataGapType -> reader-facing message string
    - TIER_THRESHOLDS dict mapping tier -> minimum score

    Update src/schemas/__init__.py to re-export all new models.

    ANTI-PATTERNS to avoid:
    - Do NOT put models in models.py (already 1,261 lines)
    - Do NOT use RPL_THEMES (includes excluded Theme 3)
    - Do NOT reference RISK_NPCTL (does not exist)
    - model_validator(mode="after") MUST return self
  </implementation>
</feature>

<verification>
1. `python -c "from src.schemas.vulnerability import VulnerabilityProfile, NRIExpanded, SVIProfile, CompositeScore, InvestmentPriorityTier, DataGapType; print('All imports OK')"` -- succeeds
2. `python -c "from src.schemas.vulnerability import InvestmentPriorityTier; assert InvestmentPriorityTier.from_score(0.80).value == 'Critical'; print('Tier mapping OK')"` -- succeeds
3. `python -m pytest tests/test_vulnerability_schemas.py -v` -- all new tests pass
4. `python -m pytest tests/ -x -q` -- all tests pass (no regressions)
</verification>

<success_criteria>
- All vulnerability Pydantic models importable from src.schemas.vulnerability
- At least 30 tests covering valid data, invalid data, boundary conditions, and edge cases
- DataGapType enum has 6 values with correct message mappings
- InvestmentPriorityTier.from_score() correctly classifies all 5 tiers with >= boundary rule
- CompositeScore model_validator enforces tier/score consistency
- SVIProfile model_validator enforces max 3 themes and composite/mean consistency
- Re-exports in __init__.py updated
</success_criteria>

<output>
After completion, create `.planning/phases/19-schema-core-data-foundation/19-02-SUMMARY.md`
</output>
