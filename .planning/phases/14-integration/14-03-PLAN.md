---
phase: 14-integration
plan: 03
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - src/packets/docx_engine.py
  - src/packets/docx_sections.py
  - src/packets/docx_hotsheet.py
  - src/packets/orchestrator.py
  - tests/test_doc_assembly.py
  - tests/test_audience_filtering.py
autonomous: true

must_haves:
  truths:
    - "Doc A generates with leverage/approach/messaging sections; Doc B generates without them"
    - "DocxEngine.generate() produces audience-differentiated output based on DocumentTypeConfig"
    - "Orchestrator generates 2 documents per Tribe (Doc A + Doc B) when doc types specified"
    - "Economic impact narrative includes hazard context when hazard data is available"
    - "Hot sheets in Doc B have evidence-only Key Ask boxes (no leverage)"
  artifacts:
    - path: "tests/test_audience_filtering.py"
      provides: "Tests proving internal-only content never appears in congressional docs"
      min_lines: 60
  key_links:
    - from: "src/packets/orchestrator.py"
      to: "src/packets/docx_engine.py"
      via: "Orchestrator calls engine.generate() once per doc type per Tribe"
      pattern: "doc_type_config"
    - from: "src/packets/docx_sections.py"
      to: "src/packets/doc_types.py"
      via: "Section renderers check doc_type_config flags before including internal-only content"
      pattern: "include_strategy"
    - from: "src/packets/docx_hotsheet.py"
      to: "src/packets/doc_types.py"
      via: "HotSheetRenderer filters advocacy_lever based on doc_type_config"
      pattern: "include_advocacy_lever"
---

<objective>
Add audience-filtered section rendering so Doc A and Doc B produce differentiated Tribal documents, and update the orchestrator to generate both document types per Tribe.

Purpose: This is the core INTG-01 and INTG-02 implementation for Tribal-scope documents. The DocxEngine gets document-type-aware section rendering (what content appears in internal vs. congressional docs), and the orchestrator gets multi-doc-per-Tribe generation flow.

Output: Per-Tribe generation produces Doc A (internal strategy with leverage/approach/messaging) and Doc B (congressional overview with evidence-only hot sheets). Economic impact sections use real hazard context.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE-14-DESIGN-DECISIONS.md
@.planning/phases/14-integration/14-02-SUMMARY.md
@src/packets/docx_engine.py
@src/packets/docx_sections.py
@src/packets/docx_hotsheet.py
@src/packets/orchestrator.py
@src/packets/doc_types.py
@src/packets/economic.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audience-filtered section rendering to DocxEngine</name>
  <files>src/packets/docx_engine.py, src/packets/docx_sections.py, src/packets/docx_hotsheet.py</files>
  <action>
  Modify the generate() flow in DocxEngine to produce audience-differentiated output based on DocumentTypeConfig.

  **DocxEngine.generate() changes:**

  The current generate() calls 9 sections in order. The new flow should check `self.doc_type_config` to decide what to include:

  For Doc A (internal strategy), the section order becomes:
  1. Cover page (with CONFIDENTIAL banner, strategy title)
  2. Table of contents
  3. Executive summary (assertive voice, includes strategic framing)
  4. Congressional delegation table (with STRATEGIC NOTES per member)
  5. Hot Sheets per program (with STRATEGIC LEVERAGE and APPROACH STRATEGY subsections)
  6. Hazard profile summary (with hazard-to-program alignment narrative)
  7. Structural policy asks (strategic framing)
  8. Messaging framework section (NEW -- only in Doc A; 14-REFERENCE.md Section 8)
  9. Change tracking (if changes exist)
  10. Appendix

  For Doc B (congressional overview), the section order becomes:
  1. Cover page (clean, no CONFIDENTIAL)
  2. Table of contents
  3. Executive summary (objective voice, hazard profile summary, award history summary)
  4. Congressional delegation table (committee assignments only, NO strategic notes)
  5. Hot Sheets per program (with Key Ask box but NO leverage, NO approach strategy)
  6. Hazard profile (full page, evidence-forward)
  7. Structural policy asks (policy recommendation framing)
  8. Appendix (additional programs, methodology)
  NO change tracking in Doc B. NO messaging framework.

  **Implementation approach:** Do NOT create separate generate_doc_a() / generate_doc_b() methods. Instead, modify the existing generate() to use conditional rendering:

  ```python
  def generate(self, context, relevant_programs, economic_summary, ..., doc_type_config=None):
      config = doc_type_config or self.doc_type_config or DOC_B
      doc, sm = self.create_document()
      # Apply headers/footers from doc_type_config (from Plan 14-02)
      render_cover_page(doc, context, sm, doc_type_config=config)
      render_table_of_contents(doc, context, sm)
      render_executive_summary(doc, context, sm, economic_summary, doc_type_config=config)
      render_delegation_section(doc, context, sm, doc_type_config=config)
      # Hot sheets
      for program in relevant_programs:
          hotsheet.render(doc, program, context, sm, economic_summary, doc_type_config=config)
      render_hazard_summary(doc, context, sm, doc_type_config=config)
      render_structural_asks_section(doc, context, sm, structural_asks, doc_type_config=config)
      if config.include_messaging_framework:
          render_messaging_framework(doc, context, sm)  # NEW section, Doc A only
      if changes and config.is_internal:
          render_change_tracking(doc, context, sm, changes, previous_date)
      render_appendix(doc, context, sm, omitted_programs, doc_type_config=config)
  ```

  **Section renderer modifications (docx_sections.py):**

  1. `render_executive_summary()`: Accept `doc_type_config` kwarg.
     - If assertive voice (internal): include strategic framing paragraph ("Congress funded; Administration not delivering"), include aggregate economic impact with strategic context
     - If objective voice (congressional): evidence-first opening, hazard profile summary, award history summary, program count

  2. `render_delegation_section()`: Accept `doc_type_config` kwarg.
     - If internal: add STRATEGIC NOTES subsection after the delegation table with per-member committee influence notes, recommended approach framing
     - If congressional: delegation table with committee assignments only

  3. `render_hazard_summary()`: Accept `doc_type_config` kwarg.
     - If internal: include hazard-to-program alignment narrative ("Given high wildfire risk, prioritize [program] which addresses...")
     - If congressional: present hazard data factually with NRI scores and source citation
     - BOTH versions should use real hazard data when available (from Plan 14-01). When hazard profile shows zeros/empty, add graceful degradation text: "Hazard profile data not yet available for this Tribe."

  4. `render_structural_asks_section()`: Accept `doc_type_config` kwarg.
     - If strategic framing: assertive, action-oriented ("Push for oversight hearings")
     - If policy_recommendation framing: measured, evidence-based ("Policy improvements to enhance program access")

  5. NEW `render_messaging_framework()`: Create this function for Doc A only. Renders audience-calibrated messages for: Appropriations members, Authorizing committee members, Senate Committee on Indian Affairs, Bipartisan framing, District-level framing, Treaty/trust frame. Content is generated from context data (which committees the Tribe's delegation sits on, what programs are relevant).

  **HotSheetRenderer (docx_hotsheet.py) modifications:**
  - Accept `doc_type_config` in render method
  - If `config.include_advocacy_lever`: include the STRATEGIC LEVERAGE subsection with advocacy_lever text from program inventory and tightened_language
  - If `config.include_member_approach`: include APPROACH STRATEGY subsection with which delegation members to prioritize and committee alignment
  - If congressional: Key Ask box with ASK / WHY / IMPACT only (no leverage, no approach). The "Why" uses factual evidence (award history, hazard alignment, economic impact). The "Impact" uses real economic computation.
  - BOTH versions include economic impact with real data (not benchmark averages for congressional -- if no real data, state "No prior federal awards in this program" instead of benchmark estimates)

  **Economic-hazard integration (INTG-01):**
  In the hot sheet renderer, when computing per-program context:
  - If hazard profile has real data (risk_score > 0), add a "Hazard Alignment" paragraph: "This program addresses {hazard} which ranks #{rank} among {tribe_name}'s top hazards (NRI Risk Score: {score})"
  - If hazard data is empty, omit the hazard alignment paragraph (don't show zeros)

  IMPORTANT: Maintain backward compatibility. The existing generate() signature should still work without doc_type_config (defaulting to DOC_B behavior which most closely matches current output).
  </action>
  <verify>
  1. `python -m pytest tests/test_doc_assembly.py -v` -- existing tests still pass
  2. `python -m pytest tests/test_docx_hotsheet.py -v` -- existing hot sheet tests pass
  </verify>
  <done>DocxEngine.generate() produces audience-differentiated documents; section renderers conditionally include/exclude content based on DocumentTypeConfig flags; hazard context woven into economic narrative where data exists</done>
</task>

<task type="auto">
  <name>Task 2: Update orchestrator for multi-doc generation + audience filtering tests</name>
  <files>src/packets/orchestrator.py, tests/test_audience_filtering.py</files>
  <action>
  **PacketOrchestrator modifications:**

  1. Add `generate_tribal_docs(context, tribe, doc_types=None)` method that generates multiple document types for a single Tribe:
     ```python
     def generate_tribal_docs(self, context, tribe, doc_types=None):
         """Generate specified document types for a Tribe.

         Args:
             context: TribePacketContext with all data
             tribe: Tribe dict from registry
             doc_types: List of DocumentTypeConfig instances.
                        Defaults to [DOC_A, DOC_B] for full-data Tribes,
                        [DOC_B] for abbreviated/partial-data Tribes.
         """
         if doc_types is None:
             if self._has_complete_data(context):
                 doc_types = [DOC_A, DOC_B]
             else:
                 doc_types = [DOC_B]  # abbreviated for partial-data

         paths = []
         for doc_config in doc_types:
             path = self._generate_single_doc(context, tribe, doc_config)
             paths.append(path)
         return paths
     ```

  2. Add `_has_complete_data(context)` helper that checks:
     - Has awards (context.awards non-empty, total_obligation > 0)
     - Has congressional delegation (context.senators or context.representatives non-empty)
     - Has hazard data (context.hazard_profile.get('sources',{}).get('fema_nri',{}).get('composite',{}).get('risk_score',0) > 0)
     Full data = awards + delegation. Hazard data is a bonus (enhances content) but not required for "complete."

  3. Add `_generate_single_doc(context, tribe, doc_type_config)` that:
     - Creates DocxEngine with doc_type_config
     - Calls engine.generate() with doc_type_config
     - Uses doc_type_config.format_filename(tribe_slug) for output filename
     - Saves to appropriate subdirectory: `output_dir/internal/` for Doc A, `output_dir/congressional/` for Doc B
     - Returns the output path

  4. Modify `run_single_tribe()` to call `generate_tribal_docs()` instead of `generate_packet_from_context()`. Keep the existing method as a backward-compatible wrapper.

  5. Modify `run_all_tribes()` to call `generate_tribal_docs()` per Tribe. Track generation counts: how many Doc A generated, how many Doc B generated.

  6. Add output directory structure:
     - `output_dir/internal/` -- Doc A files
     - `output_dir/congressional/` -- Doc B files

  **Tests (tests/test_audience_filtering.py):**

  Create comprehensive audience filtering tests:

  1. `test_doc_a_contains_strategy_content`: Generate a Doc A, read it back, verify it contains keywords like "Strategic Leverage", "Approach Strategy", "Messaging Framework"

  2. `test_doc_b_excludes_strategy_content`: Generate a Doc B, read it back, verify it does NOT contain: "Strategic Leverage", "Approach Strategy", "Messaging Framework", "advocacy_lever", "tightened_language", "leverage", "pressure point"

  3. `test_doc_a_confidential_header`: Generate Doc A, verify header contains "CONFIDENTIAL"

  4. `test_doc_b_no_confidential`: Generate Doc B, verify header does NOT contain "CONFIDENTIAL"

  5. `test_doc_b_has_key_ask_box`: Generate Doc B, verify hot sheets contain "Key Ask" sections

  6. `test_orchestrator_generates_two_docs_for_complete_tribe`: Mock a Tribe with full data, call generate_tribal_docs(), verify 2 files created in internal/ and congressional/

  7. `test_orchestrator_generates_one_doc_for_partial_tribe`: Mock a Tribe with no awards, verify only 1 file created (Doc B only in congressional/)

  8. `test_no_air_gap_violations`: Generate both Doc A and Doc B, scan all paragraph text for "TCR Policy Scanner", "ATNI", "NCAI" -- assert zero matches

  Use the existing test patterns: mock data builders, tmp_path, DocxDocument read-back.
  </action>
  <verify>
  1. `python -m pytest tests/test_audience_filtering.py -v` -- all new tests pass
  2. `python -m pytest tests/test_packets.py -v` -- existing orchestrator tests pass
  3. `python -m pytest tests/ -x -q` -- full suite passes
  </verify>
  <done>Orchestrator generates Doc A + Doc B per Tribe with audience differentiation; internal/ and congressional/ output directories; tests prove no strategy content leaks into congressional docs; all tests pass</done>
</task>

</tasks>

<verification>
1. Generate Doc A for a mock Tribe: contains leverage, approach, messaging framework, CONFIDENTIAL header
2. Generate Doc B for same Tribe: evidence-only, no leverage/approach/messaging, clean header
3. Orchestrator produces 2 files per complete-data Tribe in internal/ and congressional/ dirs
4. Economic impact sections reference hazard alignment when hazard data exists
5. Hot sheets in Doc B have Key Ask without leverage; hot sheets in Doc A have Key Ask with leverage
6. Full test suite passes (606+ existing + new audience filtering tests)
</verification>

<success_criteria>
- DocxEngine generates audience-differentiated documents for all 4 doc types
- Orchestrator produces Doc A + Doc B per Tribe (or Doc B only for partial data)
- Zero strategy/leverage content in any Doc B output
- Economic impact integrates hazard context (INTG-01)
- 606+ existing tests pass; 8+ new audience filtering tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-integration/14-03-SUMMARY.md`
</output>
