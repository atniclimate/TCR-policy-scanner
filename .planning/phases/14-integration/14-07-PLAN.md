---
phase: 14-integration
plan: 07
type: execute
wave: 4
depends_on: ["14-05", "14-06"]
files_modified:
  - docs/web/index.html
  - docs/web/js/app.js
  - docs/web/data/tribes.json
  - scripts/build_web_index.py
  - .github/workflows/generate-packets.yml
  - tests/test_web_index.py
autonomous: true

must_haves:
  truths:
    - "GitHub Pages serves documents at /internal/ and /congressional/ URL paths"
    - "Web widget allows document type selection (Doc A, Doc B, or both per Tribe)"
    - "Production URL uses atniclimate.github.io (no placeholder domains)"
    - "Web index includes regional documents accessible by region name"
    - "CI workflow generates all 4 doc types and deploys to Pages"
  artifacts:
    - path: "docs/web/index.html"
      provides: "Updated search widget with doc-type selection and regional docs"
      contains: "atniclimate.github.io"
    - path: "scripts/build_web_index.py"
      provides: "Multi-doc-type index builder"
      contains: "internal"
    - path: ".github/workflows/generate-packets.yml"
      provides: "Updated CI workflow for 4 doc types + Pages deployment"
      contains: "regional"
  key_links:
    - from: "scripts/build_web_index.py"
      to: "docs/web/data/tribes.json"
      via: "Script builds tribes.json with doc-type metadata per Tribe"
      pattern: "tribes.json"
    - from: ".github/workflows/generate-packets.yml"
      to: "docs/web/tribes/"
      via: "Workflow copies packets to docs/web for Pages serving"
      pattern: "docs/web"
---

<objective>
Configure GitHub Pages deployment with production URLs, multi-doc-type web widget, and updated CI workflow.

Purpose: INTG-05 (GitHub Pages deployment config) and INTG-06 (replace SquareSpace placeholder URL). The web widget needs to support the 4-document-type system, the CI workflow needs to generate and deploy all doc types, and all placeholder URLs need to be replaced with the production domain.

Output: Updated web widget with doc-type selection; build_web_index.py supports 4 doc types + regional docs; CI workflow generates all documents; production URLs resolve correctly.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-integration/14-05-SUMMARY.md
@docs/web/index.html
@docs/web/js/app.js
@scripts/build_web_index.py
@.github/workflows/generate-packets.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update web index builder and widget for 4 doc types</name>
  <files>scripts/build_web_index.py, docs/web/index.html, docs/web/js/app.js, docs/web/data/tribes.json, tests/test_web_index.py</files>
  <action>
  Update the web infrastructure to support 4 document types.

  **scripts/build_web_index.py changes:**

  The current script builds `tribes.json` with one entry per Tribe pointing to a single DOCX file. Update to:

  1. Each Tribe entry now has multiple document links:
     ```json
     {
       "tribe_id": "epa_100000001",
       "tribe_name": "Absentee-Shawnee Tribe of Indians of Oklahoma",
       "states": ["OK"],
       "documents": {
         "internal_strategy": "internal/absentee_shawnee_tribe_internal_strategy_fy26.docx",
         "congressional_overview": "congressional/absentee_shawnee_tribe_congressional_overview_fy26.docx"
       },
       "has_complete_data": true
     }
     ```

  2. Add a "regions" section to tribes.json:
     ```json
     {
       "tribes": [...],
       "regions": [
         {
           "region_id": "pnw",
           "region_name": "Pacific Northwest / Columbia River Basin",
           "tribe_count": XX,
           "documents": {
             "internal_strategy": "regional/internal/pnw_intertribal_strategy_fy26.docx",
             "congressional_overview": "regional/congressional/pnw_congressional_overview_fy26.docx"
           }
         }
       ],
       "metadata": {
         "generated_at": "...",
         "total_tribes": 592,
         "doc_a_count": XXX,
         "doc_b_count": XXX,
         "doc_c_count": 8,
         "doc_d_count": 8
       }
     }
     ```

  3. Scan the new output directory structure (internal/, congressional/, regional/) instead of the single flat directory.

  **docs/web/index.html changes:**

  1. Replace any instance of `yourusername.github.io/tcr-policy-scanner/` with `atniclimate.github.io/TCR-policy-scanner/` (INTG-06).

  2. Add document type selection UI:
     - After search, show results with document type options:
       * "Internal Strategy (Confidential)" -> links to Doc A
       * "Congressional Overview" -> links to Doc B
       * "Download Both" -> downloads both files
     - Only show "Internal Strategy" option if `has_complete_data` is true

  3. Add "Regional Documents" section below the Tribe search:
     - List 8 regions with their names
     - Each region has 2 download links: Internal Strategy (Doc C) and Congressional Overview (Doc D)
     - Section header: "Regional Documents"

  4. Update page title and description to remove any "TCR Policy Scanner" references. Use generic descriptive text like "Tribal Climate Resilience Program Priorities" (air gap compliance).

  **docs/web/js/app.js changes:**

  Update the autocomplete result rendering to show document type options:
  - On Tribe selection, show a card with:
    * Tribe name and states
    * Two download buttons: "Internal Strategy" and "Congressional Overview"
    * Or "Congressional Overview" only if `has_complete_data` is false
  - Update download URL construction to point to the correct subdirectory

  Add a region selection handler:
  - When a region is clicked, show its two download options

  **docs/web/ directory structure for deployment:**
  ```
  docs/web/
    index.html
    css/
    js/
    data/tribes.json
    tribes/
      internal/        <- Doc A files
      congressional/   <- Doc B files
      regional/
        internal/      <- Doc C files
        congressional/ <- Doc D files
  ```

  **Update tests/test_web_index.py** to verify:
  - New tribes.json format with documents dict per Tribe
  - Regions section in tribes.json
  - Metadata section with doc counts
  </action>
  <verify>
  1. `python scripts/build_web_index.py` -- runs without error (or runs in test mode with mock data)
  2. `python -m pytest tests/test_web_index.py -v` -- tests pass
  3. Grep docs/web/ for "yourusername" -- zero results (INTG-06)
  4. Grep docs/web/ for "TCR Policy Scanner" -- zero results (air gap)
  5. `python -m pytest tests/ -x -q` -- full suite passes
  </verify>
  <done>Web widget supports 4 doc types with download options; tribes.json includes per-Tribe doc links and regional docs; all placeholder URLs replaced with production URL; air gap clean</done>
</task>

<task type="auto">
  <name>Task 2: Update CI workflow for multi-doc generation and deployment</name>
  <files>.github/workflows/generate-packets.yml</files>
  <action>
  Update the GitHub Actions workflow to handle the new document generation and deployment flow.

  **Current workflow:** Weekly (Sunday 8AM Pacific) or manual trigger.
  1. Runs `python -m src.main --prep-packets --all-tribes`
  2. Runs `python scripts/build_web_index.py`
  3. Copies packets to `docs/web/tribes/`
  4. Commits and pushes

  **Updated workflow:**

  1. **Data population step** (before packet generation):
     ```yaml
     - name: Populate hazard data
       run: |
         python scripts/download_nri_data.py
         python scripts/populate_hazards.py
       continue-on-error: true  # Don't fail if NRI download unavailable
     ```

  2. **Packet generation** (now produces 4 doc types):
     ```yaml
     - name: Generate advocacy packets
       run: python -m src.main --prep-packets --all-tribes
     ```
     This now generates Doc A/B per Tribe + Doc C/D per region.

  3. **Build web index**:
     ```yaml
     - name: Build web index
       run: python scripts/build_web_index.py
     ```

  4. **Validate coverage**:
     ```yaml
     - name: Validate data coverage
       run: python scripts/validate_coverage.py
     ```

  5. **Copy to deployment directory** (updated structure):
     ```yaml
     - name: Deploy to docs/web
       run: |
         mkdir -p docs/web/tribes/internal
         mkdir -p docs/web/tribes/congressional
         mkdir -p docs/web/tribes/regional/internal
         mkdir -p docs/web/tribes/regional/congressional
         cp outputs/packets/internal/*.docx docs/web/tribes/internal/ 2>/dev/null || true
         cp outputs/packets/congressional/*.docx docs/web/tribes/congressional/ 2>/dev/null || true
         cp outputs/packets/regional/internal/*.docx docs/web/tribes/regional/internal/ 2>/dev/null || true
         cp outputs/packets/regional/congressional/*.docx docs/web/tribes/regional/congressional/ 2>/dev/null || true
     ```

  6. **Commit and push** (same as before but with updated paths):
     ```yaml
     - name: Commit and push
       run: |
         git add docs/web/
         git add outputs/coverage_report.md || true
         git diff --staged --quiet || git commit -m "chore: regenerate advocacy packets ($(date +%Y-%m-%d))"
         git push
     ```

  **Additional workflow updates:**
  - Add `workflow_dispatch` inputs for selective generation:
    ```yaml
    on:
      workflow_dispatch:
        inputs:
          skip_data_population:
            description: 'Skip NRI/award data population (use cached)'
            type: boolean
            default: true
          skip_regional:
            description: 'Skip regional document generation'
            type: boolean
            default: false
    ```
  - Update the `schedule` cron if needed (currently weekly, keep weekly)
  - Ensure timeout is at least 30 minutes for the full generation run

  **NOTE on cross-platform:** The workflow runs on Linux (GitHub Actions). The copy commands use Linux paths (forward slashes). The local development environment is Windows. Both should work because python-docx and pathlib handle cross-platform paths. Verify the generate-packets step doesn't have Windows-specific path assumptions.
  </action>
  <verify>
  1. `.github/workflows/generate-packets.yml` syntax is valid: `python -c "import yaml; yaml.safe_load(open('.github/workflows/generate-packets.yml'))"`
  2. Workflow includes: data population, packet generation, web index build, coverage validation, deployment copy, commit
  3. Workflow handles 4 doc types in deployment directory structure
  4. `python -m pytest tests/ -x -q` -- full suite passes
  </verify>
  <done>CI workflow generates all 4 doc types, builds multi-doc web index, validates coverage, and deploys to GitHub Pages with /internal/ and /congressional/ path separation; INTG-05 satisfied</done>
</task>

</tasks>

<verification>
1. Web widget shows doc-type selection for each Tribe (Internal Strategy + Congressional Overview)
2. Regional documents section shows 8 regions with download links
3. Zero instances of "yourusername" or "TCR Policy Scanner" in docs/web/ (INTG-06 + air gap)
4. CI workflow handles full generation + deployment pipeline
5. tribes.json has per-Tribe document links and regional docs section
6. All tests pass
</verification>

<success_criteria>
- GitHub Pages deployment config handles 4 doc types (INTG-05)
- Production URL: atniclimate.github.io/TCR-policy-scanner/ (INTG-06)
- Web widget supports doc-type selection per Tribe + regional docs section
- CI workflow generates, validates, and deploys all document types
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-integration/14-07-SUMMARY.md`
</output>
