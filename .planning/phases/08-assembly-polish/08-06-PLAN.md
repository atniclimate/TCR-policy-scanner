---
phase: 08-assembly-polish
plan: 06
type: execute
wave: 3
depends_on: ["08-03", "08-04", "08-05"]
files_modified:
  - tests/test_e2e_phase8.py
  - README.md
  - .planning/ROADMAP.md
  - .planning/REQUIREMENTS.md
  - .planning/STATE.md
  - .planning/PROJECT.md
autonomous: true

must_haves:
  truths:
    - "E2E test with 3 mock Tribes: batch produces 3 DOCX + strategic overview"
    - "Single Tribe generation produces complete DOCX with all sections (cover, TOC, exec summary, delegation, Hot Sheets, hazard, structural asks, appendix)"
    - "Run same Tribe twice: 'Since Last Packet' section appears in second run"
    - "Web index builder produces valid tribes.json from mock registry + packets"
    - "Multi-state Tribe has correct multi-state delegation"
    - "All 214+ existing tests still pass alongside new tests"
    - "README.md updated with web widget section"
    - "Planning docs updated to mark Phase 8 complete"
  artifacts:
    - path: "tests/test_e2e_phase8.py"
      provides: "8+ E2E tests covering batch, single, change tracking, web index, multi-state"
      min_lines: 100
    - path: "README.md"
      provides: "Web widget section with SquareSpace embed instructions added"
      contains: "Web Distribution"
    - path: ".planning/ROADMAP.md"
      provides: "Phase 8 plans 08-01 through 08-06 marked complete"
      contains: "08-06"
    - path: ".planning/REQUIREMENTS.md"
      provides: "DOC-05, DOC-06, OPS-01, OPS-02, OPS-03, WEB-01, WEB-02, WEB-03 marked complete"
      contains: "WEB-03"
    - path: ".planning/STATE.md"
      provides: "Phase 8 complete, v1.1 milestone finished"
      contains: "v1.1"
    - path: ".planning/PROJECT.md"
      provides: "Web widget in scope, AF-05 supersession documented"
      contains: "AF-05"
  key_links:
    - from: "tests/test_e2e_phase8.py"
      to: "src/packets/orchestrator.py"
      via: "Tests run_all_tribes() and run_single_tribe() end-to-end with mock data"
      pattern: "PacketOrchestrator"
    - from: "tests/test_e2e_phase8.py"
      to: "scripts/build_web_index.py"
      via: "Tests build_index() produces valid tribes.json from mock registry + packets"
      pattern: "build_index"
    - from: "tests/test_e2e_phase8.py"
      to: "src/packets/change_tracker.py"
      via: "Tests change detection across two generations for same Tribe"
      pattern: "PacketChangeTracker"
---

<objective>
Verify the complete Phase 8 pipeline end-to-end and finalize all project documentation -- confirming that batch generation, single-Tribe generation, change tracking, and web index all work together correctly.

Purpose: This plan is the final verification gate for v1.1. It proves that all Phase 8 components integrate correctly and updates all planning docs to reflect completion. After this plan, TCR Policy Scanner v1.1 is complete and ready for production use.
Output: E2E test suite, updated README, and all planning docs marked complete.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/08-assembly-polish/08-CONTEXT.md
@.planning/phases/08-assembly-polish/08-MASTER-PROMPT.md
@.planning/phases/08-assembly-polish/08-01-SUMMARY.md
@.planning/phases/08-assembly-polish/08-02-SUMMARY.md
@.planning/phases/08-assembly-polish/08-03-SUMMARY.md
@.planning/phases/08-assembly-polish/08-04-SUMMARY.md
@.planning/phases/08-assembly-polish/08-05-SUMMARY.md

@src/packets/orchestrator.py
@src/packets/docx_engine.py
@src/packets/docx_sections.py
@src/packets/change_tracker.py
@src/packets/strategic_overview.py
@scripts/build_web_index.py
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests/test_e2e_phase8.py</name>
  <files>tests/test_e2e_phase8.py</files>
  <action>
**Create `tests/test_e2e_phase8.py`** with comprehensive E2E tests:

**Shared fixtures:**

```python
"""End-to-end integration tests for Phase 8 -- complete pipeline verification."""

import json
from pathlib import Path

import pytest

def _write_json(path: Path, data) -> None:
    """Write JSON data to a file with UTF-8 encoding."""
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        json.dump(data, f)
```

**Fixture: `phase8_env(tmp_path)`** -- sets up complete mock environment for 3 Tribes:
- tribal_registry.json with 3 Tribes:
  - epa_001: "Alpha Tribe", states=["WA"], ecoregion="Pacific Northwest"
  - epa_002: "Beta Nation", states=["OR", "WA", "ID"], ecoregion="Pacific Northwest" (multi-state)
  - epa_003: "Gamma Band", states=["AZ"], ecoregion="Southwest"
- program_inventory.json with 4+ programs (bia_tcr, fema_bric, epa_gap, doe_indian_energy)
- ecoregion_config.json with Pacific Northwest and Southwest entries
- congressional_cache.json with mock senators/reps for WA, OR, ID, AZ
- award_cache/ with epa_001.json (2 awards), epa_002.json (1 award), epa_003.json (empty)
- hazard_profiles/ with epa_001.json (wildfire + flooding), epa_002.json (drought), epa_003.json (heat wave)
- graph_schema.json with 5 structural asks
- policy_tracking.json with FY26 positions
- scanner_config.json pointing to all tmp_path locations with packets.docx.enabled=True
- data/packet_state/ directory (empty, for change tracking)

**Tests:**

1. **test_batch_produces_3_docx_plus_overview(phase8_env)**
   - Create PacketOrchestrator with phase8_env config
   - Call run_all_tribes()
   - Assert 3 .docx files exist in output dir (one per Tribe)
   - Assert STRATEGIC-OVERVIEW.docx exists
   - Assert return dict has success=3, errors=0, total=3

2. **test_single_tribe_complete_document(phase8_env)**
   - Create PacketOrchestrator, call run_single_tribe("Alpha Tribe")
   - Open generated .docx with python-docx Document()
   - Collect all paragraph text
   - Assert "Alpha Tribe" appears (cover page)
   - Assert at least one program name appears (Hot Sheets)
   - Assert "Appendix" or "Additional Programs" appears (appendix)
   - Assert "Congressional Delegation" or senator/rep name appears (delegation)
   - Assert "Executive Summary" appears
   - Assert "Hazard" appears (hazard summary)
   - Assert "Structural" appears (structural asks)

3. **test_change_tracking_second_run(phase8_env)**
   - Create PacketOrchestrator, call generate_packet("Alpha Tribe") twice
   - After second generation, open .docx with python-docx
   - Assert "Since Last Packet" appears in paragraph text
   - Verify packet_state/epa_001.json exists with valid schema

4. **test_web_index_from_mock_data(phase8_env)**
   - Import build_index from scripts.build_web_index
   - Call build_index() with phase8_env registry and output dir
   - Assert tribes.json has 3 Tribes
   - Assert Tribes with generated packets have has_packet=True

5. **test_multi_state_delegation(phase8_env)**
   - Create PacketOrchestrator, call run_single_tribe("Beta Nation")
   - Open generated .docx with python-docx
   - Collect all paragraph text
   - Assert delegation content includes representatives from multiple states (OR, WA, ID)

6. **test_zero_award_tribe_valid_packet(phase8_env)**
   - Create PacketOrchestrator, call run_single_tribe("Gamma Band")
   - Assert .docx file exists and python-docx can read it
   - Assert paragraphs contain "First-Time" or benchmark language

7. **test_batch_error_isolation(phase8_env)**
   - Modify one Tribe's hazard file to be corrupt JSON
   - Call run_all_tribes()
   - Assert result has errors=1, success=2 (batch continues despite one failure)

8. **test_docx_reopens_without_error(phase8_env)**
   - Generate packet for each Tribe
   - For each .docx, open with Document(str(path)) -- assert no exception
   - Assert each document has at least 10 paragraphs

**Critical notes:**
- Use tmp_path for ALL file I/O (no writes to real project dirs)
- Import PacketOrchestrator and build_index inside test functions or fixture scope
- Each test can share phase8_env fixture (it creates fresh dirs per test via tmp_path)
- Re-read generated .docx with `from docx import Document; doc = Document(str(path))`
- Do NOT modify any existing test files (keep all 214+ tests untouched)
- Handle the case where PacketOrchestrator.__init__ expects specific config structure
  </action>
  <verify>
Run: `python -m pytest tests/test_e2e_phase8.py -v --tb=short` -- all 8 tests pass
Run: `python -m pytest tests/ --tb=short` -- full suite passes (214+ existing + ~80 new from Phase 8 = ~294 total)
  </verify>
  <done>8 E2E tests verifying complete Phase 8 pipeline: batch generation, single Tribe, change tracking, web index, multi-state delegation, zero-award handling, error isolation, and DOCX validity.</done>
</task>

<task type="auto">
  <name>Task 2: Update README.md</name>
  <files>README.md</files>
  <action>
**Update README.md** -- add Web Distribution section after the existing features/usage sections:

Add a new section:

```markdown
## Web Distribution

TCR Policy Scanner includes a lightweight search widget for discovering and downloading
Tribal advocacy packets. The widget is hosted on GitHub Pages and can be embedded in
any website via iframe.

### Search Widget

The widget at `docs/web/` provides:
- Autocomplete search across all 592 Tribal Nations
- Info card showing Tribe name, state(s), and ecoregion
- Direct DOCX download for generated advocacy packets
- Strategic overview download
- Mobile-responsive, WCAG 2.1 AA accessible

### SquareSpace Embed

To embed the widget in a SquareSpace page, add a Code block with:

\```html
<div style="width:100%;max-width:800px;margin:0 auto;">
  <iframe
    src="https://atniclimate.github.io/TCR-policy-scanner/"
    width="100%" height="700" frameborder="0"
    style="border:1px solid #e0e0e0;border-radius:8px;"
    title="TCR Policy Scanner - Tribal Advocacy Packet Search"
    loading="lazy">
  </iframe>
</div>
\```

### Automated Generation

A GitHub Actions workflow generates packets weekly (Sunday 8AM Pacific) and on manual
trigger. The workflow runs `--prep-packets --all-tribes`, builds the web index, and
commits updated packets to `docs/web/tribes/`.
```

Also update the feature list (if one exists) to include Phase 8 capabilities:
- Full per-Tribe DOCX advocacy packets (Document 1) with executive summary, delegation, Hot Sheets, hazard profile, structural asks, change tracking
- Shared strategic overview (Document 2) with appropriations landscape, ecoregion priorities, FEMA analysis
- Batch generation for all 592 Tribes with memory management
- Change tracking ("Since Last Packet" section)
- GitHub Pages search widget with SquareSpace iframe embed

**Critical notes:**
- Read README.md first to understand existing structure
- Add the new section in a logical place (after usage/features, before development/contributing)
- Do NOT remove or modify any existing README content
- Use proper markdown formatting
  </action>
  <verify>
Verify README.md contains "Web Distribution" section: grep for "Web Distribution" in README.md
  </verify>
  <done>README.md updated with Web Distribution section including widget description, SquareSpace embed code, and automated generation details.</done>
</task>

<task type="auto">
  <name>Task 3: Update planning docs</name>
  <files>.planning/ROADMAP.md, .planning/REQUIREMENTS.md, .planning/STATE.md, .planning/PROJECT.md</files>
  <action>
**Update `.planning/ROADMAP.md`** -- mark all 6 Phase 8 plans complete:

Read ROADMAP.md first, then add/update the Phase 8 section:

```markdown
### Phase 8: Assembly, Polish, and Web Distribution
- [x] 08-01: Document 1 Full Assembly (DOC-05)
- [x] 08-02: Document 2 Strategic Overview (DOC-06)
- [x] 08-03: Batch & Ad-hoc CLI (OPS-01, OPS-02)
- [x] 08-04: Change Tracking (OPS-03)
- [x] 08-05: GitHub Pages Widget + Actions Workflow (WEB-01, WEB-02, WEB-03)
- [x] 08-06: E2E Integration Testing + Documentation
```

**Update `.planning/REQUIREMENTS.md`** -- mark 8 requirements complete:

Read REQUIREMENTS.md first, then update these requirements to show completion:
- DOC-05: Document 1 full assembly -- COMPLETE
- DOC-06: Document 2 strategic overview -- COMPLETE
- OPS-01: Batch generation CLI -- COMPLETE
- OPS-02: Ad-hoc single-Tribe CLI -- COMPLETE
- OPS-03: Change tracking -- COMPLETE
- WEB-01: GitHub Pages search widget -- COMPLETE
- WEB-02: GitHub Actions workflow -- COMPLETE
- WEB-03: SquareSpace iframe embed -- COMPLETE

Add WEB-01, WEB-02, WEB-03 if not already present:
- WEB-01: Self-contained HTML/CSS/JS search widget with autocomplete, info card, DOCX download
- WEB-02: GitHub Actions workflow for automated weekly packet generation and web index build
- WEB-03: SquareSpace iframe embed code with responsive container and accessibility attributes

Update AF-05 anti-feature:
- AF-05: "No web UI or frontend dashboard" -- SUPERSEDED: Lightweight static search+download widget added (not a dashboard or editing UI). Pre-generated DOCX files served from GitHub Pages.

**Update `.planning/STATE.md`** -- Phase 8 complete, v1.1 finished:

Read STATE.md first, then update:
- Current phase: Phase 8 -- COMPLETE
- Milestone: v1.1 complete
- Total plans: 19 (11 from v1.1 Phases 5-7 + 6 from Phase 8 + 2 from v1.0 context)
- Total requirements: all v1.1 requirements complete (DOC-01 through DOC-06, ECON-01, OPS-01 through OPS-03, WEB-01 through WEB-03)
- Total tests: ~294 (214 existing + ~80 new from Phase 8)
- Note: All 8 phases complete. v1.1 ready for production use.

**Update `.planning/PROJECT.md`** -- web widget in scope, AF-05 updated:

Read PROJECT.md first, then:
- Add web widget to the "In Scope" section: "Lightweight static search+download widget via GitHub Pages for Tribal advocacy packet discovery and download"
- Update AF-05 in anti-features: Mark as SUPERSEDED with explanation that the widget is a static file server, not a dashboard or editing UI

**Critical notes:**
- Read each file FIRST before editing (preserve existing content)
- Only add/modify the specific sections mentioned -- do not restructure existing content
- Use consistent formatting with the rest of each file
- Dates should use 2026-02-10 format
  </action>
  <verify>
Verify ROADMAP.md: grep for "08-06" -- present and marked complete
Verify REQUIREMENTS.md: grep for "WEB-03" -- present and marked complete
Verify STATE.md: grep for "v1.1" -- present with "complete" status
Verify PROJECT.md: grep for "AF-05" -- present with "SUPERSEDED" note
  </verify>
  <done>All planning docs updated: ROADMAP shows 6 Phase 8 plans complete, REQUIREMENTS shows DOC-05/06 + OPS-01/02/03 + WEB-01/02/03 complete, STATE shows v1.1 finished, PROJECT has web widget in scope and AF-05 superseded.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_e2e_phase8.py -v` -- all 8 E2E tests pass
2. `python -m pytest tests/ -v --tb=short` -- full suite passes (~294 total tests, all passing)
3. README.md contains "Web Distribution" section with SquareSpace embed code
4. ROADMAP.md has Phase 8 plans 08-01 through 08-06 all marked [x] complete
5. REQUIREMENTS.md has DOC-05, DOC-06, OPS-01, OPS-02, OPS-03, WEB-01, WEB-02, WEB-03 marked complete
6. STATE.md shows Phase 8 complete, v1.1 milestone finished
7. PROJECT.md has web widget in scope and AF-05 marked SUPERSEDED
</verification>

<success_criteria>
- 8 E2E tests verify the complete Phase 8 pipeline end-to-end
- Batch generation with 3 mock Tribes produces 3 DOCX + strategic overview
- Single Tribe generation produces complete DOCX with all 8 document sections
- Change tracking produces "Since Last Packet" section on second generation
- Web index builder produces valid tribes.json from generated packets
- Multi-state Tribe has correct multi-state congressional delegation
- Error isolation: one failed Tribe does not halt batch
- All 214+ existing tests pass alongside ~80 new Phase 8 tests (~294 total)
- README.md updated with web widget and SquareSpace embed documentation
- All 4 planning docs updated consistently to reflect Phase 8 and v1.1 completion
</success_criteria>

<output>
After completion, create `.planning/phases/08-assembly-polish/08-06-SUMMARY.md`
</output>
