---
phase: 07-computation-docx
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/packets/docx_styles.py
  - src/packets/docx_engine.py
  - tests/test_docx_styles.py
autonomous: true

must_haves:
  truths:
    - "StyleManager programmatically creates all custom paragraph and character styles on a fresh Document"
    - "Six CI status values map to correct RGB colors: FLAGGED/AT_RISK=red, UNCERTAIN/STABLE_BUT_VULNERABLE=amber, STABLE/SECURE=green"
    - "set_cell_shading() creates a FRESH OxmlElement per cell (not reused)"
    - "apply_zebra_stripe() alternates row colors on any table"
    - "add_status_badge() writes colored Unicode circle plus styled text to a paragraph"
    - "DocxEngine creates a Document, applies StyleManager, and saves a valid .docx to disk"
    - "Style name collision is handled gracefully (no ValueError on re-creation)"
  artifacts:
    - path: "src/packets/docx_styles.py"
      provides: "StyleManager, set_cell_shading, apply_zebra_stripe, add_status_badge, CI_STATUS_COLORS"
      min_lines: 100
    - path: "src/packets/docx_engine.py"
      provides: "DocxEngine with create_document() and save()"
      min_lines: 60
    - path: "tests/test_docx_styles.py"
      provides: "Unit tests for styles, cell shading, status badges, and engine skeleton"
      min_lines: 120
  key_links:
    - from: "src/packets/docx_engine.py"
      to: "src/packets/docx_styles.py"
      via: "DocxEngine.__init__ creates StyleManager"
      pattern: "StyleManager"
    - from: "src/packets/docx_styles.py"
      to: "docx.oxml"
      via: "OxmlElement for cell shading"
      pattern: "OxmlElement"
---

<objective>
Build the DOCX styling foundation and engine skeleton -- the rendering infrastructure that all document sections depend on.

Purpose: DOC-01 requires programmatic DOCX construction with professional formatting. This plan delivers the StyleManager (all custom styles), helper functions (cell shading, zebra striping, status badges), and a DocxEngine skeleton that creates and saves styled documents.
Output: Two new modules (docx_styles.py, docx_engine.py) with unit tests.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-computation-docx/07-RESEARCH.md

@src/packets/context.py
@tests/test_packets.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StyleManager and DOCX helper functions</name>
  <files>src/packets/docx_styles.py</files>
  <action>
Create `src/packets/docx_styles.py` with these components:

**Imports:**
```python
from docx import Document
from docx.shared import Pt, Inches, RGBColor
from docx.enum.style import WD_STYLE_TYPE
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml.ns import qn
from docx.oxml import OxmlElement
```

**Constants:**
- `CI_STATUS_COLORS`: dict mapping all 6 CI status strings to RGBColor:
  - "FLAGGED" -> RGBColor(0xDC, 0x26, 0x26) (red)
  - "AT_RISK" -> RGBColor(0xDC, 0x26, 0x26) (red)
  - "UNCERTAIN" -> RGBColor(0xF5, 0x9E, 0x0B) (amber)
  - "STABLE_BUT_VULNERABLE" -> RGBColor(0xF5, 0x9E, 0x0B) (amber)
  - "STABLE" -> RGBColor(0x16, 0xA3, 0x4A) (green)
  - "SECURE" -> RGBColor(0x16, 0xA3, 0x4A) (green)

- `CI_STATUS_LABELS`: dict mapping CI status to human-readable framing labels:
  - "FLAGGED" -> "Flagged -- Requires Specialist Attention"
  - "AT_RISK" -> "At Risk"
  - "UNCERTAIN" -> "Uncertain"
  - "STABLE_BUT_VULNERABLE" -> "Stable but Vulnerable"
  - "STABLE" -> "Stable"
  - "SECURE" -> "Secure"

- `COLORS`: namespace dict for palette:
  - primary_dark = RGBColor(0x1A, 0x23, 0x7E) (navy blue)
  - heading = RGBColor(0x37, 0x41, 0x51) (dark gray)
  - body_text = RGBColor(0x1F, 0x29, 0x37)
  - muted = RGBColor(0x6B, 0x72, 0x80)
  - table_header_bg = "1A237E" (hex string for shading)
  - table_stripe_even = "F2F2F2"
  - table_stripe_odd = "FFFFFF"
  - callout_bg = "EEF2FF" (light blue for Key Ask callout)

**Helper functions (module-level):**
- `set_cell_shading(cell, color_hex: str) -> None`: Set background color on a table cell via OxmlElement('w:shd'). MUST create a NEW OxmlElement for each call (not reuse). Use `tc = cell._tc; tcPr = tc.get_or_add_tcPr(); shading = OxmlElement('w:shd'); shading.set(qn('w:fill'), color_hex); shading.set(qn('w:val'), 'clear'); tcPr.append(shading)`.

- `apply_zebra_stripe(table, header_rows: int = 1) -> None`: Apply alternating row colors. Skip header_rows, then alternate COLORS.table_stripe_even / table_stripe_odd.

- `add_status_badge(paragraph, ci_status: str) -> None`: Add colored Unicode circle (U+25CF) and styled status text to a paragraph. Use CI_STATUS_COLORS for color, CI_STATUS_LABELS for label text. First run: colored circle (Pt(14)), second run: bold colored status label (Pt(11)).

- `format_header_row(table, headers: list[str]) -> None`: Style the first row of a table as a header: dark background (table_header_bg), white bold Arial 9pt text.

**Class StyleManager:**
- `__init__(self, document: Document)`: Store document reference, call `_create_styles()`.
- `_create_styles(self)`: Create all custom styles. MUST check `if name not in [s.name for s in self.doc.styles]` before adding (prevents ValueError on duplicate).

Styles to create (all Arial font family):
  - "HS Title": Paragraph, 18pt, bold, primary_dark, space_after=6pt
  - "HS Subtitle": Paragraph, 12pt, heading color, space_after=4pt
  - "HS Section": Paragraph, 12pt, bold, heading color, space_before=12pt, space_after=4pt
  - "HS Body": Paragraph, 10pt, body_text color, space_after=4pt
  - "HS Small": Paragraph, 8pt, muted color, space_after=2pt (for footnotes)
  - "HS Callout": Paragraph, 10pt, bold, body_text, left_indent=0.3in, space_before=8pt
  - "HS Callout Detail": Paragraph, 10pt, body_text, left_indent=0.3in, space_after=2pt

Also override built-in heading styles (Heading 1-3) to use Arial:
  - Heading 1: Arial, 16pt, bold, primary_dark
  - Heading 2: Arial, 14pt, bold, heading
  - Heading 3: Arial, 12pt, bold, heading

**Critical implementation notes:**
- Style name check: `existing_names = {s.name for s in self.doc.styles}` before the loop, check `if name not in existing_names`.
- All font assignments: `style.font.name = 'Arial'` (python-docx embeds the name; Word handles fallback)
- Do NOT use `from __future__ import annotations` -- keep runtime type hints
- Module-level logger: `logger = logging.getLogger("tcr_scanner.packets.docx_styles")`
  </action>
  <verify>
Run: `python -c "from src.packets.docx_styles import StyleManager, set_cell_shading, add_status_badge, CI_STATUS_COLORS"` -- imports work
  </verify>
  <done>StyleManager creates all custom styles without errors. set_cell_shading(), apply_zebra_stripe(), and add_status_badge() helper functions work correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create DocxEngine skeleton and all tests</name>
  <files>src/packets/docx_engine.py, tests/test_docx_styles.py</files>
  <action>
**Create `src/packets/docx_engine.py`** with:

```python
"""DocxEngine -- assembles complete per-Tribe advocacy packet DOCX documents.

Creates a python-docx Document with programmatic styles, delegates section
rendering to specialized renderers, and saves to the output directory.
"""
```

**Class DocxEngine:**
- `__init__(self, config: dict, programs: dict[str, dict])`: Store config, programs. Read output_dir from config["packets"].get("output_dir", "outputs/packets"). Create output_dir if missing.

- `create_document(self) -> tuple[Document, StyleManager]`: Create fresh Document, apply StyleManager, configure page margins (1 inch all sides), set default section header/footer. Return (document, style_manager).

- `_setup_header_footer(self, document: Document) -> None`: Configure header with "TCR Policy Scanner | Tribal Advocacy Packet" (Arial 8pt, muted color). Configure footer with "CONFIDENTIAL | Generated by TCR Policy Scanner" (Arial 7pt, muted, centered). Set `is_linked_to_previous = False`.

- `save(self, document: Document, tribe_id: str) -> Path`: Save document to `{output_dir}/{tribe_id}.docx`. Use atomic write pattern: save to tmp file first, then os.replace(). Return the output path. Log the save.

- `generate(self, context, relevant_programs, economic_summary, structural_asks) -> Path`: (STUB for now -- will be completed in Plan 07-04). Just create document, save, return path. Add a `# TODO: Plan 07-04 will complete this with section assembly` comment.

**Critical notes:**
- Import from docx_styles: `from src.packets.docx_styles import StyleManager`
- Use `encoding="utf-8"` on any file I/O (though .docx save uses python-docx's binary write)
- Use `datetime.now(timezone.utc)` for timestamps
- Atomic save: `import tempfile, os; tmp = tempfile.NamedTemporaryFile(dir=output_dir, suffix='.docx', delete=False); document.save(tmp.name); tmp.close(); os.replace(tmp.name, str(output_path))`
- Log via `logger = logging.getLogger("tcr_scanner.packets.docx_engine")`
- Output directory: `Path(config.get("packets", {}).get("output_dir", "outputs/packets"))`

**Then create `tests/test_docx_styles.py`** with comprehensive tests:

Style tests:
- test_style_manager_creates_styles: All expected style names exist after StyleManager init
- test_style_manager_idempotent: Calling StyleManager twice on same document does not raise ValueError
- test_heading_styles_arial: Built-in Heading 1-3 styles have font.name == "Arial"
- test_custom_style_properties: HS Title is 18pt bold, HS Body is 10pt, HS Small is 8pt

Helper function tests:
- test_set_cell_shading: Cell background has correct fill color in XML
- test_set_cell_shading_fresh_element: Shading two cells both get correct colors (not just last one)
- test_apply_zebra_stripe: Even/odd rows get different shading colors
- test_apply_zebra_stripe_skips_header: First row is not striped
- test_add_status_badge_colors: Each CI status produces correct color
- test_add_status_badge_all_statuses: All 6 CI status values render without error
- test_format_header_row: Header cells have dark background and white text

Engine skeleton tests:
- test_engine_create_document: Returns (Document, StyleManager) tuple
- test_engine_save_creates_file: Saving produces a .docx file on disk (use tmp_path)
- test_engine_save_atomic: File exists after save (verify atomic pattern works)
- test_engine_header_footer: Document sections have header/footer text
- test_engine_output_dir_created: Output directory created if missing (use tmp_path)

All tests use `tmp_path` fixture for output files. No network access.
Run full suite at the end: `python -m pytest tests/ -v --tb=short` to verify no regressions.
  </action>
  <verify>
Run: `python -m pytest tests/test_docx_styles.py -v --tb=short` -- all new tests pass
Run: `python -m pytest tests/ --tb=short` -- full suite passes with no regressions
  </verify>
  <done>StyleManager creates all styles programmatically. DocxEngine creates, styles, and saves .docx files. All helper functions work. All tests pass with no regressions to 106 existing tests.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.packets.docx_styles import StyleManager, CI_STATUS_COLORS, set_cell_shading, add_status_badge"` -- imports work
2. `python -c "from src.packets.docx_engine import DocxEngine"` -- imports work
3. `python -m pytest tests/test_docx_styles.py -v` -- all new tests pass
4. `python -m pytest tests/ --tb=short` -- full suite passes with no regressions
5. Manual: `python -c "from docx import Document; from src.packets.docx_styles import StyleManager; d = Document(); sm = StyleManager(d); d.save('test_output.docx'); print('OK')"` -- creates a valid .docx file
</verification>

<success_criteria>
- StyleManager creates all custom styles on a fresh Document without errors
- Calling StyleManager twice on the same Document does not raise ValueError
- set_cell_shading() uses a fresh OxmlElement per cell call
- add_status_badge() renders colored circle + label for all 6 CI statuses
- DocxEngine.save() writes a valid .docx file via atomic write pattern
- All tests pass with no regressions to 106 existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-computation-docx/07-02-SUMMARY.md`
</output>
