---
phase: 15-congressional-intelligence
plan: 05
type: execute
wave: 3
depends_on: [15-01, 15-04]
files_modified:
  - src/packets/docx_sections.py
  - src/packets/docx_engine.py
  - src/packets/docx_regional_sections.py
  - src/packets/orchestrator.py
autonomous: true

must_haves:
  truths:
    - "render_bill_intelligence_section() renders congressional bill content with audience differentiation: Doc A has full briefing with talking points/timing for top bills; Doc B has facts only, zero strategy; Doc C/D have regional aggregation"
    - "DocxEngine.generate() inserts bill intelligence section BEFORE delegation section (bills-first ordering per CONTEXT.md)"
    - "Every section with congressional data displays a confidence indicator badge (HIGH/MEDIUM/LOW) -- zero numeric scores appear in rendered DOCX"
    - "PacketOrchestrator loads congressional_intel.json and filters bills per-Tribe based on state, programs, and delegation matches"
    - "Enhanced delegation section shows committee assignments and bill sponsorship activity alongside existing representative/senator data"
  artifacts:
    - path: "src/packets/docx_sections.py"
      provides: "render_bill_intelligence_section and enhanced render_delegation_section"
      contains: "render_bill_intelligence_section"
    - path: "src/packets/docx_engine.py"
      provides: "Updated section ordering with bill intelligence before delegation"
      contains: "render_bill_intelligence_section"
    - path: "src/packets/docx_regional_sections.py"
      provides: "Regional congressional aggregation for Doc C/D"
      contains: "congressional"
    - path: "src/packets/orchestrator.py"
      provides: "Congressional intel loading and per-Tribe filtering"
      contains: "congressional_intel"
  key_links:
    - from: "src/packets/orchestrator.py"
      to: "data/congressional_intel.json"
      via: "Loads and caches bill intelligence on first access"
    - from: "src/packets/orchestrator.py"
      to: "src/packets/context.py"
      via: "Populates congressional_intel field in TribePacketContext"
    - from: "src/packets/docx_engine.py"
      to: "src/packets/docx_sections.py"
      via: "Calls render_bill_intelligence_section between exec summary and delegation"
    - from: "src/packets/docx_sections.py"
      to: "src/packets/confidence.py"
      via: "Calls confidence_level() for section badges"
---

<objective>
Build the DOCX rendering pipeline for congressional intelligence: bill section renderer with audience differentiation, updated section ordering (bills before delegation), orchestrator wiring to load congressional_intel.json and populate TribePacketContext, and regional section support for Doc C/D.

Purpose: INTEL-07 (DOCX renderers for all 4 doc types) is the primary user-facing deliverable -- this is where Tribal Leaders see congressional intelligence in their advocacy packets.

Output: 4 modified files completing the data pipeline from congressional_intel.json through context building through DOCX rendering.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-congressional-intelligence/15-RESEARCH.md
@.planning/phases/15-congressional-intelligence/15-CONTEXT.md
@.planning/phases/15-congressional-intelligence/15-01-SUMMARY.md
@.planning/phases/15-congressional-intelligence/15-04-SUMMARY.md
@src/packets/docx_sections.py
@src/packets/docx_engine.py
@src/packets/docx_regional_sections.py
@src/packets/orchestrator.py
@src/packets/context.py
@src/packets/confidence.py
@src/packets/doc_types.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bill intelligence section renderer and enhance delegation section</name>
  <files>src/packets/docx_sections.py</files>
  <action>
Add a new function `render_bill_intelligence_section()` to docx_sections.py. Follow the exact same function signature pattern as existing renderers (document, context, style_manager, doc_type_config).

```python
def render_bill_intelligence_section(
    document: Document,
    context: TribePacketContext,
    style_manager: StyleManager,
    doc_type_config: DocumentTypeConfig | None = None,
) -> None:
    """Render the congressional bill intelligence section.

    Per 15-CONTEXT.md decisions:
    - Doc A: Top 2-3 bills get full briefing (8-10 lines each) with talking
      points and timing guidance; remaining bills get compact card format
      (3-4 lines). Bills-first ordering (appears before delegation).
    - Doc B: Curated subset only -- bills directly tied to Tribe's tracked
      programs. Facts only. Zero strategy, zero talking points, zero timing.
    - Doc C/D: Regional aggregation handled by docx_regional_sections.py.

    Confidence badge (HIGH/MEDIUM/LOW) displayed after section heading.
    Zero numeric scores appear in rendered document.
    """
```

Implementation details:

1. **Import** `from src.packets.confidence import confidence_level, section_confidence`

2. **Section heading**: "Legislation Affecting Your Programs" (Doc A) or "Relevant Legislation" (Doc B). Add confidence badge in gray text after heading: `[HIGH]`, `[MEDIUM]`, or `[LOW]`.

3. **Get bills from context**: `bills = context.congressional_intel.get("bills", [])`. If empty, render a brief "No tracked legislation identified in the current session" note and return.

4. **Sort bills by relevance_score descending**.

5. **Doc A rendering** (`dtc is None or dtc.is_internal`):
   - Top 2-3 bills (by relevance_score) get FULL BRIEFING format:
     - Bold bill number + title as subheading
     - Status line (latest action date + text)
     - Sponsor + cosponsor count
     - Committee referral
     - Affected programs (from matched_programs list)
     - Talking points (2-3 bullet points derived from bill subjects + program relevance)
     - Timing/urgency note (based on latest action recency)
   - Remaining bills get COMPACT CARD format:
     - Bill number + title (bold)
     - Status + affected programs (single line)
     - 1-sentence impact summary

6. **Doc B rendering** (`dtc is not None and dtc.is_congressional`):
   - Filter to bills directly matched to Tribe's tracked programs only (relevance_score >= 0.5)
   - For each bill, render facts only:
     - Bill number + title
     - Status (latest action)
     - Sponsor name
     - Affected programs
   - ZERO: talking points, timing, strategy, recommendations, urgency language
   - Check: words "strategic", "leverage", "recommend", "talking point", "timing", "urgency" must NOT appear in Doc B output

7. **Confidence badge**: After the section heading, add a run with `[HIGH]` / `[MEDIUM]` / `[LOW]` in Pt(8) gray font. Compute from `section_confidence("congress_gov", context.congressional_intel.get("scan_date", ""))`.

Also **enhance render_delegation_section()** to show:
- Existing senator/representative data (unchanged)
- NEW: Committee assignments relevant to Tribal affairs (SLIA, HSII, etc.)
- NEW: Bill sponsorship activity -- if a delegation member sponsored/cosponsored a tracked bill, note it
- Pull committee and sponsorship data from `context.congressional_intel.get("delegation_activity", {})`
  </action>
  <verify>
1. `render_bill_intelligence_section` exists in docx_sections.py
2. Function handles both Doc A (internal with talking points) and Doc B (congressional, facts only)
3. Confidence badge rendering uses confidence_level() not numeric scores
4. No strategy/leverage/recommend words in Doc B rendering paths
5. Enhanced delegation section references committee assignments
  </verify>
  <done>Bill intelligence section renderer differentiates Doc A (full briefing + talking points) vs Doc B (facts only); confidence badges display HIGH/MEDIUM/LOW; delegation section enhanced with committee and sponsorship data.</done>
</task>

<task type="auto">
  <name>Task 2: Update DocxEngine ordering + orchestrator wiring + regional sections</name>
  <files>src/packets/docx_engine.py, src/packets/orchestrator.py, src/packets/docx_regional_sections.py</files>
  <action>
**A) DocxEngine.generate() section reordering (docx_engine.py):**

1. Add import: `from src.packets.docx_sections import render_bill_intelligence_section`
2. In generate(), insert bill intelligence section AFTER executive summary and BEFORE delegation:

```python
# 3. Executive summary (existing)

# 4. Bill intelligence (NEW -- bills-first per CONTEXT.md)
render_bill_intelligence_section(
    document, context, style_manager, doc_type_config=dtc
)

# 5. Congressional delegation (was section 4, now section 5)
render_delegation_section(...)
```

Renumber comments for remaining sections (Hot Sheets becomes 6, etc.).

**B) PacketOrchestrator wiring (orchestrator.py):**

Add congressional intel loading to the orchestrator. Find the method that builds TribePacketContext (likely `prepare_context()` or `_build_context()`):

1. Add a lazy-loaded `_congressional_intel` cache attribute (dict, loaded once from data/congressional_intel.json).
2. In the context-building method, after loading delegation data:
   ```python
   # Load congressional intel (lazy, shared across all Tribes)
   if self._congressional_intel is None:
       self._load_congressional_intel()

   # Filter bills relevant to this Tribe
   tribe_bills = self._filter_bills_for_tribe(
       self._congressional_intel.get("bills", []),
       context.states, context.tribe_id,
   )

   context.congressional_intel = {
       "bills": tribe_bills,
       "scan_date": self._congressional_intel.get("metadata", {}).get("generated_at", ""),
       "confidence": section_confidence("congress_gov", self._congressional_intel.get("metadata", {}).get("generated_at", "")),
       "delegation_activity": self._get_delegation_activity(tribe_bills, context),
   }
   ```

3. Add `_load_congressional_intel()` method:
   - Read data/congressional_intel.json with encoding="utf-8"
   - File size check (< 10MB per security patterns)
   - Handle missing file gracefully (log WARNING, set empty dict)

4. Add `_filter_bills_for_tribe()` method:
   - Include bills whose matched_programs overlap with the Tribe's relevant programs
   - Include bills whose sponsor/cosponsors include the Tribe's delegation members
   - Include bills affecting the Tribe's state
   - Return sorted by relevance_score descending

5. Add `_get_delegation_activity()` method:
   - Cross-reference tribe_bills with context.senators and context.representatives
   - Return dict of {bioguide_id: {"sponsored": [...], "cosponsored": [...]}}

Import `from src.packets.confidence import section_confidence` at the top.

**C) Regional sections (docx_regional_sections.py):**

Add a congressional aggregation function for Doc C/D. Find the existing regional section rendering patterns and add:

```python
def render_regional_congressional_section(
    document: Document,
    region_context: dict,
    style_manager: StyleManager,
    doc_type_config: DocumentTypeConfig | None = None,
) -> None:
    """Render aggregated congressional intelligence for a region.

    Strategy: Show bills shared across multiple Tribes in the region,
    with per-state breakdown for state-specific legislation.
    """
```

Implementation:
- Aggregate bills across all Tribes in the region
- Group by bill_id (shared bills shown once with affected Tribe count)
- Show top 5 bills by combined relevance
- Per-state delegation summary (senators/reps who sponsored relevant bills)
- Confidence badge on section heading
  </action>
  <verify>
1. DocxEngine.generate() calls render_bill_intelligence_section before render_delegation_section
2. PacketOrchestrator loads congressional_intel.json and filters bills per-Tribe
3. Regional congressional section exists in docx_regional_sections.py
4. Existing tests pass: `python -m pytest tests/ -x -q`
  </verify>
  <done>Bill intelligence appears before delegation in all documents; orchestrator loads and filters congressional intel per-Tribe; regional aggregation renders shared bills across regions for Doc C/D.</done>
</task>

</tasks>

<verification>
1. DocxEngine.generate() section order: cover -> TOC -> exec summary -> **bill intelligence** -> delegation -> hot sheets -> ...
2. PacketOrchestrator handles missing congressional_intel.json gracefully (WARNING, not crash)
3. Doc A bill section includes talking points and timing
4. Doc B bill section has zero strategy language
5. Doc C/D regional section aggregates bills across Tribes
6. Confidence badges are HIGH/MEDIUM/LOW text, zero numeric scores
7. All imports resolve correctly
8. Existing tests pass: `python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- INTEL-07: All 4 doc types render congressional content with audience differentiation
- INTEL-08 (partial): Confidence indicators display as HIGH/MEDIUM/LOW in rendered sections
- Bills-first ordering in Doc A per CONTEXT.md decision
- Doc B: facts only, zero strategy leakage
- Doc C/D: regional aggregation with shared bills
</success_criteria>

<output>
After completion, create `.planning/phases/15-congressional-intelligence/15-05-SUMMARY.md`
</output>
