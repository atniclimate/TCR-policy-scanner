---
phase: 15-congressional-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schemas/models.py
  - src/packets/context.py
  - src/packets/confidence.py
  - src/graph/schema.py
autonomous: true

must_haves:
  truths:
    - "Congressional Pydantic models (BillAction, BillIntelligence, CongressionalIntelReport, VoteRecord, Legislator) validate bill data with field types, ranges, and cross-field rules"
    - "TribePacketContext has a congressional_intel dict field that carries bill intelligence, enhanced delegation, confidence, and scan_date from orchestrator to DOCX renderers"
    - "compute_confidence() returns a float 0.0-1.0 from source_weight and freshness decay; confidence_level() maps to HIGH/MEDIUM/LOW"
    - "Knowledge graph schema includes BillNode and LegislatorNode dataclasses with SPONSORED_BY, REFERRED_TO, AFFECTS_PROGRAM, DELEGATES_TO edge types"
  artifacts:
    - path: "src/schemas/models.py"
      provides: "Congressional Pydantic models"
      contains: "class BillIntelligence"
    - path: "src/packets/context.py"
      provides: "Extended TribePacketContext with congressional_intel field"
      contains: "congressional_intel"
    - path: "src/packets/confidence.py"
      provides: "Confidence scoring functions"
      contains: "def compute_confidence"
    - path: "src/graph/schema.py"
      provides: "BillNode and LegislatorNode graph nodes"
      contains: "class BillNode"
  key_links:
    - from: "src/schemas/models.py"
      to: "src/packets/context.py"
      via: "congressional_intel field uses model-compatible dict structure"
    - from: "src/packets/confidence.py"
      to: "src/packets/context.py"
      via: "confidence scores flow into congressional_intel.confidence dict"
    - from: "src/graph/schema.py"
      to: "src/schemas/models.py"
      via: "BillNode fields mirror BillIntelligence model fields"
---

<objective>
Define the data contract for congressional intelligence: Pydantic models for bill data, extended TribePacketContext for downstream rendering, confidence scoring as a pure-function module, and knowledge graph node types for congressional entities.

Purpose: This plan establishes the shared data model that Scout (Plan 04) produces and Fire Keeper (Plan 05) consumes. Per the coordination rule, data models must exist BEFORE either agent builds. This plan is the contract.

Output: Four files modified with models, context extension, confidence functions, and graph nodes.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-congressional-intelligence/15-RESEARCH.md
@src/schemas/models.py
@src/packets/context.py
@src/graph/schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add congressional Pydantic models to schemas/models.py</name>
  <files>src/schemas/models.py</files>
  <action>
Add the following Pydantic v2 models to the END of src/schemas/models.py, following the existing model patterns (Field with description, field_validator for enums, Optional for nullable fields):

1. **BillAction** model:
   - action_date: str (YYYY-MM-DD)
   - text: str (action description)
   - action_type: str (default "")
   - chamber: str (default "")

2. **BillIntelligence** model:
   - bill_id: str (e.g., "119-HR-1234")
   - congress: int
   - bill_type: str (HR, S, HJRES, SJRES)
   - bill_number: int
   - title: str
   - sponsor: Optional[dict] (primary sponsor info)
   - cosponsors: list[dict] (default_factory=list)
   - cosponsor_count: int (default=0, ge=0)
   - actions: list[BillAction] (default_factory=list)
   - latest_action: Optional[BillAction] (default=None)
   - committees: list[dict] (default_factory=list)
   - subjects: list[str] (default_factory=list)
   - policy_area: str (default="")
   - text_url: str (default="")
   - congress_url: str (default="")
   - relevance_score: float (default=0.0, ge=0.0, le=1.0)
   - matched_programs: list[str] (default_factory=list)
   - update_date: str (default="")
   - introduced_date: str (default="")

3. **VoteRecord** model:
   - vote_id: str
   - bill_id: str (default="")
   - chamber: str (default="")
   - vote_date: str (default="")
   - result: str (default="")
   - yea_count: int (default=0)
   - nay_count: int (default=0)

4. **Legislator** model:
   - bioguide_id: str
   - name: str
   - state: str (default="")
   - district: str (default="")
   - party: str (default="")
   - chamber: str (default="")
   - committees: list[dict] (default_factory=list)
   - sponsored_bills: list[str] (default_factory=list)
   - cosponsored_bills: list[str] (default_factory=list)

5. **CongressionalIntelReport** model:
   - tribe_id: str
   - generated_at: str
   - bills: list[BillIntelligence] (default_factory=list)
   - delegation_enhanced: bool (default=False)
   - confidence: dict (default_factory=dict)
   - scan_date: str (default="")

Add a field_validator on BillIntelligence.bill_type that restricts to valid Congress.gov bill type codes: HR, S, HJRES, SJRES, HCONRES, SCONRES, HRES, SRES.

Do NOT create a separate file. Add to the existing models.py.
  </action>
  <verify>
Run: `python -c "from src.schemas.models import BillIntelligence, BillAction, VoteRecord, Legislator, CongressionalIntelReport; b = BillIntelligence(bill_id='119-HR-1', congress=119, bill_type='HR', bill_number=1, title='Test'); print(b.bill_id)"`
Expected: prints "119-HR-1" without errors.
  </verify>
  <done>All 5 congressional Pydantic models importable from src.schemas.models and validate correctly with field constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Extend TribePacketContext + create confidence module + extend graph schema</name>
  <files>src/packets/context.py, src/packets/confidence.py, src/graph/schema.py</files>
  <action>
**A) Extend TribePacketContext (src/packets/context.py):**

Add a new field after `congress_session`:
```python
# Congressional intelligence (INTEL-06)
congressional_intel: dict = field(default_factory=dict)
```

Update the docstring to document the new field:
- congressional_intel: Dict carrying bill intelligence, enhanced delegation, committee activity, appropriations status, scan_date, and confidence scores. Populated by PacketOrchestrator from congressional_intel.json.

**B) Create confidence module (src/packets/confidence.py):**

Create a new file `src/packets/confidence.py` with:

```python
"""Confidence scoring for data sections.

Computes confidence scores from source weights and freshness decay
using exponential decay: confidence = source_weight * e^(-lambda * days).

Confidence levels for DOCX display:
- HIGH: >= 0.7 (data fresh and from authoritative source)
- MEDIUM: 0.4 - 0.69
- LOW: < 0.4
"""

import math
import logging
from datetime import datetime, timezone

logger = logging.getLogger(__name__)

# Source weights matching scanner_config.json authority_weight values
DEFAULT_SOURCE_WEIGHTS = {
    "congress_gov": 0.80,
    "federal_register": 0.90,
    "grants_gov": 0.85,
    "usaspending": 0.70,
    "congressional_cache": 0.75,
    "inferred": 0.50,
}

def compute_confidence(
    source_weight: float,
    last_updated: str,
    decay_rate: float = 0.01,
    reference_date: datetime | None = None,
) -> float:
    """Compute confidence score from source weight and freshness.

    Args:
        source_weight: Source authority weight 0.0-1.0.
        last_updated: ISO date string of last data update.
        decay_rate: Exponential decay rate (default 0.01, half-life ~69 days).
        reference_date: Reference date for staleness calc (default: now UTC).

    Returns:
        Confidence score 0.0-1.0 rounded to 3 decimal places.
    """
    if reference_date is None:
        reference_date = datetime.now(timezone.utc)
    try:
        updated = datetime.fromisoformat(last_updated)
        if updated.tzinfo is None:
            updated = updated.replace(tzinfo=timezone.utc)
        days = max(0, (reference_date - updated).days)
    except (ValueError, TypeError):
        days = 365  # Unknown date -> assume very stale
    return round(source_weight * math.exp(-decay_rate * days), 3)

def confidence_level(score: float) -> str:
    """Map numeric confidence score to display level.

    Returns:
        "HIGH" (>= 0.7), "MEDIUM" (0.4-0.69), or "LOW" (< 0.4).
    """
    if score >= 0.7:
        return "HIGH"
    elif score >= 0.4:
        return "MEDIUM"
    return "LOW"

def section_confidence(
    source: str,
    last_updated: str,
    decay_rate: float = 0.01,
    reference_date: datetime | None = None,
) -> dict:
    """Compute confidence for a document section.

    Convenience wrapper returning both numeric score and display level.

    Args:
        source: Data source name (key into DEFAULT_SOURCE_WEIGHTS).
        last_updated: ISO date string.
        decay_rate: Decay rate for exponential freshness.
        reference_date: Optional reference date.

    Returns:
        Dict with "score", "level", "source", "last_updated" keys.
    """
    weight = DEFAULT_SOURCE_WEIGHTS.get(source, 0.50)
    score = compute_confidence(weight, last_updated, decay_rate, reference_date)
    return {
        "score": score,
        "level": confidence_level(score),
        "source": source,
        "last_updated": last_updated,
    }
```

**C) Extend knowledge graph schema (src/graph/schema.py):**

Add two new node types AFTER ObligationNode:

```python
@dataclass
class BillNode:
    """Congressional bill tracked for Tribal relevance."""
    id: str          # e.g., "bill_119_hr_1234"
    congress: int
    bill_type: str
    bill_number: int
    title: str = ""
    status: str = ""
    relevance_score: float = 0.0
    sponsor_id: str = ""
    introduced_date: str = ""

@dataclass
class LegislatorNode:
    """Congressional member with Tribal advocacy relevance."""
    id: str          # bioguide_id
    name: str
    chamber: str = ""
    state: str = ""
    district: str = ""
    party: str = ""
```

Add a comment block documenting the new edge types:
```python
# ── Congressional Edge Types ──
# SPONSORED_BY:    BillNode -> LegislatorNode
# REFERRED_TO:     BillNode -> committee_id (str)
# AFFECTS_PROGRAM: BillNode -> ProgramNode (metadata: relevance_score)
# DELEGATES_TO:    TribeNode -> LegislatorNode (metadata: overlap_pct)
```

Do NOT use `encoding` parameter -- follow existing file patterns.
  </action>
  <verify>
Run: `python -c "from src.packets.context import TribePacketContext; c = TribePacketContext(tribe_id='test', tribe_name='Test'); print(c.congressional_intel)"`
Expected: prints `{}`.

Run: `python -c "from src.packets.confidence import compute_confidence, confidence_level, section_confidence; print(confidence_level(0.8), confidence_level(0.5), confidence_level(0.2))"`
Expected: prints `HIGH MEDIUM LOW`.

Run: `python -c "from src.graph.schema import BillNode, LegislatorNode; b = BillNode(id='bill_119_hr_1', congress=119, bill_type='HR', bill_number=1); print(b.id)"`
Expected: prints `bill_119_hr_1`.
  </verify>
  <done>TribePacketContext has congressional_intel field; confidence module exports compute_confidence, confidence_level, section_confidence; graph schema has BillNode and LegislatorNode with edge type documentation.</done>
</task>

</tasks>

<verification>
1. All 5 Pydantic models import and validate: `python -c "from src.schemas.models import BillIntelligence, BillAction, VoteRecord, Legislator, CongressionalIntelReport"`
2. BillIntelligence.bill_type validator rejects invalid types: `python -c "from src.schemas.models import BillIntelligence; BillIntelligence(bill_id='x', congress=119, bill_type='INVALID', bill_number=1, title='x')"` should raise ValidationError
3. TribePacketContext backward compatible: `python -c "from src.packets.context import TribePacketContext; c = TribePacketContext(tribe_id='t', tribe_name='n'); assert c.congressional_intel == {}"`
4. Confidence scoring correct: `python -c "from src.packets.confidence import compute_confidence; from datetime import datetime, timezone; s = compute_confidence(0.8, datetime.now(timezone.utc).isoformat()); assert 0.79 <= s <= 0.81"`
5. Existing tests still pass: `python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- INTEL-05: All 5 congressional Pydantic models defined with validations
- INTEL-06: TribePacketContext extended with congressional_intel field
- INTEL-08: Confidence scoring module with compute_confidence, confidence_level, section_confidence
- INTEL-14: BillNode and LegislatorNode added to graph schema with edge type documentation
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/15-congressional-intelligence/15-01-SUMMARY.md`
</output>
