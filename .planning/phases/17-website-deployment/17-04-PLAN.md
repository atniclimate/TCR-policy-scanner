---
phase: 17-website-deployment
plan: 04
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - .github/workflows/deploy-website.yml
  - .github/workflows/generate-packets.yml
autonomous: true

must_haves:
  truths:
    - "deploy-website.yml workflow triggers on push to main when docs/web/ or scripts/build_web_index.py change"
    - "deploy-website.yml runs build_web_index.py to regenerate tribes.json with aliases"
    - "deploy-website.yml copies DOCX files from outputs/packets/ to docs/web/tribes/"
    - "deploy-website.yml commits and pushes changes to docs/web/"
    - "generate-packets.yml invokes build_web_index.py and copies files to docs/web/tribes/"
    - "SquareSpace embed instructions are documented in index.html with correct sandbox permissions"
  artifacts:
    - path: ".github/workflows/deploy-website.yml"
      provides: "GitHub Actions workflow for website deployment"
      contains: "build_web_index.py"
    - path: ".github/workflows/generate-packets.yml"
      provides: "Updated packet generation workflow with alias-enabled web index"
      contains: "build_web_index.py"
  key_links:
    - from: ".github/workflows/deploy-website.yml"
      to: "scripts/build_web_index.py"
      via: "python scripts/build_web_index.py step"
      pattern: "build_web_index"
    - from: ".github/workflows/deploy-website.yml"
      to: "docs/web/tribes/"
      via: "cp commands copy DOCX files for GitHub Pages serving"
      pattern: "docs/web/tribes"
---

<objective>
Create the GitHub Pages deployment pipeline and update the packet generation workflow to produce a complete, automatically deployed website with real DOCX files.

Purpose: The website needs an automated pipeline that (a) regenerates tribes.json with aliases whenever build_web_index.py or data changes, (b) copies generated DOCX files to the GitHub Pages serving directory, and (c) deploys on merge to main. The existing generate-packets.yml already does most of this but needs the alias-enhanced build_web_index.py invocation.

Output: `deploy-website.yml` for dedicated website deployment, updated `generate-packets.yml` with alias support.
</objective>

<execution_context>
@D:\Claude-Workspace\.clone/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-website-deployment/17-CONTEXT.md
@.planning/phases/17-website-deployment/17-RESEARCH.md
@.planning/phases/17-website-deployment/17-01-SUMMARY.md
@.github/workflows/generate-packets.yml
@.github/workflows/daily-scan.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy-website.yml workflow</name>
  <files>.github/workflows/deploy-website.yml</files>
  <action>
Create `.github/workflows/deploy-website.yml`:

```yaml
name: Deploy Website

on:
  push:
    branches: [main]
    paths:
      - 'docs/web/**'
      - 'scripts/build_web_index.py'
      - 'data/tribal_registry.json'
      - 'data/tribal_aliases.json'
      - 'config/regional_config.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build web index (tribes.json with aliases)
        run: python scripts/build_web_index.py

      - name: Copy DOCX files to docs/web/tribes/
        run: |
          mkdir -p docs/web/tribes/internal
          mkdir -p docs/web/tribes/congressional
          mkdir -p docs/web/tribes/regional/internal
          mkdir -p docs/web/tribes/regional/congressional
          cp outputs/packets/internal/*.docx docs/web/tribes/internal/ 2>/dev/null || true
          cp outputs/packets/congressional/*.docx docs/web/tribes/congressional/ 2>/dev/null || true
          cp outputs/packets/regional/internal/*.docx docs/web/tribes/regional/internal/ 2>/dev/null || true
          cp outputs/packets/regional/congressional/*.docx docs/web/tribes/regional/congressional/ 2>/dev/null || true

      - name: Generate manifest.json
        run: |
          python3 -c "
          import json, os
          from datetime import datetime, timezone
          from pathlib import Path

          tribes_dir = Path('docs/web/tribes')
          counts = {
              'internal': len(list((tribes_dir / 'internal').glob('*.docx'))) if (tribes_dir / 'internal').is_dir() else 0,
              'congressional': len(list((tribes_dir / 'congressional').glob('*.docx'))) if (tribes_dir / 'congressional').is_dir() else 0,
              'regional_internal': len(list((tribes_dir / 'regional/internal').glob('*.docx'))) if (tribes_dir / 'regional/internal').is_dir() else 0,
              'regional_congressional': len(list((tribes_dir / 'regional/congressional').glob('*.docx'))) if (tribes_dir / 'regional/congressional').is_dir() else 0,
          }
          manifest = {
              'deployed_at': datetime.now(timezone.utc).isoformat(),
              'document_counts': counts,
              'total_documents': sum(counts.values()),
          }
          Path('docs/web/data').mkdir(parents=True, exist_ok=True)
          with open('docs/web/data/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          print(f'Manifest: {manifest[\"total_documents\"]} documents deployed')
          "

      - name: Commit and push
        run: |
          git config user.name "TCR Policy Scanner"
          git config user.email "scanner@tcr-policy-scanner.local"
          git add docs/web/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: deploy website ($(date -u +%Y-%m-%d))"
            git push
          fi
```

Key design decisions:
- Triggers on changes to web files, build script, registry data, or aliases -- covers all sources that affect the website
- `workflow_dispatch` enables manual triggering for initial deployment or reruns
- Generates `manifest.json` with deployment timestamp and document counts (WEB-01)
- 15-minute timeout is ample for the build + copy process
- Uses same copy pattern as existing generate-packets.yml for consistency
- `2>/dev/null || true` handles case where DOCX files don't exist yet
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-website.yml'))"` (if PyYAML installed)
Or: check YAML structure manually for proper indentation.
Verify: the workflow references `build_web_index.py` and copies to `docs/web/tribes/`.
  </verify>
  <done>
deploy-website.yml triggers on push to main (when web-related files change) or manual dispatch. It rebuilds tribes.json, copies DOCX files, generates manifest.json, and commits/pushes changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update generate-packets.yml with alias-aware web index build</name>
  <files>.github/workflows/generate-packets.yml</files>
  <action>
The existing `generate-packets.yml` already calls `python scripts/build_web_index.py` at the "Build web index" step. The enhanced `build_web_index.py` (Plan 01) automatically reads aliases from `data/tribal_aliases.json` -- no CLI flag change needed because it uses default paths.

Make these minimal updates:

1. **Add manifest.json generation step** after "Build web index" and before "Deploy to docs/web":
```yaml
      - name: Generate deployment manifest
        run: |
          python3 -c "
          import json
          from datetime import datetime, timezone
          from pathlib import Path

          tribes_dir = Path('docs/web/tribes')
          counts = {
              'internal': len(list((tribes_dir / 'internal').glob('*.docx'))) if (tribes_dir / 'internal').is_dir() else 0,
              'congressional': len(list((tribes_dir / 'congressional').glob('*.docx'))) if (tribes_dir / 'congressional').is_dir() else 0,
              'regional_internal': len(list((tribes_dir / 'regional/internal').glob('*.docx'))) if (tribes_dir / 'regional/internal').is_dir() else 0,
              'regional_congressional': len(list((tribes_dir / 'regional/congressional').glob('*.docx'))) if (tribes_dir / 'regional/congressional').is_dir() else 0,
          }
          manifest = {
              'deployed_at': datetime.now(timezone.utc).isoformat(),
              'document_counts': counts,
              'total_documents': sum(counts.values()),
          }
          Path('docs/web/data').mkdir(parents=True, exist_ok=True)
          with open('docs/web/data/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          print(f'Manifest: {manifest[\"total_documents\"]} documents deployed')
          "
```

2. **Update the git add step** to include manifest.json:
   Change: `git add docs/web/tribes/ docs/web/data/tribes.json`
   To: `git add docs/web/tribes/ docs/web/data/`
   This captures both tribes.json and manifest.json.

3. **Add comment** noting that build_web_index.py now embeds aliases from data/tribal_aliases.json automatically.

Do NOT change the workflow triggers, schedule, or any other existing steps. This is a minimal, additive change.
  </action>
  <verify>
Verify `generate-packets.yml` still has valid YAML syntax.
Verify the "Generate deployment manifest" step appears between "Build web index" and "Deploy to docs/web".
Verify the git add line includes `docs/web/data/` (not just `docs/web/data/tribes.json`).
  </verify>
  <done>
generate-packets.yml now generates manifest.json alongside tribes.json and commits both. The existing build_web_index.py call automatically picks up aliases since Plan 01 added that capability with default paths.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy-website.yml` exists with valid YAML
2. deploy-website.yml triggers on push to main for `docs/web/**` and related paths
3. deploy-website.yml calls `python scripts/build_web_index.py`
4. deploy-website.yml generates `docs/web/data/manifest.json`
5. `generate-packets.yml` includes manifest generation step
6. `generate-packets.yml` git add includes `docs/web/data/` directory
7. Both workflows copy DOCX files to correct subdirectory structure
</verification>

<success_criteria>
- deploy-website.yml triggers on relevant file changes and manual dispatch
- Both workflows generate manifest.json with deployment timestamp and document counts
- DOCX files are copied to docs/web/tribes/{internal,congressional,regional/internal,regional/congressional}/
- tribes.json with aliases is generated by build_web_index.py
- SquareSpace embed documented in index.html with correct sandbox permissions (verified from Plan 02)
- Commits are automated with descriptive messages
</success_criteria>

<output>
After completion, create `.planning/phases/17-website-deployment/17-04-SUMMARY.md`
</output>
