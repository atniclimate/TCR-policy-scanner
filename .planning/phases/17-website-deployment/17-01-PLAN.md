---
phase: 17-website-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build_web_index.py
  - docs/web/js/fuse.min.js
autonomous: true

must_haves:
  truths:
    - "tribes.json contains aliases array per Tribe with up to 10 filtered aliases"
    - "tribes.json contains per-Tribe generated_at timestamp from DOCX file modification time"
    - "Fuse.js 7.1.0 is self-hosted at docs/web/js/fuse.min.js (no CDN dependency)"
    - "Awesomplete files are removed from docs/web/"
  artifacts:
    - path: "scripts/build_web_index.py"
      provides: "Enhanced web index builder with alias embedding and per-Tribe timestamps"
      contains: "_load_filtered_aliases"
    - path: "docs/web/js/fuse.min.js"
      provides: "Self-hosted Fuse.js 7.1.0 fuzzy search library"
      min_lines: 1
  key_links:
    - from: "scripts/build_web_index.py"
      to: "data/tribal_aliases.json"
      via: "_load_filtered_aliases reads and filters aliases"
      pattern: "_load_filtered_aliases"
    - from: "scripts/build_web_index.py"
      to: "docs/web/data/tribes.json"
      via: "build_index writes enhanced tribes.json with aliases"
      pattern: "aliases"
---

<objective>
Enhance the data pipeline that generates tribes.json to embed fuzzy-searchable aliases and per-Tribe freshness timestamps, and self-host Fuse.js for zero third-party dependencies.

Purpose: The web client needs (a) aliases embedded in tribes.json so Fuse.js can search alternate/self-designation names like "Apsaalooke" for Crow Nation, (b) per-Tribe timestamps for data freshness badges, and (c) Fuse.js served from the same origin for XCUT-02 compliance (zero CDN requests).

Output: Enhanced `build_web_index.py` that produces tribes.json with aliases + timestamps. Self-hosted `fuse.min.js`. Awesomplete files removed.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-website-deployment/17-CONTEXT.md
@.planning/phases/17-website-deployment/17-RESEARCH.md
@scripts/build_web_index.py
@data/tribal_aliases.json (read structure only -- 18,776 aliases, format: {"aliases": {"alias_string": "tribe_id", ...}})
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance build_web_index.py with alias embedding and per-Tribe timestamps</name>
  <files>scripts/build_web_index.py</files>
  <action>
Add a `_load_filtered_aliases(aliases_path, max_per_tribe=10)` function to `build_web_index.py`:

1. Read `data/tribal_aliases.json` (format: `{"aliases": {"alias_string": "tribe_id", ...}}`)
2. Build a reverse mapping: `{tribe_id: [alias1, alias2, ...]}`
3. Filter OUT aliases containing "housing" (housing authority variants are not useful for search)
4. Sort remaining aliases by string length (shortest first -- users are more likely to search short names)
5. Keep at most `max_per_tribe` aliases per Tribe
6. Return `{tribe_id: [filtered_aliases]}` dict
7. Size guard: skip if file exceeds 10MB (consistent with existing MAX_REGISTRY_SIZE pattern)
8. Handle missing file gracefully (return empty dict)

In `build_index()`:
1. Accept optional `aliases_path` parameter (default: `data/tribal_aliases.json` via `src.paths` if available, otherwise `PROJECT_ROOT / "data" / "tribal_aliases.json"`)
2. Call `_load_filtered_aliases(aliases_path)` at the top of the function
3. For each Tribe entry, add `"aliases": filtered_aliases.get(tribe_id, [])` to the entry dict
4. For each Tribe entry, add `"generated_at"` timestamp:
   - Check if the Tribe's DOCX files exist in the packets directory
   - Use the most recent file modification time among the Tribe's DOCX files
   - Format as ISO 8601 string: `datetime.fromtimestamp(mtime, tz=timezone.utc).isoformat()`
   - If no DOCX files exist, set `"generated_at": null`

Update CLI `main()` to accept `--aliases` argument defaulting to `data/tribal_aliases.json`.

Also add import for `collections.defaultdict` at the top.

IMPORTANT: Preserve ALL existing functionality. The alias embedding and timestamps are purely additive fields in the output JSON.
  </action>
  <verify>
Run: `python -m pytest tests/ -k "build_web" -v` (if tests exist)
Run: `python scripts/build_web_index.py --help` (verify --aliases flag appears)
Manually verify the script runs without error (even if data files don't exist locally -- it should handle missing files gracefully).
  </verify>
  <done>
`build_web_index.py` produces tribes.json entries with `aliases` (list of up to 10 strings) and `generated_at` (ISO timestamp or null) fields for each Tribe. Housing authority aliases are filtered out. Missing alias file is handled gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Self-host Fuse.js and remove Awesomplete</name>
  <files>docs/web/js/fuse.min.js</files>
  <action>
1. Download Fuse.js 7.1.0 UMD bundle from: https://cdn.jsdelivr.net/npm/fuse.js@7.1.0/dist/fuse.min.js
   Save to: `docs/web/js/fuse.min.js`
   Expected size: ~25.8KB

2. Remove Awesomplete files (no longer needed -- will be replaced by custom ARIA combobox):
   - Delete `docs/web/js/awesomplete.min.js`
   - Delete `docs/web/css/awesomplete.css`

3. Verify fuse.min.js is valid by checking it starts with a recognizable UMD/IIFE wrapper and contains "Fuse" in the source.

XCUT-02 compliance: Self-hosting eliminates the CDN dependency. Zero third-party requests.
  </action>
  <verify>
Verify `docs/web/js/fuse.min.js` exists and is >20KB.
Verify `docs/web/js/awesomplete.min.js` does NOT exist.
Verify `docs/web/css/awesomplete.css` does NOT exist.
  </verify>
  <done>
Fuse.js 7.1.0 is self-hosted at `docs/web/js/fuse.min.js`. Awesomplete files are removed. Zero CDN dependencies remain.
  </done>
</task>

</tasks>

<verification>
1. `python scripts/build_web_index.py --help` shows `--aliases` flag
2. `docs/web/js/fuse.min.js` exists (~25.8KB)
3. `docs/web/js/awesomplete.min.js` does NOT exist
4. `docs/web/css/awesomplete.css` does NOT exist
5. No references to jsdelivr or other CDNs in any `docs/web/` file
</verification>

<success_criteria>
- build_web_index.py embeds filtered aliases (up to 10 per Tribe, no housing variants) in tribes.json
- build_web_index.py embeds per-Tribe generated_at timestamps from DOCX file modification times
- Fuse.js 7.1.0 is self-hosted, Awesomplete is removed
- Zero CDN or third-party dependencies (XCUT-02)
</success_criteria>

<output>
After completion, create `.planning/phases/17-website-deployment/17-01-SUMMARY.md`
</output>
