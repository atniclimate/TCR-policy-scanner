---
phase: 05-foundation
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - src/packets/orchestrator.py
  - src/main.py
  - config/scanner_config.json
  - tests/test_packets.py
autonomous: true

must_haves:
  truths:
    - "--prep-packets --tribe 'Navajo Nation' resolves the Tribe, displays delegation (4+ districts, 3 states)"
    - "--prep-packets --tribe 'Tlingit' performs fuzzy search and returns candidate matches"
    - "--prep-packets --tribe 'nonexistent' shows error with fuzzy suggestions"
    - "--prep-packets without --tribe or --all-tribes prints usage error"
    - "PacketOrchestrator assembles TribePacketContext from registry + ecoregion + congress modules"
    - "Delegation display shows formatted member names with party, state, committees"
    - "Tests verify registry resolution, ecoregion classification, and delegation assembly"
  artifacts:
    - path: "src/packets/orchestrator.py"
      provides: "PacketOrchestrator coordinating registry, ecoregion, and congress modules"
      exports: ["PacketOrchestrator"]
    - path: "src/main.py"
      provides: "CLI entry point with --prep-packets, --tribe, --all-tribes flags"
      contains: "--prep-packets"
    - path: "config/scanner_config.json"
      provides: "Updated config with packets section for data paths"
      contains: "packets"
    - path: "tests/test_packets.py"
      provides: "Test suite for registry, ecoregion, congress, and orchestrator"
  key_links:
    - from: "src/main.py"
      to: "src/packets/orchestrator.py"
      via: "Lazy import when --prep-packets flag is set"
      pattern: "from src\\.packets\\.orchestrator import PacketOrchestrator"
    - from: "src/packets/orchestrator.py"
      to: "src/packets/registry.py"
      via: "TribalRegistry instance for name resolution"
      pattern: "TribalRegistry"
    - from: "src/packets/orchestrator.py"
      to: "src/packets/congress.py"
      via: "CongressionalMapper instance for delegation lookups"
      pattern: "CongressionalMapper"
    - from: "src/packets/orchestrator.py"
      to: "src/packets/ecoregion.py"
      via: "EcoregionMapper instance for ecoregion classification"
      pattern: "EcoregionMapper"
    - from: "src/packets/orchestrator.py"
      to: "src/packets/context.py"
      via: "Creates TribePacketContext for each resolved Tribe"
      pattern: "TribePacketContext"
---

<objective>
Integrate all Phase 5 modules into the PacketOrchestrator and wire it to the CLI via `--prep-packets --tribe <name>` and `--prep-packets --all-tribes` flags. Write the test suite. This is the integration plan that brings REG-01, REG-02, REG-03, CONG-01, and CONG-02 together into a working end-to-end flow.

Purpose: This plan delivers the Phase 5 success criteria: `--prep-packets --tribe "Navajo Nation"` resolves the Tribe, displays its identity and congressional delegation. It proves the data backbone works before Phase 6 adds award matching and hazard profiling.
Output: `src/packets/orchestrator.py`, updated `src/main.py` with CLI flags, updated `config/scanner_config.json` with packets section, `tests/test_packets.py`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-foundation/05-RESEARCH.md
@.planning/phases/05-foundation/05-CONTEXT.md
@.planning/phases/05-foundation/05-01-SUMMARY.md
@.planning/phases/05-foundation/05-02-SUMMARY.md
@.planning/phases/05-foundation/05-03-SUMMARY.md
@src/main.py
@src/packets/registry.py
@src/packets/congress.py
@src/packets/ecoregion.py
@src/packets/context.py
@config/scanner_config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PacketOrchestrator and wire CLI flags</name>
  <files>
    src/packets/orchestrator.py
    src/main.py
    config/scanner_config.json
  </files>
  <action>
**A. Update `config/scanner_config.json`** — Add a `"packets"` section at the top level (after existing config sections):

```json
{
    "packets": {
        "tribal_registry": {
            "data_path": "data/tribal_registry.json"
        },
        "congressional_cache": {
            "data_path": "data/congressional_cache.json"
        },
        "ecoregion": {
            "data_path": "data/ecoregion_config.json"
        },
        "output_dir": "outputs/packets"
    }
}
```

This follows the existing pattern of the config file having nested sections. Do NOT modify any existing config sections. Add the `"packets"` key as a new sibling to existing top-level keys.

**B. Create `src/packets/orchestrator.py`** — PacketOrchestrator class:

```python
"""Orchestrates Tribe-specific advocacy packet generation.

Phase 5: Resolves Tribe, assembles context, displays delegation (stub output).
Phase 7+: Will generate DOCX packets.
"""
```

Class `PacketOrchestrator`:

1. **`__init__(self, config: dict, programs: list[dict])`**
   - Store config and build `self.programs = {p["id"]: p for p in programs}`
   - Create instances: `self.registry = TribalRegistry(config)`, `self.congress = CongressionalMapper(config)`, `self.ecoregion = EcoregionMapper(config)`
   - Use `logging.getLogger("tcr_scanner.packets.orchestrator")`

2. **`run_single_tribe(self, tribe_name: str) -> None`**
   - Call `self.registry.resolve(tribe_name)`
   - Handle three outcomes:
     a. **Single dict** (exact match): proceed directly
     b. **List of dicts** (ambiguous/fuzzy): auto-select first (best) match, print warning showing alternatives per CONTEXT.md ("Auto-select best match + print warning showing alternatives")
     c. **None** (no match): call `self.registry.fuzzy_search(tribe_name, limit=5)` and display suggestions, then `sys.exit(1)`
   - If result is a list and items have `_match_score` key (fuzzy results), display match scores per CONTEXT.md ("Only show match score on fuzzy matches")
   - Build context via `self._build_context(tribe)`
   - Display via `self._display_tribe_info(context)`

3. **`run_all_tribes(self) -> None`**
   - Get all Tribes via `self.registry.get_all()`
   - For each Tribe: `print(f"[{i}/{total}] {tribe['name']}...")`  per CONTEXT.md batch format
   - Build context for each (Phase 7+ will generate DOCX here)
   - Print summary at end: total Tribes processed, total unique districts, total unique states

4. **`_build_context(self, tribe: dict) -> TribePacketContext`**
   - Create TribePacketContext with:
     - `tribe_id` = tribe["tribe_id"]
     - `tribe_name` = tribe["name"]
     - `bia_code` = tribe.get("bia_code", "")
     - `epa_id` = tribe["tribe_id"]
     - `states` = tribe.get("states", [])
     - `ecoregions` = self.ecoregion.classify(tribe.get("states", []))
     - `districts` = self.congress.get_districts(tribe["tribe_id"])
     - `senators` = self.congress.get_senators(tribe["tribe_id"])
     - `representatives` = self.congress.get_representatives(tribe["tribe_id"])
     - `generated_at` = datetime.now(timezone.utc).isoformat()
     - `congress_session` = self.congress.get_congress_session()
   - Return the context

5. **`_display_tribe_info(self, context: TribePacketContext) -> None`**
   - Display Tribe identity:
     ```
     === Navajo Nation ===
     Tribe ID: epa_100000171
     BIA Code: 04
     State(s): AZ, NM, UT
     Ecoregion(s): Southwest

     Congressional Delegation (119th Congress):

     Districts (4):
       AZ-01 (85.3% overlap) - Navajo Nation Reservation and Off-Reservation Trust Land
       AZ-02 (10.2% overlap)
       NM-03 (95.0% overlap)
       UT-03 (4.5% overlap)

     Senators (6):
       Sen. X (R-AZ) [Indian Affairs - Chair, Appropriations]
       Sen. Y (D-AZ)
       Sen. Z (R-NM) [Natural Resources]
       ...

     Representatives (4):
       Rep. A (R-AZ-01) [Appropriations]
       Rep. B (D-AZ-02)
       Rep. C (D-NM-03) [Natural Resources]
       Rep. D (R-UT-03)

     Ecoregion Priority Programs:
       1. BIA Tribal Climate Resilience
       2. FEMA BRIC
       3. USFS Tribal Forest
       4. EPA Indian Environmental GAP
     ```
   - Use `print()` for CLI output (not logger — this is user-facing display)
   - Claude's discretion on exact formatting per CONTEXT.md: "Claude's discretion — pick what feels natural for the CLI"
   - If delegation is empty/None, display "No congressional mapping found for this Tribe" (graceful degradation)
   - Include committee assignments inline with member names where relevant (per CONTEXT.md: "Track chair, ranking member, vice chair per committee")

**C. Update `src/main.py`** — Add CLI flags and dispatch:

Add three new arguments to the argparse section (AFTER the existing arguments, BEFORE `args = parser.parse_args()`):

```python
parser.add_argument("--prep-packets", action="store_true",
                    help="Generate Tribe-specific advocacy packets")
parser.add_argument("--tribe", type=str,
                    help="Tribe name for single packet (used with --prep-packets)")
parser.add_argument("--all-tribes", action="store_true",
                    help="Generate for all Tribes (used with --prep-packets)")
```

Add dispatch logic in `main()` AFTER `config = load_config()` and `programs = load_programs()` but BEFORE the existing `if args.programs:` check:

```python
if args.prep_packets:
    from src.packets.orchestrator import PacketOrchestrator
    orchestrator = PacketOrchestrator(config, programs)
    if args.all_tribes:
        orchestrator.run_all_tribes()
    elif args.tribe:
        orchestrator.run_single_tribe(args.tribe)
    else:
        parser.error("--prep-packets requires --tribe <name> or --all-tribes")
    return
```

This uses lazy import (per research Pattern 1) so the packets module is only loaded when needed.

**IMPORTANT:** Update the module docstring at the top of main.py to include the new CLI options:
```python
    python -m src.main --prep-packets --tribe "Navajo Nation"  # Single Tribe packet
    python -m src.main --prep-packets --all-tribes              # All Tribe packets
```

Do NOT modify any existing CLI behavior. The existing flags (--programs, --dry-run, --source, --report-only, --graph-only, --verbose) must continue to work exactly as before.
  </action>
  <verify>
    - `python -m src.main --prep-packets --tribe "Navajo Nation"` resolves and displays (or shows fuzzy suggestions if registry has placeholder data)
    - `python -m src.main --prep-packets` without --tribe or --all-tribes produces an error message
    - `python -m src.main --programs` still works (existing CLI not broken)
    - `python -m src.main --dry-run` still works (existing CLI not broken)
    - `python -c "from src.packets.orchestrator import PacketOrchestrator; print('OK')"` succeeds
    - `config/scanner_config.json` is valid JSON with new `packets` section and all existing config preserved
  </verify>
  <done>
    PacketOrchestrator integrates registry, ecoregion, and congress modules. CLI flags --prep-packets, --tribe, --all-tribes work. Single Tribe resolution displays identity + delegation. Existing CLI behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write test suite for all Phase 5 modules</name>
  <files>
    tests/test_packets.py
  </files>
  <action>
Create `tests/test_packets.py` — comprehensive test suite covering all Phase 5 modules.

**Test structure:** Use pytest. Follow existing test patterns in the codebase (check for conftest.py or existing test files for conventions).

**Test categories:**

**1. Ecoregion Tests (REG-02):**
```python
class TestEcoregionMapper:
    def test_single_state_classification(self):
        """AZ -> southwest"""

    def test_multi_state_classification(self):
        """AZ, NM, UT -> ['southwest'] (all same ecoregion)"""

    def test_cross_ecoregion_states(self):
        """AZ, WA -> ['pacific_northwest', 'southwest'] (sorted, deduplicated)"""

    def test_alaska_classification(self):
        """AK -> ['alaska']"""

    def test_all_states_have_ecoregion(self):
        """Every state in FIPS_TO_STATE maps to an ecoregion"""

    def test_priority_programs_returned(self):
        """Each ecoregion has priority_programs list"""

    def test_unknown_state_returns_empty(self):
        """State 'XX' -> empty list (no crash)"""
```

**2. Registry Tests (REG-01):**
```python
class TestTribalRegistry:
    """Tests using fixture data (not live API)."""

    @pytest.fixture
    def mock_registry_data(self, tmp_path):
        """Create a minimal tribal_registry.json fixture."""
        data = {
            "metadata": {"total_tribes": 5},
            "tribes": [
                {"tribe_id": "epa_1", "bia_code": "04", "name": "Navajo Nation", "states": ["AZ", "NM", "UT"], "alternate_names": ["Dine"]},
                {"tribe_id": "epa_2", "bia_code": "13", "name": "Cherokee Nation", "states": ["OK"], "alternate_names": ["Cherokee Nation of Oklahoma"]},
                {"tribe_id": "epa_3", "bia_code": "TBD", "name": "Central Council of the Tlingit & Haida Indian Tribes of Alaska", "states": ["AK"], "alternate_names": ["Tlingit and Haida"]},
                {"tribe_id": "epa_4", "bia_code": "20", "name": "Choctaw Nation of Oklahoma", "states": ["OK"], "alternate_names": ["Choctaw"]},
                {"tribe_id": "epa_5", "bia_code": "21", "name": "Mississippi Band of Choctaw Indians", "states": ["MS"], "alternate_names": ["Mississippi Choctaw"]},
            ]
        }
        # Write to tmp file and configure registry to use it
        ...

    def test_exact_match(self, mock_registry_data):
        """'Navajo Nation' -> single dict with tribe_id 'epa_1'"""

    def test_exact_match_case_insensitive(self, mock_registry_data):
        """'navajo nation' -> same result"""

    def test_substring_single_match(self, mock_registry_data):
        """'Navajo' -> single dict (only one contains 'Navajo')"""

    def test_substring_ambiguous(self, mock_registry_data):
        """'Choctaw' -> list of 2 dicts (both Choctaw Tribes match)"""

    def test_alternate_name_match(self, mock_registry_data):
        """'Dine' -> Navajo Nation (alternate name match)"""

    def test_fuzzy_match(self, mock_registry_data):
        """'Tlingit' -> fuzzy match returns Tlingit & Haida with score"""

    def test_no_match_returns_none(self, mock_registry_data):
        """'Nonexistent Tribe' -> None"""

    def test_get_all_returns_all(self, mock_registry_data):
        """get_all() returns 5 Tribes"""

    def test_get_by_id(self, mock_registry_data):
        """get_by_id('epa_1') -> Navajo"""

    def test_alaska_tribe_has_valid_id(self, mock_registry_data):
        """Alaska Tribe has epa_id, not 'bia_TBD'"""
```

**3. Congressional Mapper Tests (CONG-01, CONG-02):**
```python
class TestCongressionalMapper:

    @pytest.fixture
    def mock_congress_cache(self, tmp_path):
        """Create minimal congressional_cache.json fixture."""
        data = {
            "metadata": {"congress_session": "119"},
            "members": {
                "S001": {"bioguide_id": "S001", "formatted_name": "Sen. Test1 (R-AZ)", "state": "AZ", "chamber": "Senate", "committees": [{"committee_id": "SLIA", "committee_name": "Indian Affairs", "role": "chair"}]},
                "S002": {"bioguide_id": "S002", "formatted_name": "Sen. Test2 (D-AZ)", "state": "AZ", "chamber": "Senate", "committees": []},
                "R001": {"bioguide_id": "R001", "formatted_name": "Rep. Test3 (R-AZ-01)", "district": "AZ-01", "chamber": "House", "committees": []},
                "R002": {"bioguide_id": "R002", "formatted_name": "Rep. Test4 (D-NM-03)", "district": "NM-03", "chamber": "House", "committees": [{"committee_id": "HSII", "committee_name": "Natural Resources", "role": "member"}]},
            },
            "committees": {},
            "delegations": {
                "epa_1": {
                    "tribe_id": "epa_1",
                    "districts": [
                        {"district": "AZ-01", "state": "AZ", "overlap_pct": 85.3},
                        {"district": "NM-03", "state": "NM", "overlap_pct": 95.0},
                    ],
                    "senators": [
                        {"bioguide_id": "S001", "formatted_name": "Sen. Test1 (R-AZ)", "state": "AZ"},
                        {"bioguide_id": "S002", "formatted_name": "Sen. Test2 (D-AZ)", "state": "AZ"},
                    ],
                    "representatives": [
                        {"bioguide_id": "R001", "formatted_name": "Rep. Test3 (R-AZ-01)", "district": "AZ-01"},
                        {"bioguide_id": "R002", "formatted_name": "Rep. Test4 (D-NM-03)", "district": "NM-03"},
                    ]
                }
            }
        }
        # Write to tmp file and configure mapper
        ...

    def test_get_delegation(self, mock_congress_cache):
        """Navajo (epa_1) has 2 districts, 2 senators, 2 reps"""

    def test_get_districts_multi_state(self, mock_congress_cache):
        """Navajo has districts in AZ and NM (multi-state)"""

    def test_senators_not_duplicated(self, mock_congress_cache):
        """AZ senators appear once, not once per AZ district"""

    def test_unknown_tribe_returns_none(self, mock_congress_cache):
        """Unknown tribe_id returns None"""

    def test_congress_session(self, mock_congress_cache):
        """Session is '119'"""

    def test_relevant_committees(self, mock_congress_cache):
        """Finds Indian Affairs committee via senator's assignment"""
```

**4. Context Tests (REG-03):**
```python
class TestTribePacketContext:
    def test_create_context(self):
        """TribePacketContext creates with required fields"""

    def test_to_dict_serializable(self):
        """to_dict() returns JSON-serializable dict"""

    def test_stub_fields_default_empty(self):
        """awards, hazard_profile, economic_impact default to empty"""
```

**5. Integration Test:**
```python
class TestPacketOrchestrator:
    def test_build_context_assembles_all_layers(self, ...):
        """_build_context produces TribePacketContext with identity, ecoregion, delegation"""
```

**Implementation notes:**
- Use `tmp_path` pytest fixture for all test data files (no modifying real data files)
- Each test class has a fixture that creates mock data and configures the module to read from tmp_path
- The config dict passed to each module should override `data_path` to point to tmp files
- Tests must be runnable without network access (no live API calls)
- All test file opens use `encoding="utf-8"`
- Target: 20-30 tests total
  </action>
  <verify>
    - `python -m pytest tests/test_packets.py -v` runs and all tests pass
    - At least 20 tests exist
    - Tests cover all 5 requirements: REG-01 (registry), REG-02 (ecoregion), REG-03 (context), CONG-01 (districts), CONG-02 (members/committees)
    - No tests require network access or API keys
  </verify>
  <done>
    Test suite passes with 20+ tests covering registry resolution (exact, substring, fuzzy, ambiguous), ecoregion classification (single-state, multi-state, Alaska, all-states coverage), congressional mapping (multi-district, senator dedup, committee lookup), context dataclass, and orchestrator integration. All tests use mock data fixtures.
  </done>
</task>

</tasks>

<verification>
1. `python -m src.main --prep-packets --tribe "Navajo Nation"` displays Tribe identity and delegation (or placeholder data)
2. `python -m src.main --prep-packets --tribe "Tlingit"` finds the Tribe via fuzzy/substring match
3. `python -m src.main --prep-packets --tribe "nonexistent"` shows error with suggestions
4. `python -m src.main --prep-packets` (no tribe arg) shows usage error
5. `python -m src.main --programs` still works (regression check)
6. `python -m pytest tests/test_packets.py -v` all tests pass
7. `config/scanner_config.json` is valid JSON with existing + new `packets` section
</verification>

<success_criteria>
- Phase 5 success criteria #1: `--prep-packets --tribe "Navajo Nation"` resolves, displays name, BIA code, state(s), ecoregion, and congressional delegation
- Phase 5 success criteria #2: `--prep-packets --tribe "Tlingit"` performs fuzzy search returning candidates
- Phase 5 success criteria #3: All Tribes loaded with no duplicates, each classified into ecoregion(s)
- Phase 5 success criteria #4: Alaska at-large district correctly maps Alaska Native entities
- All 5 requirements (REG-01 through CONG-02) have test coverage
- Existing CLI behavior completely unchanged
- 20+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation/05-04-SUMMARY.md`
</output>
