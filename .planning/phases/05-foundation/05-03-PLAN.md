---
phase: 05-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build_congress_cache.py
  - src/packets/congress.py
  - data/congressional_cache.json
  - data/aiannh_tribe_crosswalk.json
autonomous: true
user_setup:
  - service: congress_gov_api
    why: "Congressional member data for 119th Congress"
    env_vars:
      - name: CONGRESS_API_KEY
        source: "Already provisioned — same key as existing Congress.gov scraper (CONGRESS_API_KEY env var)"

must_haves:
  truths:
    - "Census CD119-AIANNH file parsed with pipe delimiter, filtered to federal AIANNH classes only"
    - "Tribe-to-district mapping is many-to-many (Navajo has 4+ districts across 3 states)"
    - "Alaska at-large district (AK-AL) correctly maps all Alaska Native entities"
    - "Congressional members fetched from Congress.gov API for 119th Congress with pagination"
    - "Committee assignments loaded from unitedstates/congress-legislators YAML cross-referenced by bioguideId"
    - "Senators appear once per state, not duplicated per district"
    - "AIANNH-to-Tribe crosswalk links Census geographic entities to EPA Tribe IDs"
    - "CongressionalMapper.get_delegation() returns senators, representatives, and committee members for any Tribe"
  artifacts:
    - path: "scripts/build_congress_cache.py"
      provides: "One-time builder: Census file + Congress.gov API + YAML -> congressional_cache.json"
    - path: "src/packets/congress.py"
      provides: "CongressionalMapper class for delegation lookups at runtime"
      exports: ["CongressionalMapper"]
    - path: "data/congressional_cache.json"
      provides: "Pre-computed delegation data for all Tribes with 119th Congress members"
    - path: "data/aiannh_tribe_crosswalk.json"
      provides: "Census AIANNH GEOID to EPA tribe_id mapping"
  key_links:
    - from: "scripts/build_congress_cache.py"
      to: "Census CD119-AIANNH file"
      via: "csv.DictReader with pipe delimiter"
      pattern: "delimiter.*\\|"
    - from: "scripts/build_congress_cache.py"
      to: "Congress.gov API"
      via: "aiohttp GET with X-Api-Key header"
      pattern: "X-Api-Key"
    - from: "scripts/build_congress_cache.py"
      to: "unitedstates/congress-legislators YAML"
      via: "yaml.safe_load for committee-membership-current.yaml"
      pattern: "committee-membership-current"
    - from: "src/packets/congress.py"
      to: "data/congressional_cache.json"
      via: "Lazy-loads JSON file on first access"
      pattern: "congressional_cache\\.json"
---

<objective>
Build the congressional mapping data layer (CONG-01, CONG-02) with both the one-time build script (Census CD119-AIANNH file + Congress.gov API + unitedstates YAML) and the runtime CongressionalMapper class. This delivers the many-to-many Tribe-to-district mapping, 119th Congress member data, and committee assignments — all pre-cached for zero API calls at runtime.

Purpose: Congressional delegation is the core addressee for every advocacy packet. Knowing which senators, representatives, and committee members serve each Tribe determines who receives the packet and what committee-specific framing to use. The many-to-many model must handle multi-state Tribes (Navajo = 4 districts, 3 states) and Alaska at-large correctly from day one.
Output: `scripts/build_congress_cache.py` (run once), `data/congressional_cache.json` (cached delegation), `data/aiannh_tribe_crosswalk.json` (Census-to-EPA mapping), `src/packets/congress.py` (runtime module).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-foundation/05-RESEARCH.md
@.planning/phases/05-foundation/05-CONTEXT.md
@src/scrapers/congress_gov.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build_congress_cache.py (Census + Congress.gov + YAML -> cache)</name>
  <files>
    scripts/build_congress_cache.py
    data/congressional_cache.json
    data/aiannh_tribe_crosswalk.json
    data/census/tab20_cd11920_aiannh20_natl.txt
  </files>
  <action>
Create `scripts/build_congress_cache.py` — a multi-step build script that assembles the congressional cache from three sources.

**Step 0: Download Census CD119-AIANNH file**
- URL: `https://www2.census.gov/geo/docs/maps-data/data/rel2020/cd-sld/tab20_cd11920_aiannh20_natl.txt`
- Save to `data/census/tab20_cd11920_aiannh20_natl.txt` (create `data/census/` dir)
- Only download if file does not already exist (skip if cached)
- This is a pipe-delimited file (~178KB) with 17 columns

**Step 1: Parse Census CD119-AIANNH relationship file**

```python
FEDERAL_CLASSFP = {"D1", "D2", "D3", "D5", "D8", "D6", "E1"}
```

Parse with `csv.DictReader(f, delimiter="|")`. For each row:
- Filter: only rows where `CLASSFP_AIANNH_20` is in FEDERAL_CLASSFP (federal reservations/trust lands)
- Extract `GEOID_CD119_20` -> split into state FIPS (first 2 chars) and district number (remaining)
- Map state FIPS to abbreviation using FIPS_TO_STATE dict (from research)
- District "00" means at-large -> label as "{state}-AL" (e.g., "AK-AL")
- Otherwise label as "{state}-{district_num}" zero-padded to 2 digits

Build: `aiannh_districts: dict[str, list[dict]]` keyed by AIANNH GEOID:
```python
{
    "aiannh_geoid": [
        {
            "district": "AZ-01",
            "state": "AZ",
            "aiannh_name": "Navajo Nation Reservation and Off-Reservation Trust Land",
            "classfp": "D1",
            "overlap_pct": 85.3,  # AREALAND_PART / AREALAND_AIANNH_20 * 100
        },
        ...
    ]
}
```

**Step 2: Build AIANNH-to-Tribe crosswalk**

This is the hardest integration challenge. Census AIANNH names differ from EPA/BIA names.

Three-tier linkage approach:
1. **Load existing crosswalk** from `data/aiannh_tribe_crosswalk.json` if it exists (curated entries)
2. **Automated matching**: Normalize both Census and EPA names (strip suffixes like "Reservation", "Rancheria", "Pueblo", "Community", "Trust Land", etc.), then attempt exact match
3. **Log unmatched**: Log any AIANNH entities that could not be matched to an EPA Tribe

The crosswalk file format:
```json
{
    "metadata": {
        "description": "Census AIANNH GEOID to EPA tribe_id mapping",
        "auto_matched": 350,
        "manual_entries": 50,
        "unmatched": 20
    },
    "mappings": {
        "0010": "epa_100000171",
        ...
    },
    "manual_overrides": {
        "0010": {"tribe_id": "epa_100000171", "note": "Navajo Nation Reservation -> Navajo Nation"}
    }
}
```

**To build the automated crosswalk**, the script needs `data/tribal_registry.json` from Plan 05-02. If it does not exist yet, log a warning and create a skeletal crosswalk from Census data alone (to be enriched when registry is available).

If tribal_registry.json IS available:
- Build a normalized name -> tribe_id lookup from EPA data
- For each AIANNH entity, normalize the name and attempt lookup
- Use rapidfuzz token_sort_ratio >= 80 for fuzzy matching on unmatched entries
- Write the crosswalk to `data/aiannh_tribe_crosswalk.json`

**Step 3: Fetch 119th Congress members from Congress.gov API**

```python
async def fetch_119th_members(session, api_key):
    all_members = []
    headers = {"X-Api-Key": api_key}
    offset = 0
    while True:
        url = f"https://api.congress.gov/v3/member/congress/119?limit=250&offset={offset}&currentMember=true"
        async with session.get(url, headers=headers) as resp:
            resp.raise_for_status()
            data = await resp.json()
            members = data.get("members", [])
            if not members:
                break
            all_members.extend(members)
            offset += 250
            await asyncio.sleep(0.3)  # Rate limiting (existing pattern)
    return all_members
```

For each member, extract:
```python
{
    "bioguide_id": member["bioguideId"],
    "name": member.get("name", ""),
    "first_name": member.get("firstName", ""),
    "last_name": member.get("lastName", ""),
    "state": member.get("state", ""),
    "district": member.get("district"),  # None for senators
    "party": member.get("partyName", ""),
    "chamber": "Senate" if member.get("terms", {}).get("item", [{}])[-1].get("chamber") == "Senate" else "House",
    "formatted_name": format_member_name(member),  # e.g., "Sen. Jane Doe (R-AZ)"
    "url": member.get("url", ""),
    "depiction_url": member.get("depiction", {}).get("imageUrl", ""),
    "office_address": "",  # Populated from detail endpoint if needed
    "phone": "",
}
```

Build `formatted_name` per CONTEXT.md format: `"Sen. Jane Doe (R-AZ)"` or `"Rep. John Smith (D-AZ-01)"`.

Party abbreviation: "Republican" -> "R", "Democrat" -> "D", "Independent" -> "I".

**Step 4: Load committee assignments from unitedstates/congress-legislators**

Download (or use cached) `committee-membership-current.yaml` from:
`https://raw.githubusercontent.com/unitedstates/congress-legislators/main/committee-membership-current.yaml`

Also download `committees-current.yaml` for committee names/metadata:
`https://raw.githubusercontent.com/unitedstates/congress-legislators/main/committees-current.yaml`

Parse with `yaml.safe_load()`. The structure is:
```yaml
SLIA:  # Senate Committee on Indian Affairs
  - name: Lisa Murkowski
    party: majority
    rank: 1
    bioguide: M001153
    ...
```

Target committees (from CONTEXT.md):
- SLIA: Senate Indian Affairs
- SSAP: Senate Appropriations
- SSEG: Senate Energy and Natural Resources
- SSCM: Senate Commerce (for NOAA)
- HSII: House Natural Resources
- HSAP: House Appropriations

Also include subcommittees of these (keys like "SLIA01", "HSII10", etc.).

Cross-reference members by `bioguide` (YAML) to `bioguide_id` (Congress.gov API). Build committee assignments per member:
```python
{
    "bioguide_id": {
        "committees": [
            {
                "committee_id": "SLIA",
                "committee_name": "Senate Indian Affairs",
                "role": "chair",  # or "ranking_member", "member"
                "subcommittees": ["SLIA01"]
            }
        ]
    }
}
```

**Step 5: Assemble per-Tribe delegation**

For each Tribe (via AIANNH crosswalk -> tribe_id -> districts):
1. Collect all districts from AIANNH mapping
2. For each district, find the House representative
3. Collect all unique states from districts
4. For each state, find both senators (deduplicated per state, per CONTEXT.md)
5. Merge committee assignments onto each member

Per-Tribe delegation record:
```json
{
    "tribe_id": "epa_100000171",
    "districts": [
        {"district": "AZ-01", "state": "AZ", "overlap_pct": 85.3, "aiannh_name": "..."},
        {"district": "AZ-02", "state": "AZ", "overlap_pct": 10.2},
        {"district": "NM-03", "state": "NM", "overlap_pct": 95.0},
        {"district": "UT-03", "state": "UT", "overlap_pct": 4.5}
    ],
    "senators": [
        {"bioguide_id": "S001", "formatted_name": "Sen. X (R-AZ)", "state": "AZ", "committees": [...]},
        {"bioguide_id": "S002", "formatted_name": "Sen. Y (D-AZ)", "state": "AZ", "committees": [...]},
        {"bioguide_id": "S003", "formatted_name": "Sen. Z (R-NM)", "state": "NM", "committees": [...]},
        ...
    ],
    "representatives": [
        {"bioguide_id": "R001", "formatted_name": "Rep. A (R-AZ-01)", "district": "AZ-01", "committees": [...]},
        ...
    ]
}
```

**Step 6: Write congressional_cache.json (atomic write)**

```json
{
    "metadata": {
        "congress_session": "119",
        "built_at": "2026-02-10T...",
        "total_tribes_mapped": 350,
        "total_members": 541,
        "census_source": "tab20_cd11920_aiannh20_natl.txt",
        "committee_source": "unitedstates/congress-legislators"
    },
    "members": { "bioguide_id": {...member_data...}, ... },
    "committees": { "SLIA": {...committee_data...}, ... },
    "delegations": { "tribe_id": {...delegation_record...}, ... }
}
```

**Script entry point:**
```python
if __name__ == "__main__":
    # argparse: --output, --registry-path, --verbose, --skip-api (for testing without API key)
    asyncio.run(main())
```

**IMPORTANT:** The `--skip-api` flag should allow building a partial cache from Census data only (without Congress.gov API calls or YAML downloads). This enables testing the Census parsing + crosswalk independently.

**Error handling:**
- If CONGRESS_API_KEY not set, log error and exit (or use --skip-api for Census-only mode)
- If Census file download fails, log error and exit
- If YAML download fails, log warning and proceed without committee data
- If tribal_registry.json not found, log warning and build crosswalk in degraded mode (AIANNH names only, no EPA linkage)

**After creating the script, run it with `--skip-api` to test Census parsing** (unless CONGRESS_API_KEY is available, in which case run the full build).

If the full build cannot run (no API key, network issues), create a **placeholder `data/congressional_cache.json`** with the correct schema, census-derived district data for at least 5 Tribes (Navajo, Cherokee, Tlingit & Haida, Seminole, Choctaw), and `"placeholder": true` in metadata. Populate member data for those 5 Tribes' delegations manually (look up current senators/reps for AZ, OK, AK, FL, OK).
  </action>
  <verify>
    - `scripts/build_congress_cache.py` exists
    - `data/census/tab20_cd11920_aiannh20_natl.txt` exists (downloaded or cached)
    - `data/aiannh_tribe_crosswalk.json` exists with valid schema
    - `data/congressional_cache.json` exists with valid schema
    - At least one Tribe (Navajo) has multiple districts across multiple states in the delegations
    - Alaska Tribes have district "AK-AL"
    - No duplicate senators per state within a Tribe's delegation
  </verify>
  <done>
    Census CD119-AIANNH file parsed, AIANNH-to-Tribe crosswalk built, congressional members fetched (or placeholder created), committee assignments loaded, per-Tribe delegations assembled in congressional_cache.json. Many-to-many district model working. Alaska at-large handled correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CongressionalMapper runtime module</name>
  <files>
    src/packets/congress.py
  </files>
  <action>
Create `src/packets/congress.py` — the runtime module that loads `congressional_cache.json` and provides delegation lookups.

Class `CongressionalMapper`:

1. **`__init__(self, config: dict)`**
   - Read `data_path` from `config.get("packets", {}).get("congressional_cache", {}).get("data_path", "data/congressional_cache.json")`
   - Initialize `self._cache: dict = {}`, `self._loaded = False`
   - Use `logging.getLogger("tcr_scanner.packets.congress")`

2. **`_load(self) -> None`** (lazy loading)
   - If already loaded, return
   - Open `self.data_path` with `encoding="utf-8"`, parse JSON
   - Store in `self._cache`
   - Log `"Loaded congressional cache: %d members, %d delegations"` with counts
   - Set `self._loaded = True`

3. **`get_delegation(self, tribe_id: str) -> dict | None`**
   - Returns the per-Tribe delegation record (districts, senators, representatives)
   - Returns `None` if tribe_id not found in delegations

4. **`get_districts(self, tribe_id: str) -> list[dict]`**
   - Returns list of district dicts for the Tribe
   - Empty list if not found

5. **`get_senators(self, tribe_id: str) -> list[dict]`**
   - Returns deduplicated senators for all states the Tribe spans
   - Per CONTEXT.md: "senators once per state, not repeated per district"

6. **`get_representatives(self, tribe_id: str) -> list[dict]`**
   - Returns House representatives for all districts the Tribe maps to

7. **`get_committee_members(self, committee_id: str) -> list[dict]`**
   - Returns all members of a given committee (from the committees section of cache)

8. **`get_relevant_committees(self, tribe_id: str) -> list[dict]`**
   - Returns committees relevant to this Tribe's delegation
   - Filters to target committees (SLIA, SSAP, HSII, HSAP, etc.) where at least one of the Tribe's members serves

9. **`get_member(self, bioguide_id: str) -> dict | None`**
   - Returns member details by bioguide_id

10. **`get_congress_session(self) -> str`**
    - Returns the congress_session from metadata (e.g., "119")

**Implementation notes:**
- All methods synchronous (cache is pre-built)
- Lazy loading pattern matching TribalRegistry
- `encoding="utf-8"` on all file operations
- No API calls at runtime — everything from cache
- Use `logging` for all messages (not print)
  </action>
  <verify>
    - `python -c "from src.packets.congress import CongressionalMapper; cm = CongressionalMapper({}); print(type(cm))"` succeeds
    - If congressional_cache.json has real or placeholder data:
      - Navajo delegation has 4+ districts across 3 states (AZ, NM, UT)
      - Alaska Tribe has district "AK-AL"
      - Senators are not duplicated within a state for multi-district Tribes
    - `python -c "from src.packets.congress import CongressionalMapper; cm = CongressionalMapper({}); print(cm.get_congress_session())"` returns "119"
  </verify>
  <done>
    CongressionalMapper lazily loads congressional_cache.json and provides delegation lookups (districts, senators, representatives, committees) for any Tribe by tribe_id. Many-to-many model works. Senator deduplication per state. No API calls at runtime.
  </done>
</task>

</tasks>

<verification>
1. `scripts/build_congress_cache.py` exists and runs (at least in --skip-api mode)
2. `data/congressional_cache.json` has valid schema with delegations
3. `from src.packets.congress import CongressionalMapper` works
4. Navajo Nation delegation has districts in AZ, NM, UT (3 states)
5. Alaska Native entities map to AK-AL district
6. Senators appear once per state in a Tribe's delegation (not per district)
7. Congressional session tagged as "119"
</verification>

<success_criteria>
- Census CD119-AIANNH file parsed correctly (not CRS R48107 — per research finding)
- Many-to-many Tribe-to-district model working (Navajo = 4+ districts, 3 states)
- Alaska at-large handled (AK-AL for all 229 Alaska Native entities)
- Committee assignments cross-referenced by bioguideId (two-source strategy)
- Pre-cached delegation data enables zero API calls at runtime
- Senator deduplication per state working
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation/05-03-SUMMARY.md`
</output>
