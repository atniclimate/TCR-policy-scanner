---
phase: 10-code-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/main.py
  - src/reports/generator.py
  - src/scrapers/base.py
  - src/scrapers/grants_gov.py
  - src/packets/docx_engine.py
  - src/packets/docx_hotsheet.py
  - src/packets/docx_sections.py
  - src/packets/docx_styles.py
  - src/packets/hazards.py
  - src/packets/orchestrator.py
  - validate_data_integrity.py
  - tests/test_schemas.py
  - tests/test_e2e_phase8.py
  - tests/test_batch_generation.py
  - tests/test_docx_hotsheet.py
  - tests/test_docx_integration.py
  - tests/test_docx_styles.py
  - tests/test_strategic_overview.py
  - tests/test_change_tracking.py
  - tests/test_decision_engine.py
  - tests/test_doc_assembly.py
  - tests/test_packets.py
  - tests/test_web_index.py
  - scripts/build_congress_cache.py
autonomous: true

must_haves:
  truths:
    - "ruff check . exits with zero violations"
    - "No unused imports remain in any source file"
    - "No unused local variables remain in any source file"
    - "All 383+ existing tests still pass after cleanup"
    - "Scripts still run correctly with sys.path pattern preserved"
  artifacts:
    - path: "pyproject.toml"
      provides: "Ruff linter configuration with per-file-ignores for scripts"
      contains: "tool.ruff"
  key_links:
    - from: "src/scrapers/grants_gov.py"
      to: "src/paths.py"
      via: "CFDA_TRACKER_PATH import (redirected from base.py)"
      pattern: "from src.paths import.*CFDA_TRACKER_PATH"
    - from: "pyproject.toml"
      to: "scripts/*.py"
      via: "per-file-ignores suppressing E402"
      pattern: "scripts.*E402"
---

<objective>
Achieve a ruff-clean codebase by creating linter configuration, auto-fixing 54 violations, manually fixing 16 violations, and redirecting the CFDA_TRACKER_PATH import chain.

Purpose: QUAL-02 requires dead code and unused imports removed codebase-wide with `ruff check` passing clean. Research found 70 violations across 27 files. This plan systematically resolves all of them.
Output: Zero ruff violations. pyproject.toml with ruff config. All tests passing.
</objective>

<execution_context>
@D:\Claude-Workspace\.claude/get-shit-done/workflows/execute-plan.md
@D:\Claude-Workspace\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-code-quality/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pyproject.toml and auto-fix 54 violations</name>
  <files>
    pyproject.toml
    (all 27 files with violations -- touched by ruff --fix)
  </files>
  <action>
**Step 1: Create pyproject.toml** at project root (F:\tcr-policy-scanner\pyproject.toml) with this exact content:

```toml
[tool.ruff]
target-version = "py312"
line-length = 120

[tool.ruff.lint]
select = ["E4", "E7", "E9", "F"]

[tool.ruff.lint.per-file-ignores]
# Scripts use sys.path.insert() pattern (DEC-0902-01) requiring imports after path manipulation
"scripts/*.py" = ["E402"]
```

**Step 2: Run ruff auto-fix** from project root:
```bash
ruff check --fix .
```

This auto-fixes 54 violations:
- 35 F401 (unused imports) -- ruff removes them cleanly
- 19 F541 (f-strings without placeholders) -- ruff converts f"..." to "..."

**Step 3: Verify auto-fix results:**
```bash
ruff check .
```

Expected: Only ~16 remaining violations (7 F841, 1 E741, and 8 E402 which are now suppressed by per-file-ignores, so actually ~8 remaining: 7 F841 + 1 E741).

**Step 4: Run tests to catch any auto-fix breakage:**
```bash
python -m pytest tests/ -q
```

All 383+ tests must pass. If any fail with ImportError, the auto-fix removed a re-exported import. Fix by restoring the import and adding it to `__all__` or using `# noqa: F401` ONLY for genuine re-exports.

**CRITICAL: CFDA_TRACKER_PATH import chain fix.** The auto-fix will remove `CFDA_TRACKER_PATH` from `src/scrapers/base.py` (it's unused there). But `src/scrapers/grants_gov.py` imports it FROM base.py. Before running auto-fix, or immediately after if tests break:
1. Open `src/scrapers/grants_gov.py`
2. Find: `from src.scrapers.base import BaseScraper, check_zombie_cfda, CFDA_TRACKER_PATH`
3. Change to: `from src.scrapers.base import BaseScraper, check_zombie_cfda`
4. Add new line: `from src.paths import CFDA_TRACKER_PATH`

This redirects grants_gov.py to import CFDA_TRACKER_PATH directly from src.paths (the canonical source) instead of through the base.py re-export.
  </action>
  <verify>
Run: `ruff check . 2>&1 | tail -5` -- should show only F841/E741 violations (8 max)
Run: `python -m pytest tests/ -q` -- 383+ tests pass
  </verify>
  <done>pyproject.toml exists with ruff config. 54 auto-fixable violations resolved. CFDA_TRACKER_PATH import chain cleaned up. Only manual-fix violations remain (F841, E741). Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Manually fix remaining F841 and E741 violations</name>
  <files>
    validate_data_integrity.py
    scripts/build_congress_cache.py
    tests/test_e2e_phase8.py
    tests/test_docx_integration.py
    tests/test_docx_styles.py
    tests/test_strategic_overview.py
    tests/test_packets.py
  </files>
  <action>
Fix the remaining ~8 violations that require manual intervention. For each F841 (unused variable), review whether the RHS has side effects before removing.

**F841 violations (7 total) -- fix each individually:**

1. **validate_data_integrity.py** (1 F841): Find the unused variable assignment. If the RHS is a function call with side effects, prefix with `_` (e.g., `_result = ...`). If the RHS is pure computation, remove the entire line.

2. **scripts/build_congress_cache.py** (1 F841): Same approach -- review the assignment, determine if side effects exist. Prefix with `_` or remove as appropriate.

3. **tests/test_e2e_phase8.py** (1 F841): Likely a test variable assigned but never asserted on. Either add an assertion using it or prefix with `_`.

4. **tests/test_docx_integration.py** (1 F841): Review the unused variable. In test files, unused assignments often capture return values for later assertions that were never written. Prefix with `_`.

5. **tests/test_docx_styles.py** (1 F841): Research noted this is likely `engine = DocxEngine(config, programs)` where the constructor has the side effect of creating the output directory. Fix: `_engine = DocxEngine(config, programs)` or just `DocxEngine(config, programs)`.

6. **tests/test_strategic_overview.py** (1 F841): Same pattern. Prefix with `_` or remove assignment.

7. **tests/test_packets.py** (1 F841): Same pattern. Prefix with `_` or remove assignment.

**E741 violation (1 total):**

8. **tests/test_docx_integration.py** (1 E741): Research identified this as `l` used as a variable name (ambiguous -- looks like `1`). Replace `l` with `line` throughout the list comprehension:
   - Before: `[l for l in output.split("\n") if "::" in l and "test_" in l]`
   - After: `[line for line in output.split("\n") if "::" in line and "test_" in line]`

**For EACH fix:** Read the file first, understand the context, then make the minimal change. Do NOT restructure surrounding code. Do NOT add comments unless the fix is non-obvious.

**After all 8 fixes:**
```bash
ruff check .
```
Expected output: zero violations (clean exit).
  </action>
  <verify>
Run: `ruff check .` -- exits with code 0 and zero violations reported
Run: `python -m pytest tests/ -q` -- 383+ tests still pass
Run: `ruff check . --statistics` -- confirms 0 violations across all rules
  </verify>
  <done>All 70 ruff violations resolved (54 auto-fixed, 8 manually fixed, 8 E402 suppressed via per-file-ignores). `ruff check .` exits clean. All 383+ tests pass. QUAL-02 requirement is satisfied.</done>
</task>

</tasks>

<verification>
1. `ruff check .` -- zero violations, clean exit (exit code 0)
2. `python -m pytest tests/ -q` -- 383+ tests pass, zero failures
3. `ruff check . --statistics` -- confirms zero violations per rule
4. `python -c "import pyproject_parser; ..."` is NOT needed -- just verify `ruff check .` works (ruff reads pyproject.toml automatically)
5. Spot-check: `ruff check src/scrapers/grants_gov.py` -- specifically verify CFDA_TRACKER_PATH import chain is clean
6. Spot-check: `ruff check scripts/` -- verify E402 violations are suppressed (zero output)
</verification>

<success_criteria>
- pyproject.toml exists with ruff configuration (target-version py312, per-file-ignores for scripts/)
- `ruff check .` exits with zero violations
- No unused imports in any source file under src/, tests/, scripts/, or project root
- No unused local variables remain
- CFDA_TRACKER_PATH import chain redirected (grants_gov.py -> src.paths directly)
- All 383+ existing tests still pass
- QUAL-02 requirement is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/10-code-quality/10-02-SUMMARY.md`
</output>
