---
phase: 18-production-hardening
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - docs/web/css/style.css
  - docs/web/js/app.js
  - docs/web/js/combobox.js
  - docs/web/index.html
  - docs/web/404.html
  - src/packets/orchestrator.py
  - src/packets/docx_engine.py
  - src/main.py
  - src/scrapers/federal_register.py
  - src/scrapers/grants_gov.py
  - src/scrapers/congress_gov.py
  - src/scrapers/usaspending.py
  - .github/workflows/deploy-website.yml
  - .github/workflows/generate-packets.yml
  - .github/workflows/daily-scan.yml
autonomous: true

must_haves:
  truths:
    - "Zero P0 critical findings remain across all 4 agents after fixes -- every P0 finding has a verified code fix"
    - "Zero P1 important findings remain across all 4 agents after fixes -- every P1 finding has a verified code fix or documented workaround"
    - "Low-risk Marie Kondo suggestions are applied (dead code removal, unused imports, simple hygiene) without changing behavior"
    - "All fixes are forward-only -- no reverts, no behavior changes beyond the specific defect resolution"
    - "Full test suite passes after every fix batch with zero regressions"
    - "Re-verification by affected agents confirms fixes resolved targeted defects"
  artifacts:
    - path: "outputs/bug_hunt/cyclops_findings.json"
      provides: "Updated findings with fix verification status"
    - path: "outputs/bug_hunt/dale-gribble_findings.json"
      provides: "Updated findings with fix verification status"
    - path: "outputs/bug_hunt/mr-magoo_findings.json"
      provides: "Updated findings with fix verification status"
    - path: "outputs/bug_hunt/marie-kondo_findings.json"
      provides: "Updated findings with fix verification status"
  key_links:
    - from: "outputs/bug_hunt/*_findings.json"
      to: "source file fixes"
      via: "fix field in each finding"
      pattern: "severity.*(critical|important)"
    - from: "all fixes"
      to: "python -m pytest tests/"
      via: "regression testing after each fix batch"
      pattern: "passed"
---

<objective>
Triage all findings from the 4 adversarial agents, fix all P0 and P1 issues, apply low-risk Marie Kondo hygiene suggestions, and re-verify fixes until the system is clean.

Purpose: Wave 2 of the three-wave Phase 18 structure. This fix wave transforms audit findings into code corrections across the full system (website, pipeline, scrapers, deployment). The fix-verify loop continues until zero P0/P1 remain. Marie Kondo's low-risk suggestions (dead code, unused imports, simple cleanup) are applied during this wave if they touch <= 3 files and cannot introduce regressions.

**HARD-04 coverage note:** The full codebase identification for code hygiene is produced by Marie Kondo's exhaustive INVENTORY in Plan 18-01 Task 2 (every unused import, dead function, unreferenced config key catalogued with file+line). This plan (18-02) applies only a safe low-risk SUBSET of that inventory -- items that touch <= 3 files and are purely subtractive. The distinction is: 18-01 identifies everything, 18-02 acts on the safe portion.

Output:
- Fixed source files across website, pipeline, scrapers, and deployment
- Updated agent findings with verification status
- Clean test suite (964+ tests passing)
</objective>

<execution_context>
@D:\Claude-Workspace\.claude\get-shit-done\workflows\execute-plan.md
@D:\Claude-Workspace\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-production-hardening/18-CONTEXT.md
@.planning/phases/18-production-hardening/18-RESEARCH.md
@.planning/phases/18-production-hardening/18-01-SUMMARY.md

# Wave 1 findings (the input to this plan)
@outputs/bug_hunt/cyclops_findings.json
@outputs/bug_hunt/dale-gribble_findings.json
@outputs/bug_hunt/mr-magoo_findings.json
@outputs/bug_hunt/marie-kondo_findings.json

# Agent definitions (for re-verification checklists)
@.planning/cyclops.md
@.planning/dale-gribble.md
@.planning/mr-magoo.md
@.planning/marie-kondo.md

# Source files that may need fixes
@docs/web/index.html
@docs/web/css/style.css
@docs/web/js/app.js
@docs/web/js/combobox.js
@docs/web/404.html
@src/packets/orchestrator.py
@src/packets/docx_engine.py
@src/main.py
@src/config.py
@src/paths.py
@src/scrapers/federal_register.py
@src/scrapers/grants_gov.py
@src/scrapers/congress_gov.py
@src/scrapers/usaspending.py
@.github/workflows/deploy-website.yml
@.github/workflows/generate-packets.yml
@.github/workflows/daily-scan.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Triage findings and fix all P0/P1 issues across all 4 agents</name>
  <files>
docs/web/css/style.css
docs/web/js/app.js
docs/web/js/combobox.js
docs/web/index.html
docs/web/404.html
src/packets/orchestrator.py
src/packets/docx_engine.py
src/main.py
src/scrapers/federal_register.py
src/scrapers/grants_gov.py
src/scrapers/congress_gov.py
src/scrapers/usaspending.py
.github/workflows/deploy-website.yml
.github/workflows/generate-packets.yml
.github/workflows/daily-scan.yml
  </files>
  <action>
Read all 4 findings JSON files from `outputs/bug_hunt/`. Parse findings arrays and classify:

**Step 1: Build priority matrix**

Create a triage table from all 4 agents' findings:
- P0 (critical): Must fix. Blocks launch.
- P1 (important): Must fix or document workaround.
- P2 (cosmetic): Document. Fix if low-risk.
- P3 (cosmetic): Backlog.

When agents disagree on severity for the same issue, defer to the domain expert:
- Security/sovereignty -> Dale Gribble's severity wins
- Code correctness -> Cyclops's severity wins
- User experience -> Mr. Magoo's severity wins
- Code hygiene -> Marie Kondo's severity wins

**Step 2: Fix P0 issues (if any)**

For each P0 finding:
1. Read the file at the specified path and line
2. Apply the fix from the finding's `fix` field (or an equivalent correct fix)
3. Run `python -m pytest tests/ -v --tb=short` after each P0 fix
4. If a fix introduces a new issue, fix the regression too (fix forward)

P0 findings are typically:
- Data sovereignty violations (tracking, analytics, data leakage)
- Complete feature failures (downloads broken, search non-functional)
- Security vulnerabilities (XSS, path traversal, secret exposure)

**Step 3: Fix P1 issues**

For each P1 finding:
1. Read the file at the specified path and line
2. Apply the fix
3. Run tests after each batch of related P1 fixes
4. If a P1 cannot be fixed without significant refactoring, document a workaround instead

P1 findings are typically:
- WCAG AA contrast failures (should be resolved by Task 1 of 18-01)
- Download flow issues for subset of users
- Silent data loss or missing error handling on critical paths
- Race conditions that cause visible bugs

**Step 4: Apply low-risk Marie Kondo suggestions**

From Marie Kondo's findings, apply hygiene fixes that meet ALL of these criteria:
- Touches <= 3 files
- Is purely subtractive (removing dead code, unused imports) or cosmetic (reformatting)
- Cannot change runtime behavior
- Does not modify public interfaces or function signatures
- Verified as truly unused (not "might be used later")

Examples of safe Marie Kondo fixes:
- Remove unused Python imports (`import os` when os is never used)
- Remove dead functions that nothing calls
- Remove resolved TODO/FIXME comments
- Clean up unused config keys
- Remove unused CSS classes (verified not referenced)

Examples to SKIP:
- Refactoring that changes interfaces (even if "cleaner")
- Removing code that looks unused but might be called dynamically
- Consolidating modules (too many files touched, high risk)
- Removing dependencies from requirements.txt (could break deployment)

Run `python -m pytest tests/ -v --tb=short` after applying Marie Kondo fixes.

**Step 5: Re-verify fixes**

For each P0/P1 finding that was fixed:
1. Re-read the code section to confirm the fix is applied
2. Verify the fix addresses the specific issue described in the finding
3. Check that surrounding code still makes sense
4. Confirm no new issues were introduced

If any P0/P1 finding cannot be fixed or verified, document why and flag for Plan 18-03 synthesis.

**Important rules:**
- Fix forward -- never revert. If a fix breaks something, fix the breakage too.
- All fixes go in the appropriate source files, never in generated output files.
- Run tests after each fix batch. Never accumulate untested changes.
- Use `encoding="utf-8"` for all Python file operations.
- Respect the project's atomic write pattern (tmp + os.replace) where already used.
- Do NOT add new tests in this plan -- test suite expansion would be a separate concern.
  </action>
  <verify>
- Zero P0 findings remain across all 4 agent findings
- Zero P1 findings remain (all fixed or have documented workarounds)
- `python -m pytest tests/ -v --tb=short` passes with zero failures
- Marie Kondo low-risk suggestions applied (unused imports, dead code removed)
- No behavioral changes introduced beyond specific defect fixes
- Each fix addresses the specific issue described in the finding
  </verify>
  <done>All P0 and P1 findings are resolved across all 4 adversarial agents, low-risk Marie Kondo hygiene applied, all tests pass, and fixes have been re-verified against original findings</done>
</task>

<task type="auto">
  <name>Task 2: Re-run affected agent checklists to verify fix completeness</name>
  <files>
outputs/bug_hunt/cyclops_findings.json
outputs/bug_hunt/dale-gribble_findings.json
outputs/bug_hunt/mr-magoo_findings.json
outputs/bug_hunt/marie-kondo_findings.json
  </files>
  <action>
After all fixes from Task 1 are applied, perform a targeted re-verification of the specific checklist items that had P0/P1 findings. Re-verification must use each agent's original inspection methodology, not just static code reading.

**Re-verification strategy:**
- If total P0+P1 findings across all agents < 15: Targeted spot-check using agent methodology per finding.
- If total P0+P1 findings >= 15: Full re-audit of affected files using agent methodology.

**Agent-specific re-verification methods:**

For **Cyclops** P0/P1 findings: Re-trace the affected data path end-to-end (e.g., if the finding was about search race conditions, re-trace user input -> debounce -> fetch -> render to confirm the fix closes the race). Do not just confirm the diff looks correct -- follow the data flow through the fix.

For **Dale Gribble** P0/P1 findings: Re-check the third-party inventory and network request surface. If the finding was about an external dependency, re-read the HTML/JS/YAML to confirm the external reference is removed or secured. For sovereignty findings, re-evaluate the data flow map to confirm no user data leaks through the fixed path.

For **Mr. Magoo** P0/P1 findings: Re-navigate the affected user flow by reading the HTML structure (not source code). If the finding was about download confusion, walk through the HTML from search -> select -> download button to confirm the user experience is improved.

For **Marie Kondo** P0/P1 findings (if any): Re-grep for the specific unused import/dead function to confirm it no longer appears in the codebase. Verify the removal didn't break any import chains by checking that no other file references the removed symbol.

**For each fixed P0/P1 finding:**
1. Identify which agent raised the finding and apply that agent's re-verification method above
2. Re-execute the relevant checklist item using the agent's original inspection approach
3. Confirm the code has changed from the original `code_snippet` to the fixed version
4. Verify the fix addresses the root cause (not just the symptom) as described in the finding
5. Check for new issues in surrounding code introduced by the fix
6. Mark the finding as "verified_fixed" in the agent's JSON

**Update findings JSON files:**
For each agent's findings JSON, add a `fix_status` field to each P0/P1 finding:
```json
{
  "id": "CYCLOPS-001",
  "severity": "critical",
  "fix_status": "verified_fixed",
  "fix_applied": "description of what was changed",
  "fix_verified_at": "ISO-8601 timestamp"
}
```

For P2/P3 findings, add `fix_status: "deferred"` or `fix_status: "applied"` (for Marie Kondo items).

**If re-verification reveals new P0/P1 issues:**
Fix them immediately (fix forward). Update the findings JSON with the new finding and its fix. Loop until clean -- no P0/P1 remaining.

**Final test run:**
```bash
python -m pytest tests/ -v --tb=short
```
Record total test count for Plan 18-03 synthesis.
  </action>
  <verify>
- Every P0/P1 finding across all 4 agents has `fix_status: "verified_fixed"`
- No new P0/P1 findings discovered during re-verification
- All findings JSONs updated with fix_status fields
- `python -m pytest tests/ -v --tb=short` passes
- Total test count recorded for synthesis report
  </verify>
  <done>All P0/P1 fixes verified clean. No new P0/P1 issues found during re-verification. Agent findings JSONs updated with fix_status. Test suite passes completely.</done>
</task>

</tasks>

<verification>
1. Zero P0 findings remain across all 4 agent findings files
2. Zero P1 findings remain (all verified_fixed or with documented workaround)
3. All 4 findings JSON files updated with fix_status for every finding
4. Low-risk Marie Kondo hygiene applied without behavioral changes
5. All tests pass: `python -m pytest tests/ -v --tb=short`
6. Fix-verify loop completed (no new P0/P1 discovered during re-verification)
7. No reverts -- all fixes are forward-only
</verification>

<success_criteria>
- Zero P0 and zero P1 findings across all agents after the fix-verify cycle
- Test suite passes at 964+ tests
- Code changes are minimal and targeted to specific findings
- Marie Kondo hygiene improvements applied safely
- System ready for Plan 18-03 synthesis and go/no-go decision
</success_criteria>

<output>
After completion, create `.planning/phases/18-production-hardening/18-02-SUMMARY.md`
</output>
