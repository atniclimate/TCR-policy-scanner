---
phase: 18-production-hardening
plan: 04
type: execute
wave: 4
depends_on: [18-03]
gap_closure: true
files_modified:
  - docs/web/js/app.js
  - docs/web/css/style.css
  - docs/web/index.html
  - .github/workflows/deploy-website.yml
  - .github/workflows/generate-packets.yml
  - src/scrapers/cfda_map.py
  - src/scrapers/usaspending.py
  - src/scrapers/grants_gov.py
  - src/config.py
autonomous: true

must_haves:
  truths:
    - "All 12 actionable P2 findings are resolved or have documented acceptance rationale"
    - "All 7 actionable P3 findings are resolved"
    - "Website has a Content-Security-Policy meta tag restricting script/style sources"
    - "Privacy/sovereignty footer statement is visible on the website"
    - "GitHub Actions are pinned to commit SHAs not version tags"
    - "Hash-based shareable URLs work for Tribe deep-linking"
    - "Document type descriptions appear under download buttons"
    - "Loading state has a visible spinner or prominent indicator"
    - "Error messages include actionable recovery steps"
    - "CFDA mapping consolidated into shared module with zero behavior change"
    - "All 964+ tests pass after changes"
  artifacts:
    - path: "docs/web/js/app.js"
      provides: "UX improvements: loading, search, download, errors, shareable URLs"
    - path: "docs/web/index.html"
      provides: "CSP meta tag, privacy footer, noscript enhancement"
    - path: "src/scrapers/cfda_map.py"
      provides: "Shared CFDA-to-program mapping module"
---

<objective>
Fix all actionable P2/P3 findings from the Phase 18 adversarial audit. This is the remediation wave addressing 19 findings across website UX, security/trust, and Python code hygiene.

Purpose: Raise launch quality beyond minimum gate criteria. The user elected to fix P2/P3 items rather than ship with them deferred.

Deferred (not fixed -- accepted risk or low value):
- DALE-003 (P2): GitHub Pages access logs -- platform inherent, can't fix
- CYCLOPS-002 (P3): Non-ASCII filename stripping -- no current impact (all 592 names are ASCII)
- CYCLOPS-003 (P3): No debounce on search -- imperceptible with 592 items
- CYCLOPS-007 (P3): Freshness badge clock offset -- extreme edge case
- CYCLOPS-009 (P3): Fuse.js not diacritic-insensitive -- no current impact (all ASCII)
- MK-CODE-10 (P3): pyyaml -> json -- trivial savings, config format change risk
- MK-CODE-11 (P3): requests -> urllib -- trivial savings, only 2 simple scripts
</objective>

<execution_context>
@D:\Claude-Workspace\.claude\get-shit-done\workflows\execute-plan.md
@D:\Claude-Workspace\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@outputs/bug_hunt/SYNTHESIS.md
@outputs/bug_hunt/cyclops_findings.json
@outputs/bug_hunt/dale-gribble_findings.json
@outputs/bug_hunt/mr-magoo_findings.json
@outputs/bug_hunt/marie-kondo_findings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Website UX improvements</name>
  <files>docs/web/js/app.js, docs/web/css/style.css</files>
  <action>
Fix 10 UX findings in the website frontend. Read app.js and style.css first to understand current structure.

**MAGOO-001 (P2): Better loading state**
- Replace the small "Loading Tribe data..." text with a visible loading spinner
- Add CSS spinner animation in style.css
- Show spinner centered in the search area while data loads
- Keep the search input disabled but make the loading state obvious

**MAGOO-003 (P2): Document type descriptions**
- Under each download button in the Tribe card, add a brief description:
  - Internal Strategy: "Detailed analysis with talking points for your team"
  - Congressional Overview: "Facts-only briefing for congressional offices"
- Use small muted text below each button (font-size: 0.75rem, color: var(--tcr-muted))

**MAGOO-004 (P2): Hide card on new search**
- When the user starts typing in the search box (input event), hide the current Tribe card
- Use the existing opacity transition with data-visible attribute
- Card reappears when a new Tribe is selected

**MAGOO-006 (P2): Actionable error message**
- Change error message from "Failed to load Tribe data. Please try again later." to:
  "Failed to load Tribe data. Please refresh the page or try again in a few minutes."
- Add a "Refresh Page" link/button that calls `location.reload()`
- Same for timeout error: "Loading timed out. Refresh the page to try again."

**MAGOO-009 (P2): Hash-based shareable URLs**
- When a Tribe is selected, update URL hash: `#tribe=Navajo+Nation` (encodeURIComponent)
- On page load, read location.hash. If #tribe= is present, auto-select that Tribe after data loads
- This allows sharing direct links to specific Tribe cards

**CYCLOPS-004 (P2): Double-click guard on Download Both**
- When "Download Both" is clicked, disable the button for 2 seconds (set disabled attribute)
- Re-enable after the 2-second download sequence completes
- Add visual feedback (e.g., change text to "Downloading...")

**CYCLOPS-006 (P2): Screen reader result count**
- When search results change, announce total matches in an aria-live region
- Format: "Showing 15 of {total} matches" when results are capped at 15
- Format: "Showing {n} matches" when fewer than 15

**CYCLOPS-015 (P2): Script load error differentiation**
- If Fuse.js fails to load (window.Fuse is undefined after DOMContentLoaded), show a specific error:
  "Search functionality failed to load. Please refresh the page."
- Differentiate from tribes.json fetch failure

**CYCLOPS-008 (P3): "Documents being prepared" context**
- When a Tribe has no documents yet, show: "Documents are being prepared for {Tribe name}. Check back after the next daily update."
- Include the deployment date from manifest if available

**DALE-012 (P3): Better noscript fallback**
- Improve the noscript message to include a direct link to the GitHub repository or contact information
- Something like: "This tool requires JavaScript. For direct access to documents, visit our download page."
  </action>
  <verify>
- Loading spinner appears prominently during data fetch
- Document descriptions visible under both download buttons
- Card hides when user starts new search
- Error messages include refresh link/button
- Hash updates in URL bar on Tribe selection
- Visiting URL with hash auto-selects correct Tribe
- Download Both button disables during download sequence
- Screen reader announcement on result count change
- Script load failure shows distinct error
- "Documents being prepared" shows context text
- Noscript fallback is improved
  </verify>
  <done>All 10 website UX findings resolved with functional improvements</done>
</task>

<task type="auto">
  <name>Task 2: Security and trust hardening</name>
  <files>docs/web/index.html, .github/workflows/deploy-website.yml, .github/workflows/generate-packets.yml</files>
  <action>
Fix 4 security/trust findings. Read each file before modifying.

**DALE-004 (P2): Content-Security-Policy meta tag**
- Add CSP meta tag to index.html `<head>`:
  ```html
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self'; font-src 'self'; connect-src 'self'; frame-ancestors 'self' *.squarespace.com">
  ```
- `'unsafe-inline'` needed for style.css @media queries and inline styles
- `frame-ancestors` allows SquareSpace embedding
- Verify the page still works after adding CSP (no console errors)

**DALE-011 + MAGOO-007 (P2): Privacy/sovereignty footer statement**
- Add a one-line data sovereignty note in the footer of index.html:
  "No tracking. No cookies. Your searches stay on your device."
- Style with small muted text, consistent with existing footer credit
- This addresses both Dale Gribble's CARE Responsibility finding and Mr. Magoo's trust indicator request

**DALE-015 (P2): Pin GitHub Actions to commit SHAs**
- In both workflow files, replace version tags with commit SHAs:
  - `actions/checkout@v4` -> `actions/checkout@<sha>` (look up current v4 SHA)
  - `actions/setup-python@v5` -> `actions/setup-python@<sha>`
  - `actions/upload-artifact@v4` -> `actions/upload-artifact@<sha>`
  - `actions/download-artifact@v4` -> `actions/download-artifact@<sha>`
  - `peaceiris/actions-gh-pages@v3` -> `peaceiris/actions-gh-pages@<sha>`
- Add a comment with the version next to each SHA for readability:
  `actions/checkout@abc123 # v4.1.0`
- Look up the SHAs using `gh api repos/{owner}/{repo}/git/refs/tags/{tag}` or use known stable SHAs

**DALE-005 (P3): Clean up embed comment**
- In index.html, find the embed comment that reveals deployment pattern
- Either remove it entirely or replace with a generic non-revealing comment
  </action>
  <verify>
- CSP meta tag present in index.html
- Page loads without CSP violations in console
- Privacy statement visible in footer
- All GitHub Actions in both workflows pinned to commit SHAs with version comments
- Embed comment cleaned up
  </verify>
  <done>Security and trust hardening complete: CSP, privacy statement, pinned Actions, embed comment</done>
</task>

<task type="auto">
  <name>Task 3: Python code hygiene</name>
  <files>src/scrapers/cfda_map.py, src/scrapers/usaspending.py, src/scrapers/grants_gov.py, src/config.py</files>
  <action>
Fix 4 code hygiene findings from Marie Kondo. Read each file before modifying. Run tests after each change.

**MK-CODE-05 (P3): CFDA mapping consolidation**
- Read `src/scrapers/grants_gov.py` and find the CFDA_NUMBERS dict
- Read `src/scrapers/usaspending.py` and find the CFDA_TO_PROGRAM dict
- Create `src/scrapers/cfda_map.py` with the canonical merged mapping
- Use the most complete version (likely CFDA_TO_PROGRAM from usaspending.py which has 14 entries)
- Update both files to import from cfda_map.py
- Ensure the mapping values are compatible (grants_gov uses program names, usaspending uses program identifiers -- keep both if needed)
- Run tests to verify zero behavior change

**MK-CODE-06 (P3): Derive TRIBAL_AWARD_TYPE_CODES**
- In `src/scrapers/usaspending.py`, find TRIBAL_AWARD_TYPE_CODES (flat list) and TRIBAL_AWARD_TYPE_CODE_GROUPS (nested list)
- Replace the flat list with a derivation: `TRIBAL_AWARD_TYPE_CODES = [code for group in TRIBAL_AWARD_TYPE_CODE_GROUPS for code in group]`
- Verify the derived list produces the same values
- Check if any code depends on the ordering of the flat list

**MK-CODE-09 (P3): Remove config.py PROJECT_ROOT re-export**
- Read `src/config.py` and check for PROJECT_ROOT in `__all__` or as a re-export
- grep for `from src.config import PROJECT_ROOT` or `from config import PROJECT_ROOT` across the codebase
- If callers exist, update them to import from `src.paths` instead
- If no callers, remove the re-export
- **IMPORTANT:** If many callers exist (>5), defer this change to avoid excessive churn

**MK-CODE-12 (P3): Manifest generation deduplication**
- Read `.github/workflows/deploy-website.yml` and `.github/workflows/generate-packets.yml`
- Find the duplicated manifest.json generation code (~20 lines)
- Extract to a shared script: `scripts/build_manifest.py`
- Update both workflows to call the script instead of inline code
- Ensure the script produces identical output to the inline code
- Run the script manually to verify it works
  </action>
  <verify>
- `src/scrapers/cfda_map.py` exists with canonical mapping
- Both scrapers import from cfda_map.py
- TRIBAL_AWARD_TYPE_CODES is derived, not manually listed
- config.py PROJECT_ROOT re-export removed (or deferred with note)
- Manifest generation script exists and produces valid JSON
- Both workflows reference the shared script
- All 964+ tests pass
  </verify>
  <done>Python code hygiene complete: CFDA consolidation, derived list, removed re-export, manifest dedup</done>
</task>

<task type="auto">
  <name>Task 4: Full test suite verification</name>
  <files>none (read-only verification)</files>
  <action>
Run the full test suite to verify zero regressions from all changes:

```bash
cd F:/tcr-policy-scanner && python -m pytest tests/ -v --tb=short 2>&1 | tail -20
```

Also verify the website loads correctly by checking file integrity:
- Verify index.html has CSP meta tag and privacy footer
- Verify app.js has all UX improvements
- Verify style.css has spinner and new styles
- Verify workflow files have pinned SHAs

If any tests fail, fix the regression before committing.
  </action>
  <verify>
- Full test suite passes (964+ tests, 0 failures)
- No new lint violations (ruff check)
- All modified files committed
  </verify>
  <done>All tests pass, all changes verified, ready for re-audit</done>
</task>

</tasks>

<verification>
1. All 12 actionable P2 findings resolved (DALE-003 accepted as platform-inherent)
2. All 7 actionable P3 findings resolved
3. 6 P3 findings explicitly deferred with rationale (low value / no current impact)
4. Full test suite passes with zero regressions
5. Website loads and functions correctly with all UX improvements
6. CSP meta tag does not break any functionality
7. GitHub Actions pinned to commit SHAs
</verification>

<success_criteria>
- Zero actionable P2/P3 findings remain (only platform-inherent and low-value deferrals)
- Website UX significantly improved (loading, errors, descriptions, shareable URLs)
- Security posture improved (CSP, pinned Actions)
- Trust indicators added (privacy statement)
- Code hygiene improved (consolidated CFDA, derived list, deduped manifest)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-production-hardening/18-04-SUMMARY.md`
</output>
