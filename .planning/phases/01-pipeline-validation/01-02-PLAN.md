---
phase: 01-pipeline-validation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/daily-scan.yml
autonomous: false

must_haves:
  truths:
    - "GitHub Actions daily-scan.yml workflow completes successfully on manual trigger"
    - "Workflow installs Python 3.12 and project dependencies without errors"
    - "Pipeline runs in CI and produces output files"
    - "Workflow commits scan outputs to the repository"
    - "Schedule cron is correctly configured for weekday 6 AM Pacific (13:00 UTC Mon-Fri)"
  artifacts:
    - path: ".github/workflows/daily-scan.yml"
      provides: "GitHub Actions workflow for automated daily scanning"
      contains: "cron: '0 13 * * 1-5'"
  key_links:
    - from: ".github/workflows/daily-scan.yml"
      to: "python -m src.main --verbose"
      via: "Run policy scan step"
      pattern: "python -m src.main"
    - from: ".github/workflows/daily-scan.yml"
      to: "outputs/"
      via: "git add outputs/ in commit step"
      pattern: "git add outputs"
    - from: ".github/workflows/daily-scan.yml"
      to: "CONGRESS_API_KEY secret"
      via: "env var from GitHub secrets"
      pattern: "secrets.CONGRESS_API_KEY"
---

<objective>
Validate that the GitHub Actions daily-scan.yml workflow runs successfully in CI, including manual trigger, dependency installation, pipeline execution, and output commit.

Purpose: The pipeline must not only work locally -- it must work in its deployed CI environment (GitHub Actions on Ubuntu) on the configured schedule (weekday 6 AM Pacific). This validates the last mile: secrets configuration, cross-platform compatibility, and automated commit behavior.

Output: Confirmed working CI workflow with a successful manual run visible in the repository's Actions tab.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pipeline-validation/01-RESEARCH.md
@.planning/phases/01-pipeline-validation/01-01-SUMMARY.md

@.github/workflows/daily-scan.yml
@src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify workflow configuration and trigger CI run</name>
  <files>.github/workflows/daily-scan.yml</files>
  <action>
**Step 1: Verify workflow configuration**
Read `.github/workflows/daily-scan.yml` and confirm:
- Schedule cron `0 13 * * 1-5` is correct (13:00 UTC = 6:00 AM Pacific on weekdays Mon-Fri)
- `workflow_dispatch` is present (allows manual trigger)
- Python version is `3.12`
- `pip install -r requirements.txt` installs dependencies
- `CONGRESS_API_KEY` is passed from `secrets.CONGRESS_API_KEY`
- `SAM_API_KEY` is passed from `secrets.SAM_API_KEY` (not actively used but present for future use)
- Output commit step uses `git add outputs/` and conditionally commits

**Step 2: Ensure any fixes from Plan 01 are committed and pushed**
Before triggering CI, the Grants.gov endpoint fix (and any Congress.gov changes) from Plan 01 must be committed and pushed to the remote repository. Check with `git status` and `git log` to confirm the fixes are on the remote branch that CI will use.

If fixes are not yet pushed:
```bash
cd F:\tcr-policy-scanner
git add src/scrapers/grants_gov.py src/scrapers/congress_gov.py
git commit -m "fix: update Grants.gov endpoint to /api/search2 with aln parameter"
git push
```

**Step 3: Verify GitHub secrets are configured**
Run `gh secret list` from the repo to check that `CONGRESS_API_KEY` is set. If it is not set, this becomes a checkpoint -- the user must set it in the GitHub repository settings (Settings > Secrets and variables > Actions > New repository secret).

**Step 4: Trigger the workflow manually**
Run:
```bash
gh workflow run daily-scan.yml
```

**Step 5: Monitor the run**
Wait for the run to complete:
```bash
gh run list --workflow=daily-scan.yml --limit=1
```

Watch the run (check every 30 seconds for up to 10 minutes):
```bash
gh run watch
```

If the run fails, download the logs:
```bash
gh run view --log
```

Inspect failure reasons:
- If dependency installation fails: check `requirements.txt` for packages that need system-level deps on Ubuntu
- If pipeline fails: check for Windows-specific path issues or missing env vars
- If git commit fails: check permissions (the workflow has `contents: write`)

**Step 6: If workflow needs fixes**
If the workflow fails due to a fixable issue (e.g., missing dependency, path issue), update `.github/workflows/daily-scan.yml` or the relevant source file, commit, push, and re-trigger. Common fixes:
- Add `--no-cache-dir` to pip install if cache causes issues
- Ensure `outputs/` directory exists before scan (add `mkdir -p outputs` step if needed)
- If Grants.gov/Congress.gov rate-limits in CI, consider adding `--source federal_register` as a fallback test

Do NOT modify the cron schedule or add unnecessary complexity. The goal is to validate the existing workflow works, not to redesign it.
  </action>
  <verify>
- `gh workflow run daily-scan.yml` triggers without error
- `gh run list --workflow=daily-scan.yml --limit=1` shows status "completed" with conclusion "success"
- `gh run view --log` shows no errors in the scan step
  </verify>
  <done>
GitHub Actions daily-scan.yml workflow completes successfully on manual trigger. Pipeline runs in CI environment, produces output files, and commits them to the repository.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Validated the GitHub Actions daily-scan.yml workflow by manually triggering it via `gh workflow run`. The workflow installed Python 3.12, installed dependencies, ran the full pipeline with API keys from GitHub secrets, and committed output files to the repository. The schedule cron (weekday 6 AM Pacific) was verified as correctly configured.
  </what-built>
  <how-to-verify>
1. Visit the repository's Actions tab on GitHub and confirm the most recent "Daily Policy Scan" run shows a green checkmark (success)
2. Check the run logs to confirm all 4 scrapers executed (look for "Scanning federal_register...", "Scanning grants_gov...", etc.)
3. Check the repository's `outputs/` directory on GitHub to confirm `LATEST-BRIEFING.md`, `LATEST-RESULTS.json`, and `LATEST-GRAPH.json` were committed by the workflow
4. Verify the commit message matches the pattern "policy scan: YYYY-MM-DD" from the workflow's commit step
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues with the CI run</resume-signal>
</task>

</tasks>

<verification>
1. `gh run list --workflow=daily-scan.yml --limit=1` shows successful completion
2. Workflow logs show all pipeline stages completing (Ingest, Normalize, Graph, Analysis, Report)
3. Output files are committed to repository by the workflow
4. Cron schedule is `0 13 * * 1-5` (weekday 6 AM Pacific)
5. Secrets (CONGRESS_API_KEY) are available to the workflow
</verification>

<success_criteria>
- PIPE-03: GitHub Actions daily-scan.yml runs successfully on schedule (weekday 6 AM Pacific) -- validated via manual trigger, which uses the same code path as scheduled runs
- Workflow installs deps, runs pipeline, commits outputs without errors
- Cross-platform compatibility confirmed (Windows dev -> Linux CI)
</success_criteria>

<output>
After completion, create `.planning/phases/01-pipeline-validation/01-02-SUMMARY.md`
</output>
