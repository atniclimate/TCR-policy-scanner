"""Schema validation tests for vulnerability assessment data structures.

Tests Pydantic v2 models for the v1.4 Climate Vulnerability Intelligence
pipeline. Covers all models in src/schemas/vulnerability.py:

1. DataGapType enum - 6 gap classification values
2. InvestmentPriorityTier enum - 5 tiers with from_score() classifier
3. NRIExpanded - FEMA NRI expanded risk profile with clamping
4. SVITheme - CDC SVI theme profile with -999 sentinel rejection
5. SVIProfile - Multi-theme SVI composite with max-3 validation
6. CompositeComponent - Weighted vulnerability component
7. CompositeScore - 3-component composite with tier consistency
8. VulnerabilityProfile - Top-level per-Tribe vulnerability container

TDD RED phase: All tests written BEFORE implementation.
"""

from __future__ import annotations

from datetime import datetime, timezone

import pytest
from pydantic import ValidationError


# ── DataGapType Tests ──


class TestDataGapType:
    """DataGapType str enum: 6 gap classification values."""

    def test_all_six_values_exist(self):
        """DataGapType has exactly 6 defined values."""
        from src.schemas.vulnerability import DataGapType

        expected = {
            "MISSING_SVI",
            "PARTIAL_NRI",
            "ZERO_AREA_WEIGHT",
            "ALASKA_PARTIAL",
            "NO_COASTAL_DATA",
            "SOURCE_UNAVAILABLE",
        }
        actual = {member.value for member in DataGapType}
        assert actual == expected

    def test_enum_count(self):
        """Exactly 6 values, no more."""
        from src.schemas.vulnerability import DataGapType

        assert len(DataGapType) == 6

    def test_string_value(self):
        """Each member is a string enum."""
        from src.schemas.vulnerability import DataGapType

        assert DataGapType.MISSING_SVI == "MISSING_SVI"
        assert isinstance(DataGapType.MISSING_SVI, str)

    def test_from_string(self):
        """Can construct from string value."""
        from src.schemas.vulnerability import DataGapType

        assert DataGapType("PARTIAL_NRI") == DataGapType.PARTIAL_NRI

    def test_invalid_value_raises(self):
        """Invalid string raises ValueError."""
        from src.schemas.vulnerability import DataGapType

        with pytest.raises(ValueError):
            DataGapType("NOT_A_GAP_TYPE")


# ── InvestmentPriorityTier Tests ──


class TestInvestmentPriorityTier:
    """InvestmentPriorityTier str enum: 5 tiers with from_score() classifier."""

    def test_all_five_tiers_exist(self):
        """InvestmentPriorityTier has exactly 5 defined values."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        expected = {"CRITICAL", "HIGH", "ELEVATED", "MODERATE", "LOW"}
        actual = {member.value for member in InvestmentPriorityTier}
        assert actual == expected

    def test_enum_count(self):
        """Exactly 5 tiers."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert len(InvestmentPriorityTier) == 5

    def test_from_score_critical_boundary(self):
        """Score >= 0.80 -> CRITICAL."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert InvestmentPriorityTier.from_score(0.80) == InvestmentPriorityTier.CRITICAL
        assert InvestmentPriorityTier.from_score(1.0) == InvestmentPriorityTier.CRITICAL
        assert InvestmentPriorityTier.from_score(0.95) == InvestmentPriorityTier.CRITICAL

    def test_from_score_high_boundary(self):
        """Score >= 0.60 and < 0.80 -> HIGH."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert InvestmentPriorityTier.from_score(0.60) == InvestmentPriorityTier.HIGH
        assert InvestmentPriorityTier.from_score(0.79) == InvestmentPriorityTier.HIGH
        assert InvestmentPriorityTier.from_score(0.70) == InvestmentPriorityTier.HIGH

    def test_from_score_elevated_boundary(self):
        """Score >= 0.40 and < 0.60 -> ELEVATED."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert InvestmentPriorityTier.from_score(0.40) == InvestmentPriorityTier.ELEVATED
        assert InvestmentPriorityTier.from_score(0.59) == InvestmentPriorityTier.ELEVATED

    def test_from_score_moderate_boundary(self):
        """Score >= 0.20 and < 0.40 -> MODERATE."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert InvestmentPriorityTier.from_score(0.20) == InvestmentPriorityTier.MODERATE
        assert InvestmentPriorityTier.from_score(0.39) == InvestmentPriorityTier.MODERATE

    def test_from_score_low_boundary(self):
        """Score < 0.20 -> LOW."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert InvestmentPriorityTier.from_score(0.19) == InvestmentPriorityTier.LOW
        assert InvestmentPriorityTier.from_score(0.0) == InvestmentPriorityTier.LOW
        assert InvestmentPriorityTier.from_score(0.10) == InvestmentPriorityTier.LOW

    def test_from_score_exact_boundaries(self):
        """All exact boundary values map correctly (>= comparison)."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        assert InvestmentPriorityTier.from_score(0.80) == InvestmentPriorityTier.CRITICAL
        assert InvestmentPriorityTier.from_score(0.60) == InvestmentPriorityTier.HIGH
        assert InvestmentPriorityTier.from_score(0.40) == InvestmentPriorityTier.ELEVATED
        assert InvestmentPriorityTier.from_score(0.20) == InvestmentPriorityTier.MODERATE

    def test_from_score_string_enum(self):
        """from_score returns a string enum."""
        from src.schemas.vulnerability import InvestmentPriorityTier

        result = InvestmentPriorityTier.from_score(0.85)
        assert isinstance(result, str)
        assert result == "CRITICAL"


# ── NRIExpanded Tests ──


class TestNRIExpanded:
    """NRIExpanded model: expanded FEMA NRI risk profile."""

    def _valid_nri_data(self, **overrides):
        """Build a valid NRIExpanded data dict with optional overrides."""
        data = {
            "tribe_id": "epa_100000001",
            "risk_score": 25.5,
            "risk_percentile": 72.3,
            "eal_total": 100000.0,
            "eal_buildings": 50000.0,
            "eal_population": 30000.0,
            "eal_agriculture": 15000.0,
            "eal_population_equivalence": 5000.0,
            "community_resilience": 45.0,
            "social_vulnerability_nri": 68.0,
            "hazard_count": 8,
            "top_hazards": [
                {"hazard": "WFIR", "score": 18.5},
                {"hazard": "DRGT", "score": 12.3},
            ],
            "coverage_pct": 0.85,
        }
        data.update(overrides)
        return data

    def test_valid_complete_profile(self):
        """Valid complete NRIExpanded data passes validation."""
        from src.schemas.vulnerability import NRIExpanded

        nri = NRIExpanded(**self._valid_nri_data())
        assert nri.tribe_id == "epa_100000001"
        assert nri.risk_score == 25.5
        assert nri.hazard_count == 8
        assert nri.coverage_pct == 0.85

    def test_negative_risk_percentile_clamped_to_zero(self):
        """Negative risk_percentile is clamped to 0.0."""
        from src.schemas.vulnerability import NRIExpanded

        nri = NRIExpanded(**self._valid_nri_data(risk_percentile=-5.0))
        assert nri.risk_percentile == 0.0

    def test_risk_percentile_above_100_clamped(self):
        """risk_percentile > 100 is clamped to 100.0."""
        from src.schemas.vulnerability import NRIExpanded

        nri = NRIExpanded(**self._valid_nri_data(risk_percentile=150.0))
        assert nri.risk_percentile == 100.0

    def test_risk_percentile_at_boundaries(self):
        """risk_percentile at 0.0 and 100.0 stays unchanged."""
        from src.schemas.vulnerability import NRIExpanded

        nri_zero = NRIExpanded(**self._valid_nri_data(risk_percentile=0.0))
        assert nri_zero.risk_percentile == 0.0

        nri_max = NRIExpanded(**self._valid_nri_data(risk_percentile=100.0))
        assert nri_max.risk_percentile == 100.0

    def test_tribe_id_must_start_with_epa(self):
        """tribe_id not starting with 'epa_' raises ValidationError."""
        from src.schemas.vulnerability import NRIExpanded

        with pytest.raises(ValidationError, match="epa_"):
            NRIExpanded(**self._valid_nri_data(tribe_id="bia_100000001"))

    def test_missing_tribe_id_raises(self):
        """Missing tribe_id raises ValidationError."""
        from src.schemas.vulnerability import NRIExpanded

        data = self._valid_nri_data()
        del data["tribe_id"]
        with pytest.raises(ValidationError):
            NRIExpanded(**data)

    def test_negative_risk_score_raises(self):
        """Negative risk_score raises ValidationError."""
        from src.schemas.vulnerability import NRIExpanded

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(risk_score=-1.0))

    def test_negative_eal_raises(self):
        """Negative EAL values raise ValidationError."""
        from src.schemas.vulnerability import NRIExpanded

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(eal_total=-100.0))

    def test_negative_hazard_count_raises(self):
        """Negative hazard_count raises ValidationError."""
        from src.schemas.vulnerability import NRIExpanded

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(hazard_count=-1))

    def test_top_hazards_max_five(self):
        """top_hazards list rejects more than 5 entries."""
        from src.schemas.vulnerability import NRIExpanded

        six_hazards = [{"hazard": f"H{i}", "score": float(i)} for i in range(6)]
        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(top_hazards=six_hazards))

    def test_coverage_pct_range(self):
        """coverage_pct must be 0.0-1.0."""
        from src.schemas.vulnerability import NRIExpanded

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(coverage_pct=1.5))

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(coverage_pct=-0.1))

    def test_community_resilience_range(self):
        """community_resilience must be 0.0-100.0."""
        from src.schemas.vulnerability import NRIExpanded

        # Valid boundary
        nri = NRIExpanded(**self._valid_nri_data(community_resilience=0.0))
        assert nri.community_resilience == 0.0

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(community_resilience=-1.0))

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(community_resilience=101.0))

    def test_social_vulnerability_nri_range(self):
        """social_vulnerability_nri must be 0.0-100.0."""
        from src.schemas.vulnerability import NRIExpanded

        with pytest.raises(ValidationError):
            NRIExpanded(**self._valid_nri_data(social_vulnerability_nri=101.0))


# ── SVITheme Tests ──


class TestSVITheme:
    """SVITheme model: CDC SVI individual theme profile."""

    def _valid_theme_data(self, **overrides):
        """Build valid SVITheme data."""
        data = {
            "theme_id": "theme1",
            "name": "Socioeconomic Status",
            "percentile": 0.75,
            "flag_count": 2,
        }
        data.update(overrides)
        return data

    def test_valid_theme(self):
        """Valid SVITheme passes."""
        from src.schemas.vulnerability import SVITheme

        theme = SVITheme(**self._valid_theme_data())
        assert theme.theme_id == "theme1"
        assert theme.percentile == 0.75

    def test_theme_id_must_be_valid(self):
        """theme_id must be one of theme1, theme2, theme4."""
        from src.schemas.vulnerability import SVITheme

        # theme3 is excluded per DEC-02
        with pytest.raises(ValidationError):
            SVITheme(**self._valid_theme_data(theme_id="theme3"))

        with pytest.raises(ValidationError):
            SVITheme(**self._valid_theme_data(theme_id="invalid"))

    def test_valid_theme_ids(self):
        """theme1, theme2, theme4 are all valid."""
        from src.schemas.vulnerability import SVITheme

        for tid in ("theme1", "theme2", "theme4"):
            theme = SVITheme(**self._valid_theme_data(theme_id=tid))
            assert theme.theme_id == tid

    def test_percentile_negative_999_rejected(self):
        """Percentile of -999 (sentinel) is rejected."""
        from src.schemas.vulnerability import SVITheme

        with pytest.raises(ValidationError, match="-999"):
            SVITheme(**self._valid_theme_data(percentile=-999))

    def test_percentile_range_0_to_1(self):
        """Percentile must be 0.0-1.0."""
        from src.schemas.vulnerability import SVITheme

        with pytest.raises(ValidationError):
            SVITheme(**self._valid_theme_data(percentile=1.5))

        with pytest.raises(ValidationError):
            SVITheme(**self._valid_theme_data(percentile=-0.1))

    def test_percentile_boundaries_valid(self):
        """Percentile at 0.0 and 1.0 are valid."""
        from src.schemas.vulnerability import SVITheme

        t0 = SVITheme(**self._valid_theme_data(percentile=0.0))
        assert t0.percentile == 0.0

        t1 = SVITheme(**self._valid_theme_data(percentile=1.0))
        assert t1.percentile == 1.0

    def test_negative_flag_count_raises(self):
        """Negative flag_count raises ValidationError."""
        from src.schemas.vulnerability import SVITheme

        with pytest.raises(ValidationError):
            SVITheme(**self._valid_theme_data(flag_count=-1))


# ── SVIProfile Tests ──


class TestSVIProfile:
    """SVIProfile model: multi-theme SVI composite."""

    def _valid_svi_data(self, **overrides):
        """Build valid SVIProfile data."""
        themes = [
            {"theme_id": "theme1", "name": "Socioeconomic Status", "percentile": 0.60, "flag_count": 2},
            {"theme_id": "theme2", "name": "Household Characteristics", "percentile": 0.80, "flag_count": 1},
            {"theme_id": "theme4", "name": "Housing Type & Transportation", "percentile": 0.50, "flag_count": 0},
        ]
        data = {
            "tribe_id": "epa_100000001",
            "themes": themes,
            "composite": round((0.60 + 0.80 + 0.50) / 3, 4),  # 0.6333
            "coverage_pct": 0.95,
            "source_year": 2022,
            "data_gaps": [],
        }
        data.update(overrides)
        return data

    def test_valid_svi_profile(self):
        """Valid SVIProfile with 3 themes passes."""
        from src.schemas.vulnerability import SVIProfile

        svi = SVIProfile(**self._valid_svi_data())
        assert svi.tribe_id == "epa_100000001"
        assert len(svi.themes) == 3

    def test_max_three_themes(self):
        """More than 3 themes raises ValidationError."""
        from src.schemas.vulnerability import SVIProfile

        themes = [
            {"theme_id": "theme1", "name": "T1", "percentile": 0.5, "flag_count": 0},
            {"theme_id": "theme2", "name": "T2", "percentile": 0.5, "flag_count": 0},
            {"theme_id": "theme4", "name": "T4", "percentile": 0.5, "flag_count": 0},
            {"theme_id": "theme1", "name": "T1 dup", "percentile": 0.5, "flag_count": 0},
        ]
        with pytest.raises(ValidationError):
            SVIProfile(**self._valid_svi_data(themes=themes, composite=0.5))

    def test_composite_mean_consistency(self):
        """composite must match mean of theme percentiles within 0.01 tolerance."""
        from src.schemas.vulnerability import SVIProfile

        # Wrong composite should fail
        with pytest.raises(ValidationError, match="composite"):
            SVIProfile(**self._valid_svi_data(composite=0.99))

    def test_composite_mean_within_tolerance(self):
        """Composite within 0.01 of actual mean passes."""
        from src.schemas.vulnerability import SVIProfile

        actual_mean = (0.60 + 0.80 + 0.50) / 3  # 0.63333...
        # Slightly off but within tolerance
        svi = SVIProfile(**self._valid_svi_data(composite=round(actual_mean + 0.005, 4)))
        assert svi is not None

    def test_tribe_id_validation(self):
        """tribe_id must start with 'epa_'."""
        from src.schemas.vulnerability import SVIProfile

        with pytest.raises(ValidationError, match="epa_"):
            SVIProfile(**self._valid_svi_data(tribe_id="bia_100000001"))

    def test_source_year_default(self):
        """source_year defaults to 2022."""
        from src.schemas.vulnerability import SVIProfile

        data = self._valid_svi_data()
        del data["source_year"]
        svi = SVIProfile(**data)
        assert svi.source_year == 2022

    def test_empty_themes_allowed(self):
        """Empty themes list is valid (no SVI data)."""
        from src.schemas.vulnerability import SVIProfile

        svi = SVIProfile(**self._valid_svi_data(themes=[], composite=0.0))
        assert len(svi.themes) == 0

    def test_data_gaps_accepts_gap_types(self):
        """data_gaps accepts DataGapType values."""
        from src.schemas.vulnerability import SVIProfile, DataGapType

        svi = SVIProfile(**self._valid_svi_data(
            data_gaps=[DataGapType.MISSING_SVI]
        ))
        assert len(svi.data_gaps) == 1


# ── CompositeComponent Tests ──


class TestCompositeComponent:
    """CompositeComponent model: single weighted vulnerability component."""

    def _valid_component_data(self, **overrides):
        """Build valid CompositeComponent data."""
        data = {
            "component": "hazard_exposure",
            "raw_score": 0.75,
            "base_weight": 0.40,
            "weight": 0.40,
            "weighted_score": 0.30,
            "available": True,
        }
        data.update(overrides)
        return data

    def test_valid_component(self):
        """Valid CompositeComponent passes."""
        from src.schemas.vulnerability import CompositeComponent

        comp = CompositeComponent(**self._valid_component_data())
        assert comp.component == "hazard_exposure"
        assert comp.weighted_score == 0.30

    def test_valid_component_names(self):
        """All three valid component names accepted."""
        from src.schemas.vulnerability import CompositeComponent

        for name in ("hazard_exposure", "social_vulnerability", "adaptive_capacity_deficit"):
            comp = CompositeComponent(**self._valid_component_data(component=name))
            assert comp.component == name

    def test_invalid_component_name_raises(self):
        """Invalid component name raises ValidationError."""
        from src.schemas.vulnerability import CompositeComponent

        with pytest.raises(ValidationError):
            CompositeComponent(**self._valid_component_data(component="not_valid"))

    def test_raw_score_range(self):
        """raw_score must be 0-1."""
        from src.schemas.vulnerability import CompositeComponent

        with pytest.raises(ValidationError):
            CompositeComponent(**self._valid_component_data(raw_score=1.5))

        with pytest.raises(ValidationError):
            CompositeComponent(**self._valid_component_data(raw_score=-0.1))

    def test_available_default_true(self):
        """available defaults to True."""
        from src.schemas.vulnerability import CompositeComponent

        data = self._valid_component_data()
        del data["available"]
        comp = CompositeComponent(**data)
        assert comp.available is True


# ── CompositeScore Tests ──


class TestCompositeScore:
    """CompositeScore model: 3-component composite with tier validation."""

    def _valid_score_data(self, **overrides):
        """Build valid CompositeScore data."""
        data = {
            "score": 0.85,
            "tier": "CRITICAL",
            "data_completeness": 0.95,
            "components": [
                {
                    "component": "hazard_exposure",
                    "raw_score": 0.80,
                    "base_weight": 0.40,
                    "weight": 0.40,
                    "weighted_score": 0.32,
                    "available": True,
                },
                {
                    "component": "social_vulnerability",
                    "raw_score": 0.90,
                    "base_weight": 0.35,
                    "weight": 0.35,
                    "weighted_score": 0.315,
                    "available": True,
                },
                {
                    "component": "adaptive_capacity_deficit",
                    "raw_score": 0.70,
                    "base_weight": 0.25,
                    "weight": 0.25,
                    "weighted_score": 0.175,
                    "available": True,
                },
            ],
        }
        data.update(overrides)
        return data

    def test_valid_composite_score(self):
        """Valid CompositeScore passes."""
        from src.schemas.vulnerability import CompositeScore

        cs = CompositeScore(**self._valid_score_data())
        assert cs.score == 0.85
        assert cs.tier == "CRITICAL"

    def test_tier_must_match_score_critical(self):
        """score=0.85 must have tier=CRITICAL."""
        from src.schemas.vulnerability import CompositeScore

        with pytest.raises(ValidationError, match="tier"):
            CompositeScore(**self._valid_score_data(score=0.85, tier="LOW"))

    def test_tier_must_match_score_high(self):
        """score=0.60 must have tier=HIGH."""
        from src.schemas.vulnerability import CompositeScore

        cs = CompositeScore(**self._valid_score_data(score=0.60, tier="HIGH"))
        assert cs.tier == "HIGH"

        with pytest.raises(ValidationError, match="tier"):
            CompositeScore(**self._valid_score_data(score=0.60, tier="CRITICAL"))

    def test_tier_must_match_score_elevated(self):
        """score=0.40 must have tier=ELEVATED."""
        from src.schemas.vulnerability import CompositeScore

        cs = CompositeScore(**self._valid_score_data(score=0.40, tier="ELEVATED"))
        assert cs.tier == "ELEVATED"

    def test_tier_must_match_score_moderate(self):
        """score=0.20 must have tier=MODERATE."""
        from src.schemas.vulnerability import CompositeScore

        cs = CompositeScore(**self._valid_score_data(score=0.20, tier="MODERATE"))
        assert cs.tier == "MODERATE"

    def test_tier_must_match_score_low(self):
        """score=0.19 must have tier=LOW."""
        from src.schemas.vulnerability import CompositeScore

        cs = CompositeScore(**self._valid_score_data(score=0.19, tier="LOW"))
        assert cs.tier == "LOW"

    def test_score_range(self):
        """score must be 0-1."""
        from src.schemas.vulnerability import CompositeScore

        with pytest.raises(ValidationError):
            CompositeScore(**self._valid_score_data(score=1.5))

        with pytest.raises(ValidationError):
            CompositeScore(**self._valid_score_data(score=-0.1))

    def test_all_tier_score_mappings(self):
        """Verify all 5 tier/score mappings via from_score logic."""
        from src.schemas.vulnerability import CompositeScore

        mappings = [
            (0.85, "CRITICAL"),
            (0.80, "CRITICAL"),
            (0.70, "HIGH"),
            (0.60, "HIGH"),
            (0.50, "ELEVATED"),
            (0.40, "ELEVATED"),
            (0.30, "MODERATE"),
            (0.20, "MODERATE"),
            (0.10, "LOW"),
            (0.0, "LOW"),
        ]
        for score, tier in mappings:
            cs = CompositeScore(**self._valid_score_data(score=score, tier=tier))
            assert cs.tier == tier, f"score={score} expected tier={tier}"


# ── VulnerabilityProfile Tests ──


class TestVulnerabilityProfile:
    """VulnerabilityProfile model: top-level per-Tribe container."""

    def _valid_profile_data(self, **overrides):
        """Build valid VulnerabilityProfile data."""
        data = {
            "tribe_id": "epa_100000001",
            "tribe_name": "Example Tribal Nation",
            "nri": None,
            "svi": None,
            "composite": None,
            "is_coastal": False,
            "data_gaps": [],
            "previous_tier": None,
            "generated_at": datetime.now(timezone.utc).isoformat(),
            "nri_version": "1.20",
            "svi_version": "2022",
        }
        data.update(overrides)
        return data

    def test_valid_minimal_profile(self):
        """Valid minimal VulnerabilityProfile (all optional None) passes."""
        from src.schemas.vulnerability import VulnerabilityProfile

        vp = VulnerabilityProfile(**self._valid_profile_data())
        assert vp.tribe_id == "epa_100000001"
        assert vp.nri is None
        assert vp.svi is None
        assert vp.composite is None

    def test_tribe_id_must_start_with_epa(self):
        """tribe_id must start with 'epa_'."""
        from src.schemas.vulnerability import VulnerabilityProfile

        with pytest.raises(ValidationError, match="epa_"):
            VulnerabilityProfile(**self._valid_profile_data(tribe_id="bia_123"))

    def test_missing_tribe_id_raises(self):
        """Missing tribe_id raises ValidationError."""
        from src.schemas.vulnerability import VulnerabilityProfile

        data = self._valid_profile_data()
        del data["tribe_id"]
        with pytest.raises(ValidationError):
            VulnerabilityProfile(**data)

    def test_is_coastal_default_false(self):
        """is_coastal defaults to False."""
        from src.schemas.vulnerability import VulnerabilityProfile

        data = self._valid_profile_data()
        del data["is_coastal"]
        vp = VulnerabilityProfile(**data)
        assert vp.is_coastal is False

    def test_previous_tier_default_none(self):
        """previous_tier defaults to None."""
        from src.schemas.vulnerability import VulnerabilityProfile

        data = self._valid_profile_data()
        del data["previous_tier"]
        vp = VulnerabilityProfile(**data)
        assert vp.previous_tier is None

    def test_generated_at_required(self):
        """generated_at is required."""
        from src.schemas.vulnerability import VulnerabilityProfile

        data = self._valid_profile_data()
        del data["generated_at"]
        with pytest.raises(ValidationError):
            VulnerabilityProfile(**data)

    def test_with_nri_data(self):
        """VulnerabilityProfile with NRIExpanded data."""
        from src.schemas.vulnerability import VulnerabilityProfile, NRIExpanded

        nri_data = {
            "tribe_id": "epa_100000001",
            "risk_score": 25.5,
            "risk_percentile": 72.3,
            "eal_total": 100000.0,
            "eal_buildings": 50000.0,
            "eal_population": 30000.0,
            "eal_agriculture": 15000.0,
            "eal_population_equivalence": 5000.0,
            "community_resilience": 45.0,
            "social_vulnerability_nri": 68.0,
            "hazard_count": 8,
            "top_hazards": [{"hazard": "WFIR", "score": 18.5}],
            "coverage_pct": 0.85,
        }
        vp = VulnerabilityProfile(**self._valid_profile_data(nri=nri_data))
        assert vp.nri is not None
        assert vp.nri.risk_score == 25.5

    def test_with_composite_data(self):
        """VulnerabilityProfile with CompositeScore data."""
        from src.schemas.vulnerability import VulnerabilityProfile

        composite_data = {
            "score": 0.75,
            "tier": "HIGH",
            "data_completeness": 0.90,
            "components": [
                {
                    "component": "hazard_exposure",
                    "raw_score": 0.80,
                    "base_weight": 0.40,
                    "weight": 0.40,
                    "weighted_score": 0.32,
                    "available": True,
                },
            ],
        }
        vp = VulnerabilityProfile(**self._valid_profile_data(composite=composite_data))
        assert vp.composite is not None
        assert vp.composite.score == 0.75

    def test_data_gaps_list(self):
        """data_gaps accepts DataGapType values."""
        from src.schemas.vulnerability import VulnerabilityProfile, DataGapType

        vp = VulnerabilityProfile(**self._valid_profile_data(
            data_gaps=[DataGapType.ALASKA_PARTIAL, DataGapType.NO_COASTAL_DATA]
        ))
        assert len(vp.data_gaps) == 2

    def test_nri_version_required(self):
        """nri_version is required."""
        from src.schemas.vulnerability import VulnerabilityProfile

        data = self._valid_profile_data()
        del data["nri_version"]
        with pytest.raises(ValidationError):
            VulnerabilityProfile(**data)

    def test_svi_version_required(self):
        """svi_version is required."""
        from src.schemas.vulnerability import VulnerabilityProfile

        data = self._valid_profile_data()
        del data["svi_version"]
        with pytest.raises(ValidationError):
            VulnerabilityProfile(**data)


# ── Import / Re-export Tests ──


class TestImportsAndReexports:
    """Verify all models are importable from expected locations."""

    def test_import_from_vulnerability_module(self):
        """All models importable from src.schemas.vulnerability."""
        from src.schemas.vulnerability import (
            CompositeComponent,
            CompositeScore,
            DataGapType,
            InvestmentPriorityTier,
            NRIExpanded,
            SVIProfile,
            SVITheme,
            VulnerabilityProfile,
        )
        # Just check they're class objects
        assert CompositeComponent is not None
        assert CompositeScore is not None
        assert DataGapType is not None
        assert InvestmentPriorityTier is not None
        assert NRIExpanded is not None
        assert SVIProfile is not None
        assert SVITheme is not None
        assert VulnerabilityProfile is not None

    def test_reexport_from_schemas_init(self):
        """All models re-exported from src.schemas.__init__."""
        from src.schemas import (
            CompositeComponent,
            CompositeScore,
            DataGapType,
            InvestmentPriorityTier,
            NRIExpanded,
            SVIProfile,
            SVITheme,
            VulnerabilityProfile,
        )
        assert CompositeComponent is not None
        assert DataGapType is not None
